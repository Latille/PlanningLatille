<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Planning LATILLE</title>
    
    <!-- Bibliothèque SheetJS pour l'export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Bibliothèque jsPDF pour la génération PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB70gXioCFDN7qBQ21vDGviGSzb7Sg1slQ",
            authDomain: "planning-latille.firebaseapp.com",
            projectId: "planning-latille",
            storageBucket: "planning-latille.firebasestorage.app",
            messagingSenderId: "363904305106",
            appId: "1:363904305106:web:ecb94628d4eaaa25a72a0b"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Exposer Firebase globalement
        window.firebaseApp = app;
        window.firestore = db;
        window.firestoreSDK = { doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot };
        window.firebaseReady = true;

        // Initialiser l'application une fois Firebase prêt
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                window.initializeApp();
            });
        } else {
            window.initializeApp();
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .week-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .week-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .week-nav-btn {
            height: 36px;
            width: 24px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .week-nav-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }

        .week-nav-btn:active {
            background: #e0e0e0;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-employees { background: #6c757d; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-email { background: #28a745; color: white; }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
            transition: background-color 0.3s;
        }

        .dropdown-content button:first-child {
            border-radius: 5px 5px 0 0;
        }

        .dropdown-content button:last-child {
            border-radius: 0 0 5px 5px;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content button.danger {
            color: #dc3545;
        }

        .dropdown-content button.danger:hover {
            background-color: #f8d7da;
        }

        .dropdown.show .dropdown-content {
            display: block;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .summary {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        .employee-summary {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .employee-summary.hours-zero {
            background: #f8f9fa;
        }

        .employee-summary.hours-partial {
            background: #ffebee;
            border: 1px solid #ef5350;
        }

        .employee-summary.hours-complete {
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        @keyframes greenFlash {
            0% { 
                background: #2e7d32;
                transform: scale(1.05);
            }
            50% { 
                background: #388e3c;
                transform: scale(1.02);
            }
            100% { 
                background: #e8f5e8;
                transform: scale(1);
            }
        }

        @keyframes textFlash {
            0% { 
                color: white;
            }
            50% { 
                color: white;
            }
            100% { 
                color: inherit;
            }
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        .employee-summary.hours-complete.flash .employee-name,
        .employee-summary.hours-complete.flash .hours-total,
        .employee-summary.hours-complete.flash .hours-remaining {
            animation: textFlash 0.8s ease-out;
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hours-total {
            font-size: 14px;
            color: #495057;
        }

        .hours-remaining {
            font-size: 12px;
            margin-top: 5px;
        }

        .hours-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .schedule-grid {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .days-header {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #1a252f;
            color: white;
        }

        .time-header {
            background: #243342;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            padding: 10px 8px;
            text-align: center;
            border-left: 1px solid #485b6b;
            position: relative;
        }

        .day-toggle-container {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .day-toggle {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            user-select: none;
        }

        .day-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .day-toggle.open {
            background: #4caf50;
            color: white;
        }

        .day-toggle.closed {
            background: #f44336;
            color: white;
        }

        .day-toggle.am-closed {
            background: #ff9800;
            color: white;
        }

        .day-toggle.pm-closed {
            background: #ff9800;
            color: white;
        }

        .schedule-cell.closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
        }

        .schedule-cell.establishment-closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .schedule-cell.establishment-closed::after {
            content: "FERMÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .schedule-cell.closed::after {
            content: "FERMÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .time-row.closed .schedule-cell {
            position: relative;
        }

        .day-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .day-date {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.9;
        }

        .employees-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
            background: #ecf0f1;
        }

        .time-cell {
            padding: 3px 6px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 10px;
            line-height: 1.1;
        }

        .time-row:nth-child(odd) .time-cell {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) .time-cell {
            background-color: #ffffff;
        }

        .employees-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            border-left: 2px solid #95a5a6;
            min-height: 40px;
        }

        .time-cell.employees-header {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
            padding: 2px;
            transform: rotate(180deg);
        }

        .time-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
        }

        .time-row:nth-child(odd) {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) {
            background-color: #ffffff;
        }

        .schedule-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1px;
            border-left: 2px solid #95a5a6;
            min-height: 20px;
        }

        .time-slot {
            width: 18px;
            height: 18px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .time-slot.default-gray {
            background-color: #95a5a6;
        }

        .time-slot.default-green {
            background-color: #a8d8a8;
        }

        .time-slot.employee-1 { background-color: #e74c3c; }
        .time-slot.employee-2 { background-color: #3498db; }
        .time-slot.employee-3 { background-color: #f39c12; }
        .time-slot.employee-4 { background-color: #9b59b6; }
        .time-slot.employee-5 { background-color: #f1c40f; }

        .time-slot:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .time-slot.drag-preview {
            border: 2px solid #27ae60;
            opacity: 0.8;
        }

        .time-slot.drag-invalid {
            border: 2px solid #e74c3c;
        }

        .daily-totals {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #12BBFD;
            color: white;
            font-weight: bold;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            min-height: 35px;
        }

        .total-cell {
            padding: 8px 6px;
            text-align: center;
            border-left: 2px solid rgba(255,255,255,0.2);
            transition: background-color 0.3s ease;
            font-size: 11px;
        }

        .total-cell:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .total-label {
            background: #12BBFD;
            font-size: 10px;
            font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .daily-employee-totals {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .daily-employee-totals > div {
            background: rgba(255,255,255,0.15);
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .daily-employee-totals > div:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
        }

        .employee-input {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .employee-form-group {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            align-items: center;
        }

        .form-row input {
            flex: none;
        }

        .form-row input[type="text"]:nth-child(2) {
            width: 120px; /* Prénom */
        }

        .form-row input[type="text"]:nth-child(3) {
            width: 250px; /* Nom */
        }

        .form-row input[type="email"] {
            flex: 1; /* Email prend l'espace restant */
            min-width: 200px;
        }

        .clear-employee-btn {
            width: 32px;
            height: 32px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .clear-employee-btn:hover {
            background: #c82333;
        }

        .employee-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
            display: flex;
            align-items: center;
            min-width: 80px;
            flex-shrink: 0;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 1200px) {
            .main-content {
                padding: 0 10px;
            }
            
            .time-slot {
                width: 15px;
                height: 15px;
            }
            
            .employee-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📋 Gestion Planning LATILLE</h1>
        <div class="controls">
            <div class="week-selector">
                <div class="week-group">
                    <label>Semaine</label>
                    <select id="weekSelect"></select>
                    <button class="week-nav-btn" onclick="changeWeek(-1)" title="Semaine précédente">◀</button>
                    <button class="week-nav-btn" onclick="changeWeek(1)" title="Semaine suivante">▶</button>
                </div>
                <div class="week-group">
                    <label>Année</label>
                    <select id="yearSelect"></select>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-employees" onclick="toggleDropdown()">Actions ⋮</button>
                <div class="dropdown-content" id="actionsDropdown">
                    <button onclick="openEmployeeModal(); closeDropdown()">Gérer Employés</button>
                    <button onclick="openDuplicateModal(); closeDropdown()">Dupliquer Planning</button>
                    <button class="danger" onclick="openResetModal(); closeDropdown()">Réinitialiser</button>
                </div>
            </div>
            <button class="btn btn-save" onclick="loadSchedules()">Recharger</button>
            <button class="btn btn-save" onclick="openPrintableVersion()">Planning Impression</button>
            <button class="btn btn-email" onclick="sendByEmail()">Envoyer par Email</button>
        </div>
    </div>

    <div class="main-content">
        <div class="summary">
            <h3>Résumé Hebdomadaire</h3>
            <div class="summary-grid" id="summaryGrid"></div>
        </div>

        <div class="schedule-grid">
            <div class="days-header">
                <div class="time-header">Horaires</div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(0)" title="Ouvrir/Fermer lundi" data-day="0">✓</div>
                    </div>
                    <div class="day-title">Lundi</div>
                    <div class="day-date" id="monday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(1)" title="Ouvrir/Fermer mardi" data-day="1">✓</div>
                    </div>
                    <div class="day-title">Mardi</div>
                    <div class="day-date" id="tuesday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(2)" title="Ouvrir/Fermer mercredi" data-day="2">✓</div>
                    </div>
                    <div class="day-title">Mercredi</div>
                    <div class="day-date" id="wednesday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(3)" title="Ouvrir/Fermer jeudi" data-day="3">✓</div>
                    </div>
                    <div class="day-title">Jeudi</div>
                    <div class="day-date" id="thursday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(4)" title="Ouvrir/Fermer vendredi" data-day="4">✓</div>
                    </div>
                    <div class="day-title">Vendredi</div>
                    <div class="day-date" id="friday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(5)" title="Ouvrir/Fermer samedi" data-day="5">✓</div>
                    </div>
                    <div class="day-title">Samedi</div>
                    <div class="day-date" id="saturday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(6)" title="Ouvrir/Fermer dimanche" data-day="6">✓</div>
                    </div>
                    <div class="day-title">Dimanche</div>
                    <div class="day-date" id="sunday-date"></div>
                </div>
            </div>

            <div class="employees-row">
                <div class="time-cell employees-header">Employés</div>
                <div class="employees-cell" id="monday-employees"></div>
                <div class="employees-cell" id="tuesday-employees"></div>
                <div class="employees-cell" id="wednesday-employees"></div>
                <div class="employees-cell" id="thursday-employees"></div>
                <div class="employees-cell" id="friday-employees"></div>
                <div class="employees-cell" id="saturday-employees"></div>
                <div class="employees-cell" id="sunday-employees"></div>
            </div>

            <div id="timeSlots"></div>

            <div class="daily-totals">
                <div class="total-cell total-label" style="font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px;">Total Jour</div>
                <div class="total-cell" id="monday-totals"></div>
                <div class="total-cell" id="tuesday-totals"></div>
                <div class="total-cell" id="wednesday-totals"></div>
                <div class="total-cell" id="thursday-totals"></div>
                <div class="total-cell" id="friday-totals"></div>
                <div class="total-cell" id="saturday-totals"></div>
                <div class="total-cell" id="sunday-totals"></div>
            </div>

            <div class="daily-totals" style="background: #20B077; min-height: 35px;">
                <div class="total-cell total-label" style="background: #20B077; font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px; display: flex; align-items: center; justify-content: center;">Équipe</div>
                <div class="total-cell" id="monday-team-total">0h</div>
                <div class="total-cell" id="tuesday-team-total">0h</div>
                <div class="total-cell" id="wednesday-team-total">0h</div>
                <div class="total-cell" id="thursday-team-total">0h</div>
                <div class="total-cell" id="friday-team-total">0h</div>
                <div class="total-cell" id="saturday-team-total">0h</div>
                <div class="total-cell" id="sunday-team-total">0h</div>
            </div>
        </div>
    </div>

    <!-- Modal pour gérer les employés -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2>Gérer les Employés</h2>
            <div id="employeeInputs"></div>
            <button class="btn btn-save" onclick="saveEmployees()">Sauvegarder les Noms</button>
        </div>
    </div>

    <!-- Modal pour dupliquer un planning -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDuplicateModal()">&times;</span>
            <h2>Dupliquer un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning source :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="sourceWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="sourceYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning destination :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="destWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="destYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <div id="duplicateInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
            </div>
            <button class="btn btn-save" onclick="duplicatePlanning()">Dupliquer le Planning</button>
        </div>
    </div>

    <!-- Modal pour réinitialiser un planning -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h2>Réinitialiser un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Semaine à réinitialiser :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="resetWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="resetYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <div id="resetInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 15px 0;">
                    <strong>⚠️ Attention :</strong> Cette action supprimera définitivement tous les plannings et fermetures de cette semaine. Cette action est irréversible.
                </div>
            </div>
            <button class="btn" style="background: #dc3545; color: white;" onclick="resetPlanning()">Réinitialiser le Planning</button>
        </div>
    </div>

    <script>
        // Configuration des créneaux horaires
        const timeSlots = [
            { start: '07:00', end: '07:30', duration: 30 },
            { start: '07:30', end: '08:00', duration: 30 },
            { start: '08:00', end: '08:30', duration: 30 },
            { start: '08:30', end: '08:45', duration: 15 },
            { start: '08:45', end: '09:00', duration: 15 },
            { start: '09:00', end: '09:30', duration: 30 },
            { start: '09:30', end: '10:00', duration: 30 },
            { start: '10:00', end: '10:30', duration: 30 },
            { start: '10:30', end: '11:00', duration: 30 },
            { start: '11:00', end: '11:30', duration: 30 },
            { start: '11:30', end: '12:00', duration: 30 },
            { start: '12:00', end: '12:30', duration: 30 },
            { start: '12:30', end: '12:45', duration: 15 },
            { start: '12:45', end: '13:00', duration: 15 },
            { start: '13:00', end: '13:30', duration: 30 },
            { start: '13:30', end: '14:00', duration: 30 },
            { start: '14:00', end: '14:30', duration: 30 },
            { start: '14:30', end: '15:00', duration: 30 },
            { start: '15:00', end: '15:15', duration: 15 },
            { start: '15:15', end: '15:30', duration: 15 },
            { start: '15:30', end: '16:00', duration: 30 },
            { start: '16:00', end: '16:30', duration: 30 },
            { start: '16:30', end: '17:00', duration: 30 },
            { start: '17:00', end: '17:30', duration: 30 },
            { start: '17:30', end: '18:00', duration: 30 },
            { start: '18:00', end: '18:30', duration: 30 },
            { start: '18:30', end: '19:00', duration: 30 },
            { start: '19:00', end: '19:15', duration: 15 },
            { start: '19:15', end: '19:30', duration: 15 },
            { start: '19:30', end: '20:00', duration: 30 }
        ];

        // Fonction pour calculer le numéro de semaine ISO 8601
        function getWeekNumber(date) {
            // Calcul ISO 8601 : semaine commence le lundi, semaine 1 contient le premier jeudi
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            
            // Jeudi de cette semaine
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            
            // 4 janvier est toujours dans la semaine 1
            const week1 = new Date(d.getFullYear(), 0, 4);
            
            // Calculer le nombre de semaines
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        // État de l'application - Initialisation sur la semaine courante
        const now = new Date();
        let currentWeek = getWeekNumber(now);
        let currentYear = now.getFullYear();
        let employees = [
            { firstName: 'Antoine', lastName: '', email: '' },
            { firstName: 'Léa', lastName: '', email: '' },
            { firstName: 'Noémie', lastName: '', email: '' },
            { firstName: 'Christelle', lastName: '', email: '' },
            { firstName: 'Sandrine', lastName: '', email: '' }
        ];
        let schedules = {};
        let closures = {}; // Nouveau : gestion des fermetures

        // Variables pour la synchronisation temps réel
        let activeListeners = {};
        let isUpdatingFromFirebase = false;

        // Variables pour le glisser-déposer
        let isDragging = false;
        let dragStart = null;
        let dragStartState = null;
        let dragCurrentEmployee = null;
        let dragCurrentDay = null;

        // Créneaux par défaut en gris
        const defaultGraySlots = ['13:00', '13:30', '14:00', '14:30'];
        const sundayGraySlots = ['13:00', '13:30', '14:00', '14:30', '15:00', '15:15', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:15', '19:30'];
        const defaultGreenSlots = ['08:30', '08:45', '12:30', '12:45', '15:00', '15:15'];
        const weekdayGreenSlots = ['19:00', '19:15']; // Lundi à Samedi seulement

        function toggleDayClosure(dayIndex) {
            // Vérification des permissions avec debug
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings passés ne peuvent pas être modifiés.');
                return;
            }
            
            const closureKey = `${currentYear}-${currentWeek}`;
            if (!closures[closureKey]) closures[closureKey] = {};
            
            // États: 'open' -> 'closed' -> 'am-closed' -> 'pm-closed' -> 'open'
            const currentState = closures[closureKey][dayIndex] || 'open';
            let nextState;
            
            switch(currentState) {
                case 'open':
                    nextState = 'closed';
                    break;
                case 'closed':
                    nextState = 'am-closed';
                    break;
                case 'am-closed':
                    nextState = 'pm-closed';
                    break;
                case 'pm-closed':
                    nextState = 'open';
                    break;
                default:
                    nextState = 'open';
            }
            
            closures[closureKey][dayIndex] = nextState;
            updateClosureDisplay();
            
            // Auto-sauvegarde sur Firebase (seulement si pas de mise à jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                saveSchedulesToFirebase();
            }
        }

        function updateClosureDisplay() {
            const closureKey = `${currentYear}-${currentWeek}`;
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((day, dayIndex) => {
                const toggle = document.querySelector(`[data-day="${dayIndex}"]`);
                const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
                
                // Mettre à jour l'apparence du bouton
                toggle.className = `day-toggle ${state}`;
                
                switch(state) {
                    case 'open':
                        toggle.textContent = '✓';
                        toggle.title = `Ouvrir/Fermer ${getDayName(dayIndex)}`;
                        break;
                    case 'closed':
                        toggle.textContent = '✗';
                        toggle.title = `${getDayName(dayIndex)} - Fermé toute la journée`;
                        break;
                    case 'am-closed':
                        toggle.textContent = 'AM';
                        toggle.title = `${getDayName(dayIndex)} - Fermé le matin`;
                        break;
                    case 'pm-closed':
                        toggle.textContent = 'PM';
                        toggle.title = `${getDayName(dayIndex)} - Fermé l'après-midi`;
                        break;
                }
                
                // Appliquer les effets visuels sur les lignes
                updateRowsVisual(dayIndex, state);
            });
        }

        function updateRowsVisual(dayIndex, state) {
            // Supprimer les classes existantes
            document.querySelectorAll('.time-row').forEach(row => {
                const cells = row.querySelectorAll('.schedule-cell');
                if (cells[dayIndex]) {
                    cells[dayIndex].classList.remove('closed', 'establishment-closed');
                    // Supprimer tout texte qui pourrait avoir été ajouté
                    cells[dayIndex].style.position = 'relative';
                    const existingText = cells[dayIndex].querySelector('.closed-text');
                    if (existingText) {
                        existingText.remove();
                    }
                }
                row.classList.remove('closed');
            });
            
            if (state === 'closed') {
                // Fermeture complète
                document.querySelectorAll('.time-row').forEach(row => {
                    const cells = row.querySelectorAll('.schedule-cell');
                    if (cells[dayIndex]) {
                        cells[dayIndex].classList.add('establishment-closed');
                    }
                });
            } else if (state === 'am-closed') {
                // Fermeture matin (07:00-13:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 7 && hour < 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            } else if (state === 'pm-closed') {
                // Fermeture après-midi (13:00-20:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            }
        }

        function getDayName(dayIndex) {
            const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
            return days[dayIndex];
        }

        function isSlotClosed(dayIndex, slotIndex) {
            const closureKey = `${currentYear}-${currentWeek}`;
            const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
            
            if (state === 'closed') return true;
            if (state === 'open') return false;
            
            const hour = parseInt(timeSlots[slotIndex].start.split(':')[0]);
            if (state === 'am-closed' && hour >= 7 && hour < 13) return true;
            if (state === 'pm-closed' && hour >= 13) return true;
            
            return false;
        }

        function changeWeek(direction) {
            const newWeek = currentWeek + direction;
            
            if (newWeek >= 1 && newWeek <= 53) {
                // Rester dans la même année
                currentWeek = newWeek;
                document.getElementById('weekSelect').value = currentWeek;
                updateScheduleDisplay();
            } else if (newWeek === 0) {
                // Passer à la semaine 53 de l'année précédente
                if (currentYear > 2024) {
                    currentYear--;
                    currentWeek = 53;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            } else if (newWeek === 54) {
                // Passer à la semaine 1 de l'année suivante
                if (currentYear < 2030) {
                    currentYear++;
                    currentWeek = 1;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            }
        }

        // Initialize on page load - sera appelé par Firebase
        window.initializeApp = function() {
            populateSelectors();
            loadEmployees();
            loadSchedulesFromFirebase();
            updateScheduleDisplay();
        };

        // Fonctions Firebase avec vérification
        async function saveSchedulesToFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                console.log('Firebase pas encore prêt, sauvegarde ignorée');
                return false;
            }

            try {
                const { doc, setDoc } = window.firestoreSDK;
                
                // Sauvegarder les employés
                await setDoc(doc(window.firestore, 'planning-data', 'employees'), {
                    employees: employees,
                    lastUpdated: new Date().toISOString()
                });

                // Sauvegarder les plannings
                for (const [key, schedule] of Object.entries(schedules)) {
                    await setDoc(doc(window.firestore, 'planning-data', `schedule-${key}`), {
                        schedule: schedule,
                        lastUpdated: new Date().toISOString()
                    });
                }

                // Sauvegarder les fermetures
                for (const [key, closure] of Object.entries(closures)) {
                    await setDoc(doc(window.firestore, 'planning-data', `closure-${key}`), {
                        closure: closure,
                        lastUpdated: new Date().toISOString()
                    });
                }

                console.log('Données sauvegardées sur Firebase');
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                return false;
            }
        }

        async function loadSchedulesFromFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                console.log('Firebase pas encore prêt, chargement par défaut');
                loadEmployees();
                return;
            }

            try {
                const { doc, getDoc, collection, getDocs } = window.firestoreSDK;
                
                // Charger les employés
                const employeesDoc = await getDoc(doc(window.firestore, 'planning-data', 'employees'));
                if (employeesDoc.exists()) {
                    employees = employeesDoc.data().employees || employees;
                }

                // Charger tous les documents de planning-data
                const planningCollection = collection(window.firestore, 'planning-data');
                const snapshot = await getDocs(planningCollection);
                
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id;
                    
                    if (docId.startsWith('schedule-')) {
                        const key = docId.replace('schedule-', '');
                        schedules[key] = data.schedule;
                    } else if (docId.startsWith('closure-')) {
                        const key = docId.replace('closure-', '');
                        closures[key] = data.closure;
                    }
                });

                console.log('Données chargées depuis Firebase');
                
                // Démarrer l'écoute temps réel après le chargement initial
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                // Utiliser les données par défaut en cas d'erreur
                loadEmployees();
            }
        }

        function setupRealtimeListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;

            // Nettoyer les anciens listeners
            Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
            activeListeners = {};

            // Écouter les changements des employés
            activeListeners.employees = onSnapshot(
                doc(window.firestore, 'planning-data', 'employees'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newEmployees = docSnapshot.data().employees;
                        if (JSON.stringify(newEmployees) !== JSON.stringify(employees)) {
                            isUpdatingFromFirebase = true;
                            employees = newEmployees;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log('🔄 Employés mis à jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener employés:', error)
            );

            // Écouter les changements de la semaine courante (planning + fermetures)
            setupCurrentWeekListeners();
        }

        function setupCurrentWeekListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;
            const currentKey = `${currentYear}-${currentWeek}`;

            // Nettoyer les listeners de la semaine précédente
            if (activeListeners.currentSchedule) {
                activeListeners.currentSchedule();
                delete activeListeners.currentSchedule;
            }
            if (activeListeners.currentClosure) {
                activeListeners.currentClosure();
                delete activeListeners.currentClosure;
            }

            // Écouter les changements du planning de la semaine courante
            activeListeners.currentSchedule = onSnapshot(
                doc(window.firestore, 'planning-data', `schedule-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newSchedule = docSnapshot.data().schedule;
                        if (JSON.stringify(newSchedule) !== JSON.stringify(schedules[currentKey])) {
                            isUpdatingFromFirebase = true;
                            schedules[currentKey] = newSchedule;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🔄 Planning semaine ${currentKey} mis à jour depuis Firebase`);
                        }
                    } else {
                        // Document supprimé
                        if (schedules[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete schedules[currentKey];
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🗑️ Planning semaine ${currentKey} supprimé`);
                        }
                    }
                },
                (error) => console.error('Erreur listener planning:', error)
            );

            // Écouter les changements des fermetures de la semaine courante
            activeListeners.currentClosure = onSnapshot(
                doc(window.firestore, 'planning-data', `closure-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newClosure = docSnapshot.data().closure;
                        if (JSON.stringify(newClosure) !== JSON.stringify(closures[currentKey])) {
                            isUpdatingFromFirebase = true;
                            closures[currentKey] = newClosure;
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🔄 Fermetures semaine ${currentKey} mises à jour depuis Firebase`);
                        }
                    } else {
                        // Document supprimé
                        if (closures[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete closures[currentKey];
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🗑️ Fermetures semaine ${currentKey} supprimées`);
                        }
                    }
                },
                (error) => console.error('Erreur listener fermetures:', error)
            );
        }

        function populateSelectors() {
            const weekSelect = document.getElementById('weekSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            // Populate weeks (1-53)
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                weekSelect.appendChild(option);
            }
            
            // Populate years
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            weekSelect.addEventListener('change', (e) => {
                currentWeek = parseInt(e.target.value);
                updateScheduleDisplay();
            });
            
            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                updateScheduleDisplay();
            });
        }

        function loadEmployees() {
            if (employees.length !== 5) {
                employees = [
                    { firstName: 'Antoine', lastName: '', email: '' },
                    { firstName: 'Léa', lastName: '', email: '' },
                    { firstName: 'Noémie', lastName: '', email: '' },
                    { firstName: 'Christelle', lastName: '', email: '' },
                    { firstName: 'Sandrine', lastName: '', email: '' }
                ];
            }
            // Migration pour compatibilité avec l'ancien format
            if (typeof employees[0] === 'string') {
                employees = employees.map(name => ({
                    firstName: name,
                    lastName: '',
                    email: ''
                }));
            }
        }

        function getWeekDates(year, week) {
            // Calcul ISO 8601 : la semaine 1 est celle qui contient le premier jeudi de l'année
            const jan4 = new Date(year, 0, 4); // 4 janvier est toujours dans la semaine 1
            const jan4Day = jan4.getDay() || 7; // Dimanche = 7 au lieu de 0
            
            // Trouver le lundi de la semaine 1
            const firstMondayOfYear = new Date(jan4);
            firstMondayOfYear.setDate(jan4.getDate() - jan4Day + 1);
            
            // Calculer le lundi de la semaine demandée
            const mondayOfWeek = new Date(firstMondayOfYear);
            mondayOfWeek.setDate(firstMondayOfYear.getDate() + (week - 1) * 7);
            
            // Générer les 7 dates de la semaine
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(mondayOfWeek);
                date.setDate(mondayOfWeek.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        function updateScheduleDisplay() {
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Update dates in headers
            days.forEach((day, index) => {
                document.getElementById(`${day}-date`).textContent = formatDate(dates[index]);
            });
            
            // Update employee names in each day
            days.forEach(day => {
                const container = document.getElementById(`${day}-employees`);
                container.innerHTML = '';
                employees.forEach(employee => {
                    const label = document.createElement('div');
                    label.className = 'employee-label';
                    label.textContent = employee.firstName || 'Employé';
                    container.appendChild(label);
                });
            });
            
            // Generate time slots
            generateTimeSlots();
            updateSummary();
            updateClosureDisplay();
            
            // Mettre à jour les listeners pour la nouvelle semaine (seulement si pas de mise à jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                setupCurrentWeekListeners();
            }
        }

        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            timeSlots.forEach((slot, slotIndex) => {
                const row = document.createElement('div');
                row.className = 'time-row';
                
                // Time label
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                timeCell.textContent = `${slot.start}-${slot.end}`;
                row.appendChild(timeCell);
                
                // Days
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, dayIndex) => {
                    const scheduleCell = document.createElement('div');
                    scheduleCell.className = 'schedule-cell';
                    
                    employees.forEach((employee, empIndex) => {
                        const timeSlotDiv = document.createElement('div');
                        timeSlotDiv.className = 'time-slot';
                        timeSlotDiv.dataset.day = dayIndex;
                        timeSlotDiv.dataset.slot = slotIndex;
                        timeSlotDiv.dataset.employee = empIndex;
                        
                        // Apply default colors based on rules
                        const defaultClass = getDefaultClass(slot.start, dayIndex);
                        if (defaultClass) {
                            timeSlotDiv.classList.add(defaultClass);
                        }
                        
                        // Load saved state
                        const scheduleKey = `${currentYear}-${currentWeek}`;
                        if (schedules[scheduleKey] && schedules[scheduleKey][dayIndex] && schedules[scheduleKey][dayIndex][slotIndex] && schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            timeSlotDiv.className = 'time-slot employee-' + (empIndex + 1);
                        }
                        
                        // Événements pour le clic simple et le glisser
                        timeSlotDiv.addEventListener('mousedown', (e) => startDrag(e, timeSlotDiv, dayIndex, slotIndex, empIndex));
                        timeSlotDiv.addEventListener('mouseenter', (e) => updateDrag(timeSlotDiv, dayIndex, slotIndex, empIndex));
                        timeSlotDiv.addEventListener('click', (e) => {
                            if (!isDragging) {
                                toggleTimeSlot(timeSlotDiv, dayIndex, slotIndex, empIndex);
                            }
                        });
                        
                        scheduleCell.appendChild(timeSlotDiv);
                    });
                    
                    row.appendChild(scheduleCell);
                });
                
                container.appendChild(row);
            });
        }

        function startDrag(e, element, dayIndex, slotIndex, empIndex) {
            // Vérification des permissions avec debug
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings passés ne peuvent pas être modifiés.');
                return;
            }
            
            e.preventDefault();
            isDragging = true;
            dragStart = { dayIndex, slotIndex, empIndex };
            dragCurrentEmployee = empIndex;
            dragCurrentDay = dayIndex;
            
            // Déterminer l'état de départ
            const scheduleKey = `${currentYear}-${currentWeek}`;
            dragStartState = !!(schedules[scheduleKey] && 
                              schedules[scheduleKey][dayIndex] && 
                              schedules[scheduleKey][dayIndex][slotIndex] && 
                              schedules[scheduleKey][dayIndex][slotIndex][empIndex]);
        }

        function updateDrag(element, dayIndex, slotIndex, empIndex) {
            if (!isDragging) return;
            
            // Nettoyer les aperçus précédents
            clearDragPreview();
            
            // Vérifier si on est sur le bon employé et jour
            if (empIndex !== dragCurrentEmployee || dayIndex !== dragCurrentDay) {
                element.classList.add('drag-invalid');
                return;
            }
            
            // Calculer la plage
            const startSlot = Math.min(dragStart.slotIndex, slotIndex);
            const endSlot = Math.max(dragStart.slotIndex, slotIndex);
            
            // Appliquer l'aperçu
            for (let slot = startSlot; slot <= endSlot; slot++) {
                const targetElement = document.querySelector(`[data-day="${dayIndex}"][data-slot="${slot}"][data-employee="${empIndex}"]`);
                if (targetElement) {
                    targetElement.classList.add('drag-preview');
                }
            }
        }

        function clearDragPreview() {
            document.querySelectorAll('.drag-preview, .drag-invalid').forEach(el => {
                el.classList.remove('drag-preview', 'drag-invalid');
            });
        }

        // Événements globaux
        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                const previewElements = document.querySelectorAll('.drag-preview');
                const invalidElements = document.querySelectorAll('.drag-invalid');
                
                if (previewElements.length > 0 && invalidElements.length === 0) {
                    // Appliquer les changements
                    const scheduleKey = `${currentYear}-${currentWeek}`;
                    if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
                    if (!schedules[scheduleKey][dragCurrentDay]) schedules[scheduleKey][dragCurrentDay] = {};
                    
                    previewElements.forEach(element => {
                        const slotIndex = parseInt(element.dataset.slot);
                        const empIndex = parseInt(element.dataset.employee);
                        
                        if (!schedules[scheduleKey][dragCurrentDay][slotIndex]) {
                            schedules[scheduleKey][dragCurrentDay][slotIndex] = {};
                        }
                        
                        // Inverser l'état
                        schedules[scheduleKey][dragCurrentDay][slotIndex][empIndex] = !dragStartState;
                        
                        // Mettre à jour visuellement
                        if (!dragStartState) {
                            element.className = `time-slot employee-${empIndex + 1}`;
                        } else {
                            element.className = 'time-slot';
                            const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dragCurrentDay);
                            if (defaultClass) {
                                element.classList.add(defaultClass);
                            }
                        }
                    });
                    
                    updateSummary();
                    
                    // Auto-sauvegarde sur Firebase (seulement si pas de mise à jour Firebase en cours)
                    if (!isUpdatingFromFirebase) {
                        saveSchedulesToFirebase();
                    }
                }
                
                clearDragPreview();
                isDragging = false;
                dragStart = null;
                dragStartState = null;
                dragCurrentEmployee = null;
                dragCurrentDay = null;
            }
        });

        function getDefaultClass(timeStart, dayIndex) {
            // Default gray slots (all days)
            if (defaultGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            // Sunday specific gray slots
            if (dayIndex === 6 && sundayGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            // Default green slots (all days)
            if (defaultGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            
            // Weekday green slots (Monday to Saturday)
            if (dayIndex < 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            
            // Sunday specific: 19:00 and 19:15 should be gray
            if (dayIndex === 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            return null;
        }

        function toggleTimeSlot(element, dayIndex, slotIndex, empIndex) {
            // Vérifier si le créneau est fermé
            if (isSlotClosed(dayIndex, slotIndex)) {
                alert('Impossible d\'assigner du personnel : établissement fermé sur ce créneau.');
                return;
            }
            
            // Vérification des permissions avec debug
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings passés ne peuvent pas être modifiés.');
                return;
            }
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
            if (!schedules[scheduleKey][dayIndex]) schedules[scheduleKey][dayIndex] = {};
            if (!schedules[scheduleKey][dayIndex][slotIndex]) schedules[scheduleKey][dayIndex][slotIndex] = {};
            
            // Toggle state
            const isActive = schedules[scheduleKey][dayIndex][slotIndex][empIndex];
            schedules[scheduleKey][dayIndex][slotIndex][empIndex] = !isActive;
            
            // Update visual
            if (schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                element.className = 'time-slot employee-' + (empIndex + 1);
            } else {
                element.className = 'time-slot';
                const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dayIndex);
                if (defaultClass) {
                    element.classList.add(defaultClass);
                }
            }
            
            updateSummary();
            
            // Auto-sauvegarde sur Firebase (seulement si pas de mise à jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                saveSchedulesToFirebase();
            }
        }

        function getCurrentWeekInfo() {
            const now = new Date();
            const currentWeekNumber = getWeekNumber(now);
            const currentYearNumber = now.getFullYear();
            
            return { currentWeekNumber, currentYearNumber };
        }

        function updateSummary() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const employeeTotals = [0, 0, 0, 0, 0];
            const dailyTotals = [0, 0, 0, 0, 0, 0, 0];
            
            // Calculate totals
            employees.forEach((employee, empIndex) => {
                let totalMinutes = 0;
                
                days.forEach((day, dayIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    dailyTotals[dayIndex] += dailyMinutes;
                });
                
                employeeTotals[empIndex] = totalMinutes;
                
                // Create summary card
                const card = document.createElement('div');
                card.className = 'employee-summary';
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hoursDisplay = `${hours}h${minutes.toString().padStart(2, '0')}`;
                
                const remaining = (35 * 60) - totalMinutes;
                const remainingHours = Math.floor(Math.abs(remaining) / 60);
                const remainingMinutes = Math.abs(remaining) % 60;
                const remainingDisplay = `${remaining < 0 ? '-' : ''}${remainingHours}h${remainingMinutes.toString().padStart(2, '0')}`;
                
                // Déterminer la classe selon les heures
                if (totalMinutes === 0) {
                    card.classList.add('hours-zero');
                } else if (totalMinutes === 35 * 60) {
                    card.classList.add('hours-complete');
                    // Ajouter animation flash si on vient d'atteindre 35h
                    setTimeout(() => {
                        card.classList.add('flash');
                    }, 50);
                } else {
                    card.classList.add('hours-partial');
                }
                
                card.innerHTML = `
                    <div class="employee-name">${employee.firstName || 'Employé'}</div>
                    <div class="hours-total">${hoursDisplay} hebdo</div>
                    <div class="hours-remaining ${remaining < 0 ? 'hours-negative' : ''}">(reste ${remainingDisplay} à répartir)</div>
                `;
                summaryGrid.appendChild(card);
            });
            
            // Update daily totals
            days.forEach((day, dayIndex) => {
                const container = document.getElementById(`${day}-totals`);
                container.innerHTML = '';
                
                const totalsDiv = document.createElement('div');
                totalsDiv.className = 'daily-employee-totals';
                
                employees.forEach((employee, empIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    const hours = Math.floor(dailyMinutes / 60);
                    const minutes = dailyMinutes % 60;
                    const display = `${hours}h${minutes.toString().padStart(2, '0')}`;
                    
                    const empTotal = document.createElement('div');
                    empTotal.textContent = display;
                    totalsDiv.appendChild(empTotal);
                });
                
                container.appendChild(totalsDiv);
                
                // Update team total
                const teamHours = Math.floor(dailyTotals[dayIndex] / 60);
                const teamMinutes = dailyTotals[dayIndex] % 60;
                const teamElement = document.getElementById(`${day}-team-total`);
                teamElement.textContent = `${teamHours}h${teamMinutes.toString().padStart(2, '0')}`;
                teamElement.style.fontSize = '10px';
            });
        }

        function openEmployeeModal() {
            const modal = document.getElementById('employeeModal');
            const inputs = document.getElementById('employeeInputs');
            inputs.innerHTML = '';
            
            employees.forEach((employee, index) => {
                const group = document.createElement('div');
                group.className = 'employee-form-group';
                
                group.innerHTML = `
                    <div class="form-row">
                        <div class="employee-title">Employé ${index + 1}</div>
                        <input type="text" class="employee-input" value="${employee.firstName}" 
                               placeholder="Prénom" id="employee-firstName-${index}" 
                               oninput="formatFirstName(this)">
                        <input type="text" class="employee-input" value="${employee.lastName}" 
                               placeholder="Nom" id="employee-lastName-${index}" 
                               oninput="formatLastName(this)">
                        <input type="email" class="employee-input" value="${employee.email}" 
                               placeholder="Email" id="employee-email-${index}" 
                               oninput="formatEmail(this)">
                        <button type="button" class="clear-employee-btn" onclick="clearEmployee(${index})" 
                                title="Effacer toutes les données">✗</button>
                    </div>
                `;
                
                inputs.appendChild(group);
            });
            
            modal.style.display = 'block';
        }

        // Fonction pour effacer les données d'un employé
        function clearEmployee(index) {
            if (confirm(`Êtes-vous sûr de vouloir effacer toutes les données de l'employé ${index + 1} ?`)) {
                document.getElementById(`employee-firstName-${index}`).value = '';
                document.getElementById(`employee-lastName-${index}`).value = '';
                document.getElementById(`employee-email-${index}`).value = '';
            }
        }

        // Fonctions de formatage automatique
        function formatFirstName(input) {
            let value = input.value;
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                input.value = value;
            }
        }

        function formatLastName(input) {
            input.value = input.value.toUpperCase();
        }

        function formatEmail(input) {
            input.value = input.value.toLowerCase();
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        function saveEmployees() {
            const newEmployees = [];
            for (let i = 0; i < 5; i++) {
                const firstName = document.getElementById(`employee-firstName-${i}`).value || '';
                const lastName = document.getElementById(`employee-lastName-${i}`).value || '';
                const email = document.getElementById(`employee-email-${i}`).value || '';
                
                newEmployees.push({
                    firstName: firstName,
                    lastName: lastName,
                    email: email
                });
            }
            
            employees = newEmployees;
            updateScheduleDisplay();
            closeEmployeeModal();
            
            // Sauvegarder sur Firebase
            saveSchedulesToFirebase().then(success => {
                if (success) {
                    alert('Informations des employés sauvegardées sur Firebase !');
                } else {
                    alert('Informations sauvegardées localement (erreur Firebase)');
                }
            });
        }

        function loadSchedules() {
            loadSchedulesFromFirebase().then(() => {
                updateScheduleDisplay();
                alert('Données rechargées depuis Firebase !');
            });
        }

        function openPrintableVersion() {
            // Générer le HTML d'impression
            const printHTML = generatePrintableHTML();
            
            // Ouvrir dans une nouvelle fenêtre
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Auto-focus pour impression
            printWindow.focus();
        }

        function generatePrintableHTML() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const dates = getWeekDates(currentYear, currentWeek);
            const firstDate = dates[0].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const lastDate = dates[6].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            let html = `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Semaine ${currentWeek} - ${currentYear}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: black;
            padding: 10mm;
        }

        @page {
            size: A4 landscape;
            margin: 8mm;
        }

        @media print {
            body { padding: 0; }
            .no-print { display: none; }
        }

        .header {
            text-align: center;
            margin-bottom: 8px;
        }

        .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .subtitle {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .planning-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 8px;
            table-layout: fixed;
        }

        .planning-table th,
        .planning-table td {
            border: 1px solid #95a5a6;
            padding: 1px;
            text-align: center;
            vertical-align: middle;
            height: 15px;
        }

        .time-col {
            width: 70px;
            background: #f8f9fa;
            font-weight: bold;
            font-size: 7px;
            padding: 1px;
            word-wrap: break-word;
        }

        .employee-col {
            width: 30px;
        }

        /* Séparation entre les jours */
        .day-separator {
            border-right: 3px solid #2c3e50 !important;
            position: relative;
        }

        .day-separator::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: transparent;
        }

        .day-header {
            background: #1a252f;
            color: white;
            font-weight: bold;
            font-size: 9px;
            padding: 3px 2px;
            height: 30px;
        }

        .employee-header {
            background: #ecf0f1;
            font-weight: bold;
            height: 38px;
            position: relative;
        }

        .employee-name {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-size: 8px;
            font-weight: bold;
            height: 35px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .time-slot {
            height: 14px;
            position: relative;
        }

        .assigned {
            font-weight: bold;
            color: white;
            font-size: 11px;
        }

        .closed {
            background: repeating-linear-gradient(
                45deg,
                #cccccc,
                #cccccc 3px,
                #999999 3px,
                #999999 6px
            );
            color: #666;
            font-style: italic;
            font-size: 6px;
        }

        /* Couleurs des employés */
        .employee-1 { background: #e74c3c; color: white; }
        .employee-2 { background: #3498db; color: white; }
        .employee-3 { background: #f39c12; color: white; }
        .employee-4 { background: #9b59b6; color: white; }
        .employee-5 { background: #f1c40f; color: black; }

        /* Créneaux par défaut */
        .default-gray { background: #95a5a6; }
        .default-green { background: #a8d8a8; }

        /* Lignes alternées */
        .planning-table tr:nth-child(even) .time-slot:not(.assigned):not(.closed):not(.default-gray):not(.default-green) {
            background: #f7f7f7;
        }

        .total-row {
            background: #12BBFD;
            color: white;
            font-weight: bold;
            font-size: 7px;
            height: 20px;
        }

        .team-total-row {
            background: #20B077;
            color: white;
            font-weight: bold;
            font-size: 8px;
            height: 20px;
        }

        .print-buttons {
            text-align: center;
            margin: 10px 0;
        }

        .print-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }

        .print-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="no-print print-buttons">
        <button class="print-btn" onclick="window.print()">🖨️ Imprimer / PDF</button>
        <button class="print-btn" onclick="window.close()">❌ Fermer</button>
    </div>

    <div class="header">
        <div class="title">GESTION PLANNING SPAR LATILLE</div>
        <div class="subtitle">Semaine ${currentWeek} - Du ${firstDate} au ${lastDate}</div>
    </div>

    <table class="planning-table">
        <!-- En-têtes des jours -->
        <tr>
            <th class="time-col">Horaires</th>`;

            // En-têtes des jours (5 colonnes par jour)
            const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            dayNames.forEach((dayName, dayIndex) => {
                const dateStr = dates[dayIndex].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                html += `<th colspan="5" class="day-header">${dayName}<br>${dateStr}</th>`;
            });

            html += `
        </tr>
        
        <!-- Ligne des employés -->
        <tr>
            <td class="time-col employee-header">Employés</td>`;

            // Prénoms des employés (répétés pour chaque jour)
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                employees.forEach((employee, empIndex) => {
                    // Ajouter la classe day-separator à la dernière colonne de chaque jour (sauf dimanche)
                    const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                    const separatorClass = isLastEmployeeOfDay ? ' day-separator' : '';
                    
                    html += `<td class="employee-col employee-header${separatorClass}">
                        <div class="employee-name">${employee.firstName || 'E'}</div>
                    </td>`;
                });
            }

            html += `
        </tr>`;

            // Lignes des créneaux horaires
            timeSlots.forEach((slot, slotIndex) => {
                html += `
        <tr>
            <td class="time-col">${slot.start}-${slot.end}</td>`;

                // Pour chaque jour
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    // Pour chaque employé
                    employees.forEach((employee, empIndex) => {
                        let cellClass = 'time-slot';
                        let cellContent = '';

                        // Vérifier les fermetures
                        if (isSlotClosed(dayIndex, slotIndex)) {
                            cellClass += ' closed';
                            cellContent = 'FERMÉ';
                        } else {
                            // Vérifier si cet employé est assigné
                            if (schedules[scheduleKey] && 
                                schedules[scheduleKey][dayIndex] && 
                                schedules[scheduleKey][dayIndex][slotIndex] && 
                                schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                                cellClass += ` employee-${empIndex + 1} assigned`;
                                cellContent = '●';
                            } else {
                                // Vérifier les créneaux par défaut
                                const defaultClass = getDefaultClass(slot.start, dayIndex);
                                if (defaultClass === 'default-gray') {
                                    cellClass += ' default-gray';
                                } else if (defaultClass === 'default-green') {
                                    cellClass += ' default-green';
                                }
                            }
                        }

                        // Ajouter la classe day-separator à la dernière colonne de chaque jour (sauf dimanche)
                        const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                        if (isLastEmployeeOfDay) {
                            cellClass += ' day-separator';
                        }

                        html += `<td class="${cellClass}">${cellContent}</td>`;
                    });
                }

                html += `
        </tr>`;
            });

            // Ligne totaux par employé
            html += `
        <tr class="total-row">
            <td class="time-col">Total Jour</td>`;

            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                employees.forEach((employee, empIndex) => {
                    let totalMinutes = 0;
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });

                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    
                    // Ajouter la classe day-separator à la dernière colonne de chaque jour (sauf dimanche)
                    const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                    const separatorClass = isLastEmployeeOfDay ? ' day-separator' : '';
                    
                    html += `<td class="total-row${separatorClass}">${hours}h${minutes.toString().padStart(2, '0')}</td>`;
                });
            }

            html += `
        </tr>
        
        <!-- Ligne total équipe -->
        <tr class="team-total-row">
            <td class="time-col">Équipe</td>`;

            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                let totalMinutes = 0;
                employees.forEach((employee, empIndex) => {
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });
                });

                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const teamTotal = `${hours}h${minutes.toString().padStart(2, '0')}`;

                // Total sur la première colonne, autres vides
                html += `<td colspan="5">${teamTotal}</td>`;
            }

            html += `
        </tr>
    </table>
</body>
</html>`;

            return html;
        }

        function sendByEmail() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            let emailBody = `Planning Semaine ${currentWeek} - ${currentYear}\n\n`;
            
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            employees.forEach((employee, empIndex) => {
                emailBody += `=== ${employee.firstName} ${employee.lastName} ===\n`;
                
                days.forEach((dayName, dayIndex) => {
                    const date = formatDate(dates[dayIndex]);
                    let daySchedule = [];
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            daySchedule.push(`${slot.start}-${slot.end}`);
                        }
                    });
                    
                    if (daySchedule.length > 0) {
                        emailBody += `${dayName} ${date}: ${daySchedule.join(', ')}\n`;
                    }
                });
                
                // Calculate total hours
                let totalMinutes = 0;
                timeSlots.forEach((slot, slotIndex) => {
                    days.forEach((_, dayIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });
                });
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                emailBody += `Total: ${hours}h${minutes.toString().padStart(2, '0')}\n\n`;
            });
            
            const subject = `Planning Semaine ${currentWeek} - ${currentYear}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            window.open(mailtoLink);
        }

        // Click outside modal to close
        window.addEventListener('click', (event) => {
            const employeeModal = document.getElementById('employeeModal');
            const duplicateModal = document.getElementById('duplicateModal');
            const resetModal = document.getElementById('resetModal');
            
            if (event.target === employeeModal) {
                closeEmployeeModal();
            }
            if (event.target === duplicateModal) {
                closeDuplicateModal();
            }
            if (event.target === resetModal) {
                closeResetModal();
            }
        });

        // Fonctions pour la duplication de planning
        function openDuplicateModal() {
            const modal = document.getElementById('duplicateModal');
            populateDuplicateSelectors();
            updateDuplicateInfo();
            modal.style.display = 'block';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        function populateDuplicateSelectors() {
            const sourceWeek = document.getElementById('sourceWeek');
            const sourceYear = document.getElementById('sourceYear');
            const destWeek = document.getElementById('destWeek');
            const destYear = document.getElementById('destYear');
            
            // Vider les sélecteurs
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.innerHTML = '';
            });
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) sourceOption.selected = true;
                sourceWeek.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) destOption.selected = true;
                destWeek.appendChild(destOption);
            }
            
            // Remplir les années
            for (let i = 2024; i <= 2030; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = i;
                if (i === currentYear) sourceOption.selected = true;
                sourceYear.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = i;
                if (i === currentYear) destOption.selected = true;
                destYear.appendChild(destOption);
            }
            
            // Ajouter les événements de changement
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.addEventListener('change', updateDuplicateInfo);
            });
        }

        function updateDuplicateInfo() {
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            const infoDiv = document.getElementById('duplicateInfo');
            
            let message = '';
            let isValid = true;
            
            // Vérifier si même semaine
            if (sourceWeek === destWeek && sourceYear === destYear) {
                message = '❌ La semaine source et destination ne peuvent pas être identiques.';
                isValid = false;
            }
            // Vérifier si destination est dans le passé
            else {
                const now = new Date();
                const currentWeekNumber = getWeekNumber(now);
                const currentYearNumber = now.getFullYear();
                
                if (destYear < currentYearNumber || (destYear === currentYearNumber && destWeek < currentWeekNumber)) {
                    message = '❌ Impossible de dupliquer vers une semaine passée.';
                    isValid = false;
                }
                // Vérifier si la source a des données
                else {
                    const sourceKey = `${sourceYear}-${sourceWeek}`;
                    const hasSourceData = schedules[sourceKey] && Object.keys(schedules[sourceKey]).length > 0;
                    const hasSourceClosures = closures[sourceKey] && Object.keys(closures[sourceKey]).length > 0;
                    
                    if (!hasSourceData && !hasSourceClosures) {
                        message = '⚠️ La semaine source ne contient aucun planning.';
                        isValid = false;
                    } else {
                        // Vérifier si destination a des données
                        const destKey = `${destYear}-${destWeek}`;
                        const hasDestData = schedules[destKey] && Object.keys(schedules[destKey]).length > 0;
                        const hasDestClosures = closures[destKey] && Object.keys(closures[destKey]).length > 0;
                        
                        if (hasDestData || hasDestClosures) {
                            message = '⚠️ La semaine destination contient déjà un planning qui sera écrasé.';
                        } else {
                            message = '✅ Prêt à dupliquer le planning.';
                        }
                    }
                }
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? (message.includes('écrasé') ? '#ff9800' : '#4caf50') : '#f44336';
            
            // Activer/désactiver le bouton
            const duplicateBtn = document.querySelector('#duplicateModal .btn-save');
            duplicateBtn.disabled = !isValid;
            duplicateBtn.style.opacity = isValid ? '1' : '0.5';
            duplicateBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function duplicatePlanning() {
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            
            const sourceKey = `${sourceYear}-${sourceWeek}`;
            const destKey = `${destYear}-${destWeek}`;
            
            // Vérifier si destination a des données et demander confirmation
            const hasDestData = schedules[destKey] && Object.keys(schedules[destKey]).length > 0;
            const hasDestClosures = closures[destKey] && Object.keys(closures[destKey]).length > 0;
            
            if (hasDestData || hasDestClosures) {
                if (!confirm(`La semaine ${destWeek}/${destYear} contient déjà un planning.\n\nÊtes-vous sûr de vouloir l'écraser ?`)) {
                    return;
                }
            }
            
            try {
                // Copier les plannings localement
                if (schedules[sourceKey]) {
                    schedules[destKey] = JSON.parse(JSON.stringify(schedules[sourceKey]));
                    console.log(`Planning copié de ${sourceKey} vers ${destKey}`);
                } else {
                    delete schedules[destKey];
                    console.log(`Aucun planning source à copier pour ${sourceKey}`);
                }
                
                // Copier les fermetures localement
                if (closures[sourceKey]) {
                    closures[destKey] = JSON.parse(JSON.stringify(closures[sourceKey]));
                    console.log(`Fermetures copiées de ${sourceKey} vers ${destKey}`);
                } else {
                    delete closures[destKey];
                    console.log(`Aucune fermeture source à copier pour ${sourceKey}`);
                }
                
                // Sauvegarder sur Firebase
                if (window.firebaseReady && window.firestoreSDK) {
                    const { doc, setDoc, deleteDoc } = window.firestoreSDK;
                    
                    // Sauvegarder ou supprimer le planning destination
                    if (schedules[destKey]) {
                        await setDoc(doc(window.firestore, 'planning-data', `schedule-${destKey}`), {
                            schedule: schedules[destKey],
                            lastUpdated: new Date().toISOString()
                        });
                        console.log(`Planning ${destKey} sauvegardé sur Firebase`);
                    } else {
                        try {
                            await deleteDoc(doc(window.firestore, 'planning-data', `schedule-${destKey}`));
                            console.log(`Planning ${destKey} supprimé de Firebase`);
                        } catch (error) {
                            console.log(`Aucun planning ${destKey} à supprimer sur Firebase`);
                        }
                    }
                    
                    // Sauvegarder ou supprimer les fermetures destination
                    if (closures[destKey]) {
                        await setDoc(doc(window.firestore, 'planning-data', `closure-${destKey}`), {
                            closure: closures[destKey],
                            lastUpdated: new Date().toISOString()
                        });
                        console.log(`Fermetures ${destKey} sauvegardées sur Firebase`);
                    } else {
                        try {
                            await deleteDoc(doc(window.firestore, 'planning-data', `closure-${destKey}`));
                            console.log(`Fermetures ${destKey} supprimées de Firebase`);
                        } catch (error) {
                            console.log(`Aucune fermeture ${destKey} à supprimer sur Firebase`);
                        }
                    }
                }
                
                // Basculer vers la semaine dupliquée
                currentWeek = destWeek;
                currentYear = destYear;
                document.getElementById('weekSelect').value = currentWeek;
                document.getElementById('yearSelect').value = currentYear;
                
                // Fermer la modal
                closeDuplicateModal();
                
                // Forcer la mise à jour de l'affichage
                setTimeout(() => {
                    updateScheduleDisplay();
                }, 100);
                
                alert(`Planning de la semaine ${sourceWeek}/${sourceYear} dupliqué avec succès vers la semaine ${destWeek}/${destYear} !`);
                
            } catch (error) {
                console.error('Erreur lors de la duplication:', error);
                alert('Erreur lors de la duplication. Consultez la console pour plus de détails.');
            }
        }

        // Fonctions pour la réinitialisation de planning
        function openResetModal() {
            const modal = document.getElementById('resetModal');
            populateResetSelectors();
            updateResetInfo();
            modal.style.display = 'block';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function populateResetSelectors() {
            const resetWeek = document.getElementById('resetWeek');
            const resetYear = document.getElementById('resetYear');
            
            // Vider les sélecteurs
            resetWeek.innerHTML = '';
            resetYear.innerHTML = '';
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                resetWeek.appendChild(option);
            }
            
            // Remplir les années
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                resetYear.appendChild(option);
            }
            
            // Ajouter les événements de changement
            resetWeek.addEventListener('change', updateResetInfo);
            resetYear.addEventListener('change', updateResetInfo);
        }

        function updateResetInfo() {
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            const infoDiv = document.getElementById('resetInfo');
            
            let message = '';
            let isValid = true;
            
            // Vérifier si c'est une semaine passée
            const now = new Date();
            const currentWeekNumber = getWeekNumber(now);
            const currentYearNumber = now.getFullYear();
            
            if (resetYear < currentYearNumber || (resetYear === currentYearNumber && resetWeek < currentWeekNumber)) {
                message = '❌ Impossible de réinitialiser une semaine passée.';
                isValid = false;
            } else {
                // Vérifier si la semaine a des données
                const resetKey = `${resetYear}-${resetWeek}`;
                const hasData = schedules[resetKey] && Object.keys(schedules[resetKey]).length > 0;
                const hasClosures = closures[resetKey] && Object.keys(closures[resetKey]).length > 0;
                
                if (!hasData && !hasClosures) {
                    message = '⚠️ Cette semaine ne contient aucun planning à réinitialiser.';
                    isValid = false;
                } else {
                    message = `✅ Prêt à réinitialiser la semaine ${resetWeek}/${resetYear}.`;
                }
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? '#4caf50' : '#f44336';
            
            // Activer/désactiver le bouton
            const resetBtn = document.querySelector('#resetModal .btn');
            resetBtn.disabled = !isValid;
            resetBtn.style.opacity = isValid ? '1' : '0.5';
            resetBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function resetPlanning() {
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            
            if (!confirm(`Êtes-vous absolument sûr de vouloir réinitialiser la semaine ${resetWeek}/${resetYear} ?\n\nCette action supprimera définitivement :\n- Tous les plannings des employés\n- Tous les états de fermeture\n\nCette action est IRRÉVERSIBLE.`)) {
                return;
            }
            
            const resetKey = `${resetYear}-${resetWeek}`;
            
            try {
                // Supprimer les données localement
                delete schedules[resetKey];
                delete closures[resetKey];
                
                // Supprimer sur Firebase
                if (window.firebaseReady && window.firestoreSDK) {
                    const { doc, deleteDoc } = window.firestoreSDK;
                    
                    // Supprimer le document de planning
                    try {
                        await deleteDoc(doc(window.firestore, 'planning-data', `schedule-${resetKey}`));
                        console.log(`Document schedule-${resetKey} supprimé de Firebase`);
                    } catch (error) {
                        console.log(`Document schedule-${resetKey} n'existait pas sur Firebase`);
                    }
                    
                    // Supprimer le document de fermetures
                    try {
                        await deleteDoc(doc(window.firestore, 'planning-data', `closure-${resetKey}`));
                        console.log(`Document closure-${resetKey} supprimé de Firebase`);
                    } catch (error) {
                        console.log(`Document closure-${resetKey} n'existait pas sur Firebase`);
                    }
                }
                
                // Fermer la modal
                closeResetModal();
                
                // Si c'est la semaine actuellement affichée, forcer la mise à jour
                if (resetWeek === currentWeek && resetYear === currentYear) {
                    // Forcer une mise à jour complète de l'affichage
                    setTimeout(() => {
                        updateScheduleDisplay();
                    }, 100);
                }
                
                alert(`Semaine ${resetWeek}/${resetYear} réinitialisée avec succès !`);
                
            } catch (error) {
                console.error('Erreur lors de la réinitialisation:', error);
                alert('Erreur lors de la réinitialisation. Consultez la console pour plus de détails.');
            }
        }

        // Fonctions pour le menu déroulant Actions
        function toggleDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.toggle('show');
        }

        function closeDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.remove('show');
        }

        // Fermer le dropdown si on clique ailleurs
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
