<!-- Interface d'authentification -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-title">üîê <span id="authModeTitle">Connexion</span></div>
            <div class="auth-subtitle">Gestion Planning LATILLE</div>
            
            <div id="authError" class="auth-error hidden"></div>
            <div id="authSuccess" class="auth-success hidden"></div>
            
            <!-- Mode connexion -->
            <div id="loginMode">
                <form id="loginForm">
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Adresse email" required>
                    <input type="password" id="loginPassword" class="auth-input" placeholder="Mot de passe" required>
                    <button type="submit" id="loginBtn" class="auth-btn">Se connecter</button>
                </form>
                
                <div style="margin-top: 15px; text-align: center;">
                    <a href="#" id="<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Planning LATILLE</title>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Biblioth√®que SheetJS pour l'export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Biblioth√®que jsPDF pour la g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB70gXioCFDN7qBQ21vDGviGSzb7Sg1slQ",
            authDomain: "planning-latille.firebaseapp.com",
            projectId: "planning-latille",
            storageBucket: "planning-latille.firebasestorage.app",
            messagingSenderId: "363904305106",
            appId: "1:363904305106:web:ecb94628d4eaaa25a72a0b"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Exposer Firebase globalement
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseAuth = auth;
        window.firestoreSDK = { doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot };
        window.authSDK = { signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider, createUserWithEmailAndPassword };
        window.firebaseReady = true;

        // Gestion de l'√©tat d'authentification
        onAuthStateChanged(auth, (user) => {
            window.handleAuthStateChange(user);
        });

        // Initialiser l'application une fois Firebase pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                window.initializeApp();
            });
        } else {
            window.initializeApp();
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .week-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .week-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .week-nav-btn {
            height: 36px;
            width: 24px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .week-nav-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }

        .week-nav-btn:active {
            background: #e0e0e0;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-employees { background: #6c757d; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-email { background: #28a745; color: white; }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
            transition: background-color 0.3s;
        }

        .dropdown-content button:first-child {
            border-radius: 5px 5px 0 0;
        }

        .dropdown-content button:last-child {
            border-radius: 0 0 5px 5px;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content button.danger {
            color: #dc3545;
        }

        .dropdown-content button.danger:hover {
            background-color: #f8d7da;
        }

        .dropdown.show .dropdown-content {
            display: block;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .summary {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        .employee-summary {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .employee-summary.hours-zero {
            background: #f8f9fa;
        }

        .employee-summary.hours-partial {
            background: #ffebee;
            border: 1px solid #ef5350;
        }

        .employee-summary.hours-complete {
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        @keyframes greenFlash {
            0% { 
                background: #2e7d32;
                transform: scale(1.05);
            }
            50% { 
                background: #388e3c;
                transform: scale(1.02);
            }
            100% { 
                background: #e8f5e8;
                transform: scale(1);
            }
        }

        @keyframes textFlash {
            0% { 
                color: white;
            }
            50% { 
                color: white;
            }
            100% { 
                color: inherit;
            }
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        .employee-summary.hours-complete.flash .employee-name,
        .employee-summary.hours-complete.flash .hours-total,
        .employee-summary.hours-complete.flash .hours-remaining {
            animation: textFlash 0.8s ease-out;
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hours-total {
            font-size: 14px;
            color: #495057;
        }

        .hours-remaining {
            font-size: 12px;
            margin-top: 5px;
        }

        .hours-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .schedule-grid {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .days-header {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #1a252f;
            color: white;
        }

        .time-header {
            background: #243342;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            padding: 10px 8px;
            text-align: center;
            border-left: 1px solid #485b6b;
            position: relative;
        }

        .day-toggle-container {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .day-toggle {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            user-select: none;
        }

        .day-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .day-toggle.open {
            background: #4caf50;
            color: white;
        }

        .day-toggle.closed {
            background: #f44336;
            color: white;
        }

        .day-toggle.am-closed {
            background: #ff9800;
            color: white;
        }

        .day-toggle.pm-closed {
            background: #ff9800;
            color: white;
        }

        .schedule-cell.closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
        }

        .schedule-cell.establishment-closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .schedule-cell.establishment-closed::after {
            content: "FERM√â";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .schedule-cell.closed::after {
            content: "FERM√â";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .time-row.closed .schedule-cell {
            position: relative;
        }

        .day-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .day-date {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.9;
        }

        .employees-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
            background: #ecf0f1;
        }

        .time-cell {
            padding: 3px 6px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 10px;
            line-height: 1.1;
        }

        .time-row:nth-child(odd) .time-cell {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) .time-cell {
            background-color: #ffffff;
        }

        .employees-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            border-left: 2px solid #95a5a6;
            min-height: 40px;
        }

        .time-cell.employees-header {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
            padding: 2px;
            transform: rotate(180deg);
        }

        .time-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
        }

        .time-row:nth-child(odd) {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) {
            background-color: #ffffff;
        }

        .schedule-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1px;
            border-left: 2px solid #95a5a6;
            min-height: 20px;
        }

        .time-slot {
            width: 18px;
            height: 18px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .time-slot.default-gray {
            background-color: #95a5a6;
        }

        .time-slot.default-green {
            background-color: #a8d8a8;
        }

        .time-slot.employee-1 { background-color: #e74c3c; }
        .time-slot.employee-2 { background-color: #3498db; }
        .time-slot.employee-3 { background-color: #f39c12; }
        .time-slot.employee-4 { background-color: #9b59b6; }
        .time-slot.employee-5 { background-color: #f1c40f; }

        .time-slot:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .time-slot.drag-preview {
            border: 2px solid #27ae60;
            opacity: 0.8;
        }

        .time-slot.drag-invalid {
            border: 2px solid #e74c3c;
        }

        .daily-totals {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #12BBFD;
            color: white;
            font-weight: bold;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            min-height: 35px;
        }

        .total-cell {
            padding: 8px 6px;
            text-align: center;
            border-left: 2px solid rgba(255,255,255,0.2);
            transition: background-color 0.3s ease;
            font-size: 11px;
        }

        .total-cell:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .total-label {
            background: #12BBFD;
            font-size: 10px;
            font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .daily-employee-totals {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .daily-employee-totals > div {
            background: rgba(255,255,255,0.15);
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .daily-employee-totals > div:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
        }

        .employee-input {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .employee-form-group {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            align-items: center;
        }

        .form-row input {
            flex: none;
        }

        .form-row input[type="text"]:nth-child(2) {
            width: 120px;
        }

        .form-row input[type="text"]:nth-child(3) {
            width: 250px;
        }

        .form-row input[type="email"] {
            flex: 1;
            min-width: 200px;
        }

        .clear-employee-btn {
            width: 32px;
            height: 32px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .clear-employee-btn:hover {
            background: #c82333;
        }

        .employee-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
            display: flex;
            align-items: center;
            min-width: 80px;
            flex-shrink: 0;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 1200px) {
            .main-content {
                padding: 0 10px;
            }
            
            .time-slot {
                width: 15px;
                height: 15px;
            }
            
            .employee-label {
                font-size: 10px;
            }
        }

        /* Styles pour l'authentification */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-title {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .auth-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: #2980b9;
        }

        .auth-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .auth-error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .auth-success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .forgot-password {
            color: #3498db;
            text-decoration: none;
            font-size: 14px;
            margin-top: 15px;
            display: inline-block;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
            font-size: 14px;
        }

        .user-role {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .user-role.admin {
            background: #e74c3c;
        }

        .user-role.user {
            background: #3498db;
        }

        .logout-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #7f8c8d;
        }

        .readonly-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 5000;
            display: none;
        }

        .readonly-banner {
            background: #f39c12;
            color: white;
            padding: 8px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Interface d'authentification -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-title">üîê Connexion</div>
            <div class="auth-subtitle">Gestion Planning LATILLE</div>
            
            <div id="authError" class="auth-error hidden"></div>
            <div id="authSuccess" class="auth-success hidden"></div>
            
            <form id="loginForm">
                <input type="email" id="loginEmail" class="auth-input" placeholder="Adresse email" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Mot de passe" required>
                <button type="submit" id="loginBtn" class="auth-btn">Se connecter</button>
            </form>
            
            <a href="#" id="forgotPasswordLink" class="forgot-password">Mot de passe oubli√© ?</a>
            
            <!-- Modal changement de mot de passe -->
            <div id="passwordModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closePasswordModal()">&times;</span>
                    <h2>Changer le mot de passe</h2>
                    <div style="margin: 20px 0;">
                        <input type="password" id="currentPassword" class="auth-input" placeholder="Mot de passe actuel" required>
                        <input type="password" id="newPassword" class="auth-input" placeholder="Nouveau mot de passe" required>
                        <input type="password" id="confirmPassword" class="auth-input" placeholder="Confirmer le nouveau mot de passe" required>
                    </div>
                    <button class="btn btn-save" onclick="changePassword()">Changer le mot de passe</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface principale -->
    <div id="mainApp" class="hidden">
        <!-- Banni√®re mode lecture seule -->
        <div id="readonlyBanner" class="readonly-banner hidden">
            üìñ Mode lecture seule - Vous pouvez consulter et imprimer ce planning
        </div>

        <div class="header">
            <h1>üìã Gestion Planning LATILLE</h1>
            <div class="controls">
                <div class="user-info">
                    <span id="userEmail"></span>
                    <span id="userRole" class="user-role"></span>
                    <button class="btn" style="background: #95a5a6; color: white; padding: 8px 12px;" onclick="openPasswordModal()">Changer MDP</button>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
                <div class="week-selector">
                    <div class="week-group">
                        <label>Semaine</label>
                        <select id="weekSelect"></select>
                        <button class="week-nav-btn" onclick="changeWeek(-1)" title="Semaine pr√©c√©dente">‚óÄ</button>
                        <button class="week-nav-btn" onclick="changeWeek(1)" title="Semaine suivante">‚ñ∂</button>
                    </div>
                    <div class="week-group">
                        <label>Ann√©e</label>
                        <select id="yearSelect"></select>
                    </div>
                </div>
                <div id="adminControls" class="dropdown">
                    <button class="btn btn-employees" onclick="toggleDropdown()">Actions ‚ãÆ</button>
                    <div class="dropdown-content" id="actionsDropdown">
                        <button onclick="openEmployeeModal(); closeDropdown()">G√©rer Employ√©s</button>
                        <button onclick="openDuplicateModal(); closeDropdown()">Dupliquer Planning</button>
                        <button class="danger" onclick="openResetModal(); closeDropdown()">R√©initialiser</button>
                        <button onclick="validatePlanning(); closeDropdown()">üìß Valider & Envoyer</button>
                    </div>
                </div>
                <button class="btn btn-save" onclick="loadSchedules()">Recharger</button>
                <button class="btn btn-save" onclick="openPrintableVersion()">Planning Impression</button>
                <button id="emailBtn" class="btn btn-email" onclick="sendByEmail()">Envoyer par Email</button>
            </div>
        </div>

    <div class="main-content">
        <div class="summary">
            <h3>R√©sum√© Hebdomadaire</h3>
            <div class="summary-grid" id="summaryGrid"></div>
        </div>

        <div class="schedule-grid">
            <div class="days-header">
                <div class="time-header">Horaires</div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(0)" title="Ouvrir/Fermer lundi" data-day="0">‚úì</div>
                    </div>
                    <div class="day-title">Lundi</div>
                    <div class="day-date" id="monday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(1)" title="Ouvrir/Fermer mardi" data-day="1">‚úì</div>
                    </div>
                    <div class="day-title">Mardi</div>
                    <div class="day-date" id="tuesday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(2)" title="Ouvrir/Fermer mercredi" data-day="2">‚úì</div>
                    </div>
                    <div class="day-title">Mercredi</div>
                    <div class="day-date" id="wednesday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(3)" title="Ouvrir/Fermer jeudi" data-day="3">‚úì</div>
                    </div>
                    <div class="day-title">Jeudi</div>
                    <div class="day-date" id="thursday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(4)" title="Ouvrir/Fermer vendredi" data-day="4">‚úì</div>
                    </div>
                    <div class="day-title">Vendredi</div>
                    <div class="day-date" id="friday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(5)" title="Ouvrir/Fermer samedi" data-day="5">‚úì</div>
                    </div>
                    <div class="day-title">Samedi</div>
                    <div class="day-date" id="saturday-date"></div>
                </div>
                <div class="day-header">
                    <div class="day-toggle-container">
                        <div class="day-toggle open" onclick="toggleDayClosure(6)" title="Ouvrir/Fermer dimanche" data-day="6">‚úì</div>
                    </div>
                    <div class="day-title">Dimanche</div>
                    <div class="day-date" id="sunday-date"></div>
                </div>
            </div>

            <div class="employees-row">
                <div class="time-cell employees-header">Employ√©s</div>
                <div class="employees-cell" id="monday-employees"></div>
                <div class="employees-cell" id="tuesday-employees"></div>
                <div class="employees-cell" id="wednesday-employees"></div>
                <div class="employees-cell" id="thursday-employees"></div>
                <div class="employees-cell" id="friday-employees"></div>
                <div class="employees-cell" id="saturday-employees"></div>
                <div class="employees-cell" id="sunday-employees"></div>
            </div>

            <div id="timeSlots"></div>

            <div class="daily-totals">
                <div class="total-cell total-label" style="font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px;">Total Jour</div>
                <div class="total-cell" id="monday-totals"></div>
                <div class="total-cell" id="tuesday-totals"></div>
                <div class="total-cell" id="wednesday-totals"></div>
                <div class="total-cell" id="thursday-totals"></div>
                <div class="total-cell" id="friday-totals"></div>
                <div class="total-cell" id="saturday-totals"></div>
                <div class="total-cell" id="sunday-totals"></div>
            </div>

            <div class="daily-totals" style="background: #20B077; min-height: 35px;">
                <div class="total-cell total-label" style="background: #20B077; font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px; display: flex; align-items: center; justify-content: center;">√âquipe</div>
                <div class="total-cell" id="monday-team-total">0h</div>
                <div class="total-cell" id="tuesday-team-total">0h</div>
                <div class="total-cell" id="wednesday-team-total">0h</div>
                <div class="total-cell" id="thursday-team-total">0h</div>
                <div class="total-cell" id="friday-team-total">0h</div>
                <div class="total-cell" id="saturday-team-total">0h</div>
                <div class="total-cell" id="sunday-team-total">0h</div>
            </div>
        </div>
    </div>

    <!-- Modal pour g√©rer les employ√©s -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2>G√©rer les Employ√©s</h2>
            <div id="employeeInputs"></div>
            <button class="btn btn-save" onclick="saveEmployees()">Sauvegarder les Noms</button>
        </div>
    </div>

    <!-- Modal pour dupliquer un planning -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDuplicateModal()">&times;</span>
            <h2>Dupliquer un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning source :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="sourceWeek" style="flex: 1;">
                    </select>
                    <select id="sourceYear" style="flex: 1;">
                    </select>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning destination :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="destWeek" style="flex: 1;">
                    </select>
                    <select id="destYear" style="flex: 1;">
                    </select>
                </div>
                
                <div id="duplicateInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
            </div>
            <button class="btn btn-save" onclick="duplicatePlanning()">Dupliquer le Planning</button>
        </div>
    </div>

    <!-- Modal pour r√©initialiser un planning -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h2>R√©initialiser un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Semaine √† r√©initialiser :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="resetWeek" style="flex: 1;">
                    </select>
                    <select id="resetYear" style="flex: 1;">
                    </select>
                </div>
                
                <div id="resetInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è Attention :</strong> Cette action supprimera d√©finitivement tous les plannings et fermetures de cette semaine. Cette action est irr√©versible.
                </div>
            </div>
            <button class="btn" style="background: #dc3545; color: white;" onclick="resetPlanning()">R√©initialiser le Planning</button>
        </div>
    </div>

    <script>
        // Configuration des cr√©neaux horaires
        const timeSlots = [
            { start: '07:00', end: '07:30', duration: 30 },
            { start: '07:30', end: '08:00', duration: 30 },
            { start: '08:00', end: '08:30', duration: 30 },
            { start: '08:30', end: '08:45', duration: 15 },
            { start: '08:45', end: '09:00', duration: 15 },
            { start: '09:00', end: '09:30', duration: 30 },
            { start: '09:30', end: '10:00', duration: 30 },
            { start: '10:00', end: '10:30', duration: 30 },
            { start: '10:30', end: '11:00', duration: 30 },
            { start: '11:00', end: '11:30', duration: 30 },
            { start: '11:30', end: '12:00', duration: 30 },
            { start: '12:00', end: '12:30', duration: 30 },
            { start: '12:30', end: '12:45', duration: 15 },
            { start: '12:45', end: '13:00', duration: 15 },
            { start: '13:00', end: '13:30', duration: 30 },
            { start: '13:30', end: '14:00', duration: 30 },
            { start: '14:00', end: '14:30', duration: 30 },
            { start: '14:30', end: '15:00', duration: 30 },
            { start: '15:00', end: '15:15', duration: 15 },
            { start: '15:15', end: '15:30', duration: 15 },
            { start: '15:30', end: '16:00', duration: 30 },
            { start: '16:00', end: '16:30', duration: 30 },
            { start: '16:30', end: '17:00', duration: 30 },
            { start: '17:00', end: '17:30', duration: 30 },
            { start: '17:30', end: '18:00', duration: 30 },
            { start: '18:00', end: '18:30', duration: 30 },
            { start: '18:30', end: '19:00', duration: 30 },
            { start: '19:00', end: '19:15', duration: 15 },
            { start: '19:15', end: '19:30', duration: 15 },
            { start: '19:30', end: '20:00', duration: 30 }
        ];

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        const now = new Date();
        let currentWeek = getWeekNumber(now);
        let currentYear = now.getFullYear();
        let employees = [
            { firstName: 'Antoine', lastName: '', email: '' },
            { firstName: 'L√©a', lastName: '', email: '' },
            { firstName: 'No√©mie', lastName: '', email: '' },
            { firstName: 'Christelle', lastName: '', email: '' },
            { firstName: 'Sandrine', lastName: '', email: '' }
        ];
        let schedules = {};
        let closures = {};

        let activeListeners = {};
        let isUpdatingFromFirebase = false;

        let isDragging = false;
        let dragStart = null;
        let dragStartState = null;
        let dragCurrentEmployee = null;
        let dragCurrentDay = null;

        const defaultGraySlots = ['13:00', '13:30', '14:00', '14:30'];
        const sundayGraySlots = ['13:00', '13:30', '14:00', '14:30', '15:00', '15:15', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:15', '19:30'];
        const defaultGreenSlots = ['08:30', '08:45', '12:30', '12:45', '15:00', '15:15'];
        const weekdayGreenSlots = ['19:00', '19:15'];

        // ==========================================
        // FONCTIONS D'AUTHENTIFICATION
        // ==========================================

        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                loadUserProfile(user.email);
            } else {
                currentUser = null;
                currentUserRole = null;
                currentUserIndex = null;
                showAuthInterface();
            }
        }

        async function loadUserProfile(email) {
            try {
                // D√©terminer le r√¥le et l'index bas√© sur l'email
                const employeeIndex = employees.findIndex(emp => emp.email === email);
                
                if (employeeIndex === -1) {
                    // Utilisateur non trouv√© dans les employ√©s
                    await logout();
                    showAuthError('Acc√®s non autoris√©. Contactez l\'administrateur.');
                    return;
                }

                currentUserIndex = employeeIndex;
                currentUserRole = (employeeIndex === 4) ? 'admin' : 'user'; // Index 4 = employ√© 5 = admin
                
                // V√©rifier les permissions pour les utilisateurs normaux
                if (currentUserRole === 'user') {
                    const hasAccess = await checkUserAccessToCurrentWeek();
                    if (!hasAccess) {
                        showAuthError('Vous n\'avez pas acc√®s √† ce planning (aucune heure assign√©e).');
                        return;
                    }
                }

                showMainInterface();
                
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                showAuthError('Erreur de chargement du profil.');
            }
        }

        async function checkUserAccessToCurrentWeek() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) return false;
            
            // V√©rifier si l'utilisateur a au moins une heure assign√©e
            for (const dayIndex in schedules[scheduleKey]) {
                for (const slotIndex in schedules[scheduleKey][dayIndex]) {
                    if (schedules[scheduleKey][dayIndex][slotIndex][currentUserIndex]) {
                        return true;
                    }
                }
            }
            return false;
        }

        function showAuthInterface() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainInterface() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Mettre √† jour l'interface utilisateur
            updateUserInterface();
            
            // Charger les donn√©es
            loadSchedulesFromFirebase();
            updateScheduleDisplay();
        }

        function updateUserInterface() {
            const userEmailEl = document.getElementById('userEmail');
            const userRoleEl = document.getElementById('userRole');
            const readonlyBanner = document.getElementById('readonlyBanner');
            const adminControls = document.getElementById('adminControls');
            const emailBtn = document.getElementById('emailBtn');

            if (currentUser && currentUserIndex !== null) {
                const employee = employees[currentUserIndex];
                userEmailEl.textContent = employee.firstName || currentUser.email;
                userRoleEl.textContent = currentUserRole === 'admin' ? 'ADMIN' : 'UTILISATEUR';
                userRoleEl.className = `user-role ${currentUserRole}`;

                if (currentUserRole === 'admin') {
                    readonlyBanner.classList.add('hidden');
                    adminControls.classList.remove('hidden');
                    emailBtn.classList.remove('hidden');
                    enableEditMode();
                } else {
                    readonlyBanner.classList.remove('hidden');
                    adminControls.classList.add('hidden');
                    emailBtn.classList.add('hidden');
                    enableReadOnlyMode();
                }
            }

            updateVersionDisplay();
        }

        function enableEditMode() {
            // Autoriser toutes les interactions
            document.querySelectorAll('.day-toggle, .time-slot').forEach(el => {
                el.style.pointerEvents = 'auto';
            });
        }

        function enableReadOnlyMode() {
            // D√©sactiver toutes les interactions d'√©dition
            document.querySelectorAll('.day-toggle, .time-slot').forEach(el => {
                el.style.pointerEvents = 'none';
            });
        }

        function updateVersionDisplay() {
            const versionEl = document.getElementById('versionText');
            const lastModified = new Date(planningVersion.lastModified);
            const formattedDate = lastModified.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: '2-digit' 
            });
            versionEl.textContent = `S${currentWeek}/${currentYear} - ${formattedDate} - v${planningVersion.version}`;
        }

        // Gestion du formulaire de connexion
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    await login(email, password);
                });
            }

            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetPassword();
                });
            }
        });

        async function login(email, password) {
            try {
                showAuthError('', false);
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Connexion...';

                const { signInWithEmailAndPassword } = window.authSDK;
                await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                
                // L'√©tat sera g√©r√© par onAuthStateChanged
                
            } catch (error) {
                console.error('Erreur de connexion:', error);
                let errorMessage = 'Erreur de connexion';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Email ou mot de passe incorrect';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Adresse email invalide';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Trop de tentatives. R√©essayez plus tard.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showAuthError(errorMessage);
                
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Se connecter';
            }
        }

        async function logout() {
            try {
                const { signOut } = window.authSDK;
                await signOut(window.firebaseAuth);
                
                // Nettoyer l'√©tat local
                currentUser = null;
                currentUserRole = null;
                currentUserIndex = null;
                
                // Nettoyer les listeners
                Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
                activeListeners = {};
                
                showAuthInterface();
                
            } catch (error) {
                console.error('Erreur de d√©connexion:', error);
            }
        }

        async function resetPassword() {
            const email = prompt('Entrez votre adresse email pour r√©initialiser le mot de passe:');
            if (!email) return;

            try {
                const { sendPasswordResetEmail } = window.authSDK;
                await sendPasswordResetEmail(window.firebaseAuth, email);
                showAuthSuccess('Email de r√©initialisation envoy√© !');
            } catch (error) {
                console.error('Erreur reset password:', error);
                showAuthError('Erreur lors de l\'envoi de l\'email de r√©initialisation');
            }
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            // Vider les champs
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Les nouveaux mots de passe ne correspondent pas');
                return;
            }

            if (newPassword.length < 6) {
                alert('Le nouveau mot de passe doit contenir au moins 6 caract√®res');
                return;
            }

            try {
                const { updatePassword, reauthenticateWithCredential, EmailAuthProvider } = window.authSDK;
                const user = currentUser;
                
                // R√©authentifier l'utilisateur
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                
                // Changer le mot de passe
                await updatePassword(user, newPassword);
                
                alert('Mot de passe chang√© avec succ√®s !');
                closePasswordModal();
                
            } catch (error) {
                console.error('Erreur changement mot de passe:', error);
                let errorMessage = 'Erreur lors du changement de mot de passe';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Mot de passe actuel incorrect';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Le nouveau mot de passe est trop faible';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        function showAuthError(message, show = true) {
            const errorEl = document.getElementById('authError');
            if (show && message) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            } else {
                errorEl.classList.add('hidden');
            }
        }

        function showAuthSuccess(message) {
            const successEl = document.getElementById('authSuccess');
            successEl.textContent = message;
            successEl.classList.remove('hidden');
            setTimeout(() => {
                successEl.classList.add('hidden');
            }, 3000);
        }

        // ==========================================
        // FONCTIONS DE VALIDATION ET VERSIONING
        // ==========================================

        async function validatePlanning() {
            if (currentUserRole !== 'admin') {
                alert('Seul l\'administrateur peut valider un planning.');
                return;
            }

            if (confirm(`Valider et envoyer le planning de la semaine ${currentWeek}/${currentYear} ?\n\nCeci enverra le planning par email √† tous les employ√©s concern√©s.`)) {
                try {
                    // Incr√©menter la version
                    const versionParts = planningVersion.version.split('.');
                    const majorVersion = parseInt(versionParts[0]);
                    const minorVersion = parseInt(versionParts[1]) + 1;
                    planningVersion.version = `${majorVersion}.${minorVersion}`;
                    planningVersion.lastModified = new Date().toISOString();

                    // Sauvegarder la version
                    await saveVersionToFirebase();

                    // Mettre √† jour l'affichage
                    updateVersionDisplay();

                    // Envoyer les notifications (impl√©mentation EmailJS √† venir)
                    await sendPlanningNotifications();

                    alert(`Planning valid√© et envoy√© ! Version: ${planningVersion.version}`);

                } catch (error) {
                    console.error('Erreur validation planning:', error);
                    alert('Erreur lors de la validation du planning.');
                }
            }
        }

        async function saveVersionToFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) return;

            try {
                const { doc, setDoc } = window.firestoreSDK;
                const versionKey = `${currentYear}-${currentWeek}`;
                
                await setDoc(doc(window.firestore, 'planning-data', `version-${versionKey}`), {
                    version: planningVersion.version,
                    lastModified: planningVersion.lastModified,
                    weekNumber: currentWeek,
                    year: currentYear
                });
                
            } catch (error) {
                console.error('Erreur sauvegarde version:', error);
            }
        }

        async function loadVersionFromFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) return;

            try {
                const { doc, getDoc } = window.firestoreSDK;
                const versionKey = `${currentYear}-${currentWeek}`;
                
                const versionDoc = await getDoc(doc(window.firestore, 'planning-data', `version-${versionKey}`));
                if (versionDoc.exists()) {
                    const data = versionDoc.data();
                    planningVersion = {
                        version: data.version || '1.0',
                        lastModified: data.lastModified || new Date().toISOString()
                    };
                } else {
                    planningVersion = { version: '1.0', lastModified: new Date().toISOString() };
                }
                
                updateVersionDisplay();
                
            } catch (error) {
                console.error('Erreur chargement version:', error);
                planningVersion = { version: '1.0', lastModified: new Date().toISOString() };
                updateVersionDisplay();
            }
        }

        async function sendPlanningNotifications() {
            // TODO: Impl√©menter EmailJS pour l'envoi d'emails
            // Cette fonction sera impl√©ment√©e dans la prochaine √©tape
            console.log('Envoi des notifications de planning...');
            
            // Simulation temporaire
            return new Promise(resolve => {
                setTimeout(() => {
                    console.log('Notifications envoy√©es (simulation)');
                    resolve();
                }, 1000);
            });
        }

        // Exposer les fonctions globalement pour Firebase
        window.handleAuthStateChange = handleAuthStateChange;

        function toggleDayClosure(dayIndex) {
            // V√©rifier les permissions
            if (currentUserRole !== 'admin') {
                return; // Mode lecture seule
            }

            // V√©rification des permissions avec debug
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings pass√©s ne peuvent pas √™tre modifi√©s.');
                return;
            }
            
            const closureKey = `${currentYear}-${currentWeek}`;
            if (!closures[closureKey]) closures[closureKey] = {};
            
            const currentState = closures[closureKey][dayIndex] || 'open';
            let nextState;
            
            switch(currentState) {
                case 'open':
                    nextState = 'closed';
                    break;
                case 'closed':
                    nextState = 'am-closed';
                    break;
                case 'am-closed':
                    nextState = 'pm-closed';
                    break;
                case 'pm-closed':
                    nextState = 'open';
                    break;
                default:
                    nextState = 'open';
            }
            
            closures[closureKey][dayIndex] = nextState;
            updateClosureDisplay();
            
            if (!isUpdatingFromFirebase) {
                saveSchedulesToFirebase();
            }
        }

        function updateClosureDisplay() {
            const closureKey = `${currentYear}-${currentWeek}`;
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((day, dayIndex) => {
                const toggle = document.querySelector(`[data-day="${dayIndex}"]`);
                const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
                
                toggle.className = `day-toggle ${state}`;
                
                switch(state) {
                    case 'open':
                        toggle.textContent = '‚úì';
                        toggle.title = `Ouvrir/Fermer ${getDayName(dayIndex)}`;
                        break;
                    case 'closed':
                        toggle.textContent = '‚úó';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© toute la journ√©e`;
                        break;
                    case 'am-closed':
                        toggle.textContent = 'AM';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© le matin`;
                        break;
                    case 'pm-closed':
                        toggle.textContent = 'PM';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© l'apr√®s-midi`;
                        break;
                }
                
                updateRowsVisual(dayIndex, state);
            });
        }

        function updateRowsVisual(dayIndex, state) {
            document.querySelectorAll('.time-row').forEach(row => {
                const cells = row.querySelectorAll('.schedule-cell');
                if (cells[dayIndex]) {
                    cells[dayIndex].classList.remove('closed', 'establishment-closed');
                    cells[dayIndex].style.position = 'relative';
                    const existingText = cells[dayIndex].querySelector('.closed-text');
                    if (existingText) {
                        existingText.remove();
                    }
                }
                row.classList.remove('closed');
            });
            
            if (state === 'closed') {
                document.querySelectorAll('.time-row').forEach(row => {
                    const cells = row.querySelectorAll('.schedule-cell');
                    if (cells[dayIndex]) {
                        cells[dayIndex].classList.add('establishment-closed');
                    }
                });
            } else if (state === 'am-closed') {
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 7 && hour < 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            } else if (state === 'pm-closed') {
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            }
        }

        function getDayName(dayIndex) {
            const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
            return days[dayIndex];
        }

        function isSlotClosed(dayIndex, slotIndex) {
            const closureKey = `${currentYear}-${currentWeek}`;
            const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
            
            if (state === 'closed') return true;
            if (state === 'open') return false;
            
            const hour = parseInt(timeSlots[slotIndex].start.split(':')[0]);
            if (state === 'am-closed' && hour >= 7 && hour < 13) return true;
            if (state === 'pm-closed' && hour >= 13) return true;
            
            return false;
        }

        function changeWeek(direction) {
            const newWeek = currentWeek + direction;
            
            if (newWeek >= 1 && newWeek <= 53) {
                currentWeek = newWeek;
                document.getElementById('weekSelect').value = currentWeek;
                updateScheduleDisplay();
            } else if (newWeek === 0) {
                if (currentYear > 2024) {
                    currentYear--;
                    currentWeek = 53;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            } else if (newWeek === 54) {
                if (currentYear < 2030) {
                    currentYear++;
                    currentWeek = 1;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            }
        }

        window.initializeApp = function() {
            populateSelectors();
            loadEmployees();
            loadSchedulesFromFirebase();
            updateScheduleDisplay();
        };

        async function saveSchedulesToFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                console.log('Firebase pas encore pr√™t, sauvegarde ignor√©e');
                return false;
            }

            try {
                const { doc, setDoc } = window.firestoreSDK;
                
                await setDoc(doc(window.firestore, 'planning-data', 'employees'), {
                    employees: employees,
                    lastUpdated: new Date().toISOString()
                });

                for (const [key, schedule] of Object.entries(schedules)) {
                    await setDoc(doc(window.firestore, 'planning-data', `schedule-${key}`), {
                        schedule: schedule,
                        lastUpdated: new Date().toISOString()
                    });
                }

                for (const [key, closure] of Object.entries(closures)) {
                    await setDoc(doc(window.firestore, 'planning-data', `closure-${key}`), {
                        closure: closure,
                        lastUpdated: new Date().toISOString()
                    });
                }

                console.log('Donn√©es sauvegard√©es sur Firebase');
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                return false;
            }
        }

        async function loadSchedulesFromFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                console.log('Firebase pas encore pr√™t, chargement par d√©faut');
                loadEmployees();
                return;
            }

            try {
                const { doc, getDoc, collection, getDocs } = window.firestoreSDK;
                
                const employeesDoc = await getDoc(doc(window.firestore, 'planning-data', 'employees'));
                if (employeesDoc.exists()) {
                    employees = employeesDoc.data().employees || employees;
                }

                const planningCollection = collection(window.firestore, 'planning-data');
                const snapshot = await getDocs(planningCollection);
                
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id;
                    
                    if (docId.startsWith('schedule-')) {
                        const key = docId.replace('schedule-', '');
                        schedules[key] = data.schedule;
                    } else if (docId.startsWith('closure-')) {
                        const key = docId.replace('closure-', '');
                        closures[key] = data.closure;
                    }
                });

                console.log('Donn√©es charg√©es depuis Firebase');
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                loadEmployees();
            }
        }

        function setupRealtimeListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;

            Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
            activeListeners = {};

            activeListeners.employees = onSnapshot(
                doc(window.firestore, 'planning-data', 'employees'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newEmployees = docSnapshot.data().employees;
                        if (JSON.stringify(newEmployees) !== JSON.stringify(employees)) {
                            isUpdatingFromFirebase = true;
                            employees = newEmployees;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log('üîÑ Employ√©s mis √† jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener employ√©s:', error)
            );

            setupCurrentWeekListeners();
        }

        function setupCurrentWeekListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;
            const currentKey = `${currentYear}-${currentWeek}`;

            if (activeListeners.currentSchedule) {
                activeListeners.currentSchedule();
                delete activeListeners.currentSchedule;
            }
            if (activeListeners.currentClosure) {
                activeListeners.currentClosure();
                delete activeListeners.currentClosure;
            }

            activeListeners.currentSchedule = onSnapshot(
                doc(window.firestore, 'planning-data', `schedule-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newSchedule = docSnapshot.data().schedule;
                        if (JSON.stringify(newSchedule) !== JSON.stringify(schedules[currentKey])) {
                            isUpdatingFromFirebase = true;
                            schedules[currentKey] = newSchedule;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üîÑ Planning semaine ${currentKey} mis √† jour depuis Firebase`);
                        }
                    } else {
                        if (schedules[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete schedules[currentKey];
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üóëÔ∏è Planning semaine ${currentKey} supprim√©`);
                        }
                    }
                },
                (error) => console.error('Erreur listener planning:', error)
            );

            activeListeners.currentClosure = onSnapshot(
                doc(window.firestore, 'planning-data', `closure-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newClosure = docSnapshot.data().closure;
                        if (JSON.stringify(newClosure) !== JSON.stringify(closures[currentKey])) {
                            isUpdatingFromFirebase = true;
                            closures[currentKey] = newClosure;
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üîÑ Fermetures semaine ${currentKey} mises √† jour depuis Firebase`);
                        }
                    } else {
                        if (closures[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete closures[currentKey];
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üóëÔ∏è Fermetures semaine ${currentKey} supprim√©es`);
                        }
                    }
                },
                (error) => console.error('Erreur listener fermetures:', error)
            );
        }

        function populateSelectors() {
            const weekSelect = document.getElementById('weekSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                weekSelect.appendChild(option);
            }
            
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            weekSelect.addEventListener('change', (e) => {
                currentWeek = parseInt(e.target.value);
                updateScheduleDisplay();
            });
            
            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                updateScheduleDisplay();
            });
        }

        function loadEmployees() {
            if (employees.length !== 5) {
                employees = [
                    { firstName: 'Antoine', lastName: '', email: '' },
                    { firstName: 'L√©a', lastName: '', email: '' },
                    { firstName: 'No√©mie', lastName: '', email: '' },
                    { firstName: 'Christelle', lastName: '', email: '' },
                    { firstName: 'Sandrine', lastName: '', email: '' }
                ];
            }
            if (typeof employees[0] === 'string') {
                employees = employees.map(name => ({
                    firstName: name,
                    lastName: '',
                    email: ''
                }));
            }
        }

        function getWeekDates(year, week) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            
            const firstMondayOfYear = new Date(jan4);
            firstMondayOfYear.setDate(jan4.getDate() - jan4Day + 1);
            
            const mondayOfWeek = new Date(firstMondayOfYear);
            mondayOfWeek.setDate(firstMondayOfYear.getDate() + (week - 1) * 7);
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(mondayOfWeek);
                date.setDate(mondayOfWeek.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        function updateScheduleDisplay() {
            // V√©rifier les permissions pour les utilisateurs
            if (currentUserRole === 'user') {
                checkUserAccessToCurrentWeek().then(hasAccess => {
                    if (!hasAccess) {
                        alert('Vous n\'avez pas acc√®s √† cette semaine (aucune heure assign√©e).');
                        // Retourner √† une semaine o√π l'utilisateur a acc√®s
                        findAccessibleWeek();
                        return;
                    }
                    continueUpdateScheduleDisplay();
                });
            } else {
                continueUpdateScheduleDisplay();
            }
        }

        function continueUpdateScheduleDisplay() {
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Update dates in headers
            days.forEach((day, index) => {
                document.getElementById(`${day}-date`).textContent = formatDate(dates[index]);
            });
            
            // Update employee names in each day
            days.forEach(day => {
                const container = document.getElementById(`${day}-employees`);
                container.innerHTML = '';
                employees.forEach(employee => {
                    const label = document.createElement('div');
                    label.className = 'employee-label';
                    label.textContent = employee.firstName || 'Employ√©';
                    container.appendChild(label);
                });
            });
            
            // Generate time slots
            generateTimeSlots();
            updateSummary();
            updateClosureDisplay();
            
            // Charger la version pour cette semaine
            loadVersionFromFirebase();
            
            // Mettre √† jour les listeners pour la nouvelle semaine (seulement si pas de mise √† jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                setupCurrentWeekListeners();
            }
        }

        async function findAccessibleWeek() {
            // Chercher une semaine o√π l'utilisateur a acc√®s (logique simple)
            // Pour l'instant, retourner √† la semaine courante
            const now = new Date();
            currentWeek = getWeekNumber(now);
            currentYear = now.getFullYear();
            document.getElementById('weekSelect').value = currentWeek;
            document.getElementById('yearSelect').value = currentYear;
            updateScheduleDisplay();
        }

        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            timeSlots.forEach((slot, slotIndex) => {
                const row = document.createElement('div');
                row.className = 'time-row';
                
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                timeCell.textContent = `${slot.start}-${slot.end}`;
                row.appendChild(timeCell);
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, dayIndex) => {
                    const scheduleCell = document.createElement('div');
                    scheduleCell.className = 'schedule-cell';
                    
                    employees.forEach((employee, empIndex) => {
                        const timeSlotDiv = document.createElement('div');
                        timeSlotDiv.className = 'time-slot';
                        timeSlotDiv.dataset.day = dayIndex;
                        timeSlotDiv.dataset.slot = slotIndex;
                        timeSlotDiv.dataset.employee = empIndex;
                        
                        const defaultClass = getDefaultClass(slot.start, dayIndex);
                        if (defaultClass) {
                            timeSlotDiv.classList.add(defaultClass);
                        }
                        
                        const scheduleKey = `${currentYear}-${currentWeek}`;
                        if (schedules[scheduleKey] && schedules[scheduleKey][dayIndex] && schedules[scheduleKey][dayIndex][slotIndex] && schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            timeSlotDiv.className = 'time-slot employee-' + (empIndex + 1);
                        }
                        
                        timeSlotDiv.addEventListener('mousedown', (e) => startDrag(e, timeSlotDiv, dayIndex, slotIndex, empIndex));
                        timeSlotDiv.addEventListener('mouseenter', (e) => updateDrag(timeSlotDiv, dayIndex, slotIndex, empIndex));
                        timeSlotDiv.addEventListener('click', (e) => {
                            if (!isDragging) {
                                toggleTimeSlot(timeSlotDiv, dayIndex, slotIndex, empIndex);
                            }
                        });
                        
                        scheduleCell.appendChild(timeSlotDiv);
                    });
                    
                    row.appendChild(scheduleCell);
                });
                
                container.appendChild(row);
            });
        }

        function startDrag(e, element, dayIndex, slotIndex, empIndex) {
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings pass√©s ne peuvent pas √™tre modifi√©s.');
                return;
            }
            
            e.preventDefault();
            isDragging = true;
            dragStart = { dayIndex, slotIndex, empIndex };
            dragCurrentEmployee = empIndex;
            dragCurrentDay = dayIndex;
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            dragStartState = !!(schedules[scheduleKey] && 
                              schedules[scheduleKey][dayIndex] && 
                              schedules[scheduleKey][dayIndex][slotIndex] && 
                              schedules[scheduleKey][dayIndex][slotIndex][empIndex]);
        }

        function updateDrag(element, dayIndex, slotIndex, empIndex) {
            if (!isDragging) return;
            
            clearDragPreview();
            
            if (empIndex !== dragCurrentEmployee || dayIndex !== dragCurrentDay) {
                element.classList.add('drag-invalid');
                return;
            }
            
            const startSlot = Math.min(dragStart.slotIndex, slotIndex);
            const endSlot = Math.max(dragStart.slotIndex, slotIndex);
            
            for (let slot = startSlot; slot <= endSlot; slot++) {
                const targetElement = document.querySelector(`[data-day="${dayIndex}"][data-slot="${slot}"][data-employee="${empIndex}"]`);
                if (targetElement) {
                    targetElement.classList.add('drag-preview');
                }
            }
        }

        function clearDragPreview() {
            document.querySelectorAll('.drag-preview, .drag-invalid').forEach(el => {
                el.classList.remove('drag-preview', 'drag-invalid');
            });
        }

        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                const previewElements = document.querySelectorAll('.drag-preview');
                const invalidElements = document.querySelectorAll('.drag-invalid');
                
                if (previewElements.length > 0 && invalidElements.length === 0) {
                    const scheduleKey = `${currentYear}-${currentWeek}`;
                    if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
                    if (!schedules[scheduleKey][dragCurrentDay]) schedules[scheduleKey][dragCurrentDay] = {};
                    
                    previewElements.forEach(element => {
                        const slotIndex = parseInt(element.dataset.slot);
                        const empIndex = parseInt(element.dataset.employee);
                        
                        if (!schedules[scheduleKey][dragCurrentDay][slotIndex]) {
                            schedules[scheduleKey][dragCurrentDay][slotIndex] = {};
                        }
                        
                        schedules[scheduleKey][dragCurrentDay][slotIndex][empIndex] = !dragStartState;
                        
                        if (!dragStartState) {
                            element.className = `time-slot employee-${empIndex + 1}`;
                        } else {
                            element.className = 'time-slot';
                            const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dragCurrentDay);
                            if (defaultClass) {
                                element.classList.add(defaultClass);
                            }
                        }
                    });
                    
                    updateSummary();
                    
                    if (!isUpdatingFromFirebase) {
                        saveSchedulesToFirebase();
                    }
                }
                
                clearDragPreview();
                isDragging = false;
                dragStart = null;
                dragStartState = null;
                dragCurrentEmployee = null;
                dragCurrentDay = null;
            }
        });

        function getDefaultClass(timeStart, dayIndex) {
            if (defaultGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            if (dayIndex === 6 && sundayGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            if (defaultGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            
            if (dayIndex < 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            
            if (dayIndex === 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-gray';
            }
            
            return null;
        }

        function toggleTimeSlot(element, dayIndex, slotIndex, empIndex) {
            // V√©rifier les permissions
            if (currentUserRole !== 'admin') {
                return; // Mode lecture seule
            }

            // V√©rifier si le cr√©neau est ferm√©
            if (isSlotClosed(dayIndex, slotIndex)) {
                alert('Impossible d\'assigner du personnel : √©tablissement ferm√© sur ce cr√©neau.');
                return;
            }
            
            // V√©rification des permissions avec debug
            const { currentWeekNumber, currentYearNumber } = getCurrentWeekInfo();
            
            if (currentYear < currentYearNumber || (currentYear === currentYearNumber && currentWeek < currentWeekNumber)) {
                alert('Les plannings pass√©s ne peuvent pas √™tre modifi√©s.');
                return;
            }
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
            if (!schedules[scheduleKey][dayIndex]) schedules[scheduleKey][dayIndex] = {};
            if (!schedules[scheduleKey][dayIndex][slotIndex]) schedules[scheduleKey][dayIndex][slotIndex] = {};
            
            // Toggle state
            const isActive = schedules[scheduleKey][dayIndex][slotIndex][empIndex];
            schedules[scheduleKey][dayIndex][slotIndex][empIndex] = !isActive;
            
            // Update visual
            if (schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                element.className = 'time-slot employee-' + (empIndex + 1);
            } else {
                element.className = 'time-slot';
                const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dayIndex);
                if (defaultClass) {
                    element.classList.add(defaultClass);
                }
            }
            
            updateSummary();
            
            // Auto-sauvegarde sur Firebase (seulement si pas de mise √† jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                saveSchedulesToFirebase();
            }
        }

        function getCurrentWeekInfo() {
            const now = new Date();
            const currentWeekNumber = getWeekNumber(now);
            const currentYearNumber = now.getFullYear();
            
            return { currentWeekNumber, currentYearNumber };
        }

        function updateSummary() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const employeeTotals = [0, 0, 0, 0, 0];
            const dailyTotals = [0, 0, 0, 0, 0, 0, 0];
            
            employees.forEach((employee, empIndex) => {
                let totalMinutes = 0;
                
                days.forEach((day, dayIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    dailyTotals[dayIndex] += dailyMinutes;
                });
                
                employeeTotals[empIndex] = totalMinutes;
                
                const card = document.createElement('div');
                card.className = 'employee-summary';
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hoursDisplay = `${hours}h${minutes.toString().padStart(2, '0')}`;
                
                const remaining = (35 * 60) - totalMinutes;
                const remainingHours = Math.floor(Math.abs(remaining) / 60);
                const remainingMinutes = Math.abs(remaining) % 60;
                const remainingDisplay = `${remaining < 0 ? '-' : ''}${remainingHours}h${remainingMinutes.toString().padStart(2, '0')}`;
                
                if (totalMinutes === 0) {
                    card.classList.add('hours-zero');
                } else if (totalMinutes === 35 * 60) {
                    card.classList.add('hours-complete');
                    setTimeout(() => {
                        card.classList.add('flash');
                    }, 50);
                } else {
                    card.classList.add('hours-partial');
                }
                
                card.innerHTML = `
                    <div class="employee-name">${employee.firstName || 'Employ√©'}</div>
                    <div class="hours-total">${hoursDisplay} hebdo</div>
                    <div class="hours-remaining ${remaining < 0 ? 'hours-negative' : ''}">(reste ${remainingDisplay} √† r√©partir)</div>
                `;
                summaryGrid.appendChild(card);
            });
            
            days.forEach((day, dayIndex) => {
                const container = document.getElementById(`${day}-totals`);
                container.innerHTML = '';
                
                const totalsDiv = document.createElement('div');
                totalsDiv.className = 'daily-employee-totals';
                
                employees.forEach((employee, empIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    const hours = Math.floor(dailyMinutes / 60);
                    const minutes = dailyMinutes % 60;
                    const display = `${hours}h${minutes.toString().padStart(2, '0')}`;
                    
                    const empTotal = document.createElement('div');
                    empTotal.textContent = display;
                    totalsDiv.appendChild(empTotal);
                });
                
                container.appendChild(totalsDiv);
                
                const teamHours = Math.floor(dailyTotals[dayIndex] / 60);
                const teamMinutes = dailyTotals[dayIndex] % 60;
                const teamElement = document.getElementById(`${day}-team-total`);
                teamElement.textContent = `${teamHours}h${teamMinutes.toString().padStart(2, '0')}`;
                teamElement.style.fontSize = '10px';
            });
        }

        function openEmployeeModal() {
            const modal = document.getElementById('employeeModal');
            const inputs = document.getElementById('employeeInputs');
            inputs.innerHTML = '';
            
            employees.forEach((employee, index) => {
                const group = document.createElement('div');
                group.className = 'employee-form-group';
                
                group.innerHTML = `
                    <div class="form-row">
                        <div class="employee-title">Employ√© ${index + 1}</div>
                        <input type="text" class="employee-input" value="${employee.firstName}" 
                               placeholder="Pr√©nom" id="employee-firstName-${index}" 
                               oninput="formatFirstName(this)">
                        <input type="text" class="employee-input" value="${employee.lastName}" 
                               placeholder="Nom" id="employee-lastName-${index}" 
                               oninput="formatLastName(this)">
                        <input type="email" class="employee-input" value="${employee.email}" 
                               placeholder="Email" id="employee-email-${index}" 
                               oninput="formatEmail(this)">
                        <button type="button" class="clear-employee-btn" onclick="clearEmployee(${index})" 
                                title="Effacer toutes les donn√©es">‚úó</button>
                    </div>
                `;
                
                inputs.appendChild(group);
            });
            
            modal.style.display = 'block';
        }

        function clearEmployee(index) {
            if (confirm(`√ätes-vous s√ªr de vouloir effacer toutes les donn√©es de l'employ√© ${index + 1} ?`)) {
                document.getElementById(`employee-firstName-${index}`).value = '';
                document.getElementById(`employee-lastName-${index}`).value = '';
                document.getElementById(`employee-email-${index}`).value = '';
            }
        }

        function formatFirstName(input) {
            let value = input.value;
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                input.value = value;
            }
        }

        function formatLastName(input) {
            input.value = input.value.toUpperCase();
        }

        function formatEmail(input) {
            input.value = input.value.toLowerCase();
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        function saveEmployees() {
            // V√©rifier les permissions
            if (currentUserRole !== 'admin') {
                alert('Seul l\'administrateur peut modifier les employ√©s.');
                return;
            }

            const newEmployees = [];
            for (let i = 0; i < 5; i++) {
                const firstName = document.getElementById(`employee-firstName-${i}`).value || '';
                const lastName = document.getElementById(`employee-lastName-${i}`).value || '';
                const email = document.getElementById(`employee-email-${i}`).value || '';
                
                // Forcer l'admin pour l'employ√© #5
                if (i === 4) {
                    newEmployees.push({
                        firstName: firstName || 'Sandrine',
                        lastName: lastName || 'LATILLE',
                        email: 'latilledistribution@gmail.com'
                    });
                } else {
                    newEmployees.push({
                        firstName: firstName,
                        lastName: lastName,
                        email: email
                    });
                }
            }
            
            employees = newEmployees;
            updateScheduleDisplay();
            closeEmployeeModal();
            
            // Sauvegarder sur Firebase
            saveSchedulesToFirebase().then(success => {
                if (success) {
                    alert('Informations des employ√©s sauvegard√©es !');
                    
                    // Proposer d'envoyer des invitations pour les nouveaux emails
                    const employeesWithEmail = employees.filter((emp, index) => 
                        index < 4 && emp.email && emp.email.trim() !== ''
                    );
                    
                    if (employeesWithEmail.length > 0) {
                        const sendInvitations = confirm(
                            `Voulez-vous cr√©er les comptes et envoyer des invitations aux employ√©s ?\n\n` +
                            employeesWithEmail.map(emp => `‚Ä¢ ${emp.firstName} (${emp.email})`).join('\n') +
                            `\n\n‚ö†Ô∏è Les comptes seront cr√©√©s avec des mots de passe temporaires.`
                        );
                        
                        if (sendInvitations) {
                            // V√©rifier la configuration EmailJS
                            if (!checkEmailJSConfiguration()) {
                                showEmailJSSetupInstructions();
                            }
                            
                            sendEmployeeInvitations(employeesWithEmail);
                        }
                    }
                } else {
                    alert('Informations sauvegard√©es localement (erreur Firebase)');
                }
            });
        }

        async function sendEmployeeInvitations(employeesWithEmail) {
            try {
                const { createUserWithEmailAndPassword } = window.authSDK;
                const invitationResults = [];

                for (const employee of employeesWithEmail) {
                    try {
                        // G√©n√©rer un mot de passe temporaire
                        const tempPassword = generateTempPassword();
                        
                        // Cr√©er le compte dans Firebase Auth
                        const userCredential = await createUserWithEmailAndPassword(
                            window.firebaseAuth, 
                            employee.email, 
                            tempPassword
                        );
                        
                        console.log(`Compte cr√©√© pour ${employee.firstName}`);
                        
                        // Envoyer l'email d'invitation
                        await sendInvitationEmail(employee, tempPassword);
                        
                        invitationResults.push({
                            name: employee.firstName,
                            email: employee.email,
                            success: true
                        });
                        
                    } catch (error) {
                        console.error(`Erreur pour ${employee.firstName}:`, error);
                        
                        // Si le compte existe d√©j√†, juste envoyer l'email de rappel
                        if (error.code === 'auth/email-already-in-use') {
                            await sendReminderEmail(employee);
                            invitationResults.push({
                                name: employee.firstName,
                                email: employee.email,
                                success: true,
                                existing: true
                            });
                        } else {
                            invitationResults.push({
                                name: employee.firstName,
                                email: employee.email,
                                success: false,
                                error: error.message
                            });
                        }
                    }
                }
                
                // Afficher le r√©sum√©
                showInvitationResults(invitationResults);
                
            } catch (error) {
                console.error('Erreur g√©n√©rale envoi invitations:', error);
                alert('Erreur lors de l\'envoi des invitations. V√©rifiez la configuration EmailJS.');
            }
        }

        function generateTempPassword() {
            // G√©n√©rer un mot de passe temporaire s√©curis√©
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        async function sendInvitationEmail(employee, tempPassword) {
            if (typeof emailjs === 'undefined') {
                console.log(`[SIMULATION] Email d'invitation envoy√© √† ${employee.firstName} (${employee.email})`);
                console.log(`[SIMULATION] Mot de passe temporaire: ${tempPassword}`);
                return;
            }

            const templateParams = {
                to_name: employee.firstName,
                to_email: employee.email,
                temp_password: tempPassword,
                login_url: window.location.origin + window.location.pathname,
                admin_email: 'latilledistribution@gmail.com'
            };

            try {
                await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.templateId,
                    templateParams
                );
                console.log(`Email d'invitation envoy√© √† ${employee.firstName}`);
            } catch (error) {
                console.error(`Erreur envoi email √† ${employee.firstName}:`, error);
                throw error;
            }
        }

        async function sendReminderEmail(employee) {
            if (typeof emailjs === 'undefined') {
                console.log(`[SIMULATION] Email de rappel envoy√© √† ${employee.firstName} (${employee.email})`);
                return;
            }

            const templateParams = {
                to_name: employee.firstName,
                to_email: employee.email,
                login_url: window.location.origin + window.location.pathname,
                admin_email: 'latilledistribution@gmail.com',
                is_reminder: true
            };

            try {
                await emailjs.send(
                    emailjsConfig.serviceId,
                    'template_reminder', // Template diff√©rent pour les rappels
                    templateParams
                );
                console.log(`Email de rappel envoy√© √† ${employee.firstName}`);
            } catch (error) {
                console.error(`Erreur envoi rappel √† ${employee.firstName}:`, error);
                throw error;
            }
        }

        function showInvitationResults(results) {
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            let message = `R√©sultats des invitations (${successCount}/${totalCount}):\n\n`;
            
            results.forEach(result => {
                if (result.success) {
                    if (result.existing) {
                        message += `‚úì ${result.name} (${result.email}) - Rappel envoy√©\n`;
                    } else {
                        message += `‚úì ${result.name} (${result.email}) - Compte cr√©√© et invitation envoy√©e\n`;
                    }
                } else {
                    message += `‚úó ${result.name} (${result.email}) - Erreur: ${result.error}\n`;
                }
            });
            
            if (successCount === totalCount) {
                message += `\nüéâ Toutes les invitations ont √©t√© envoy√©es avec succ√®s !`;
            } else if (successCount > 0) {
                message += `\n‚ö†Ô∏è ${totalCount - successCount} invitation(s) ont √©chou√©.`;
            } else {
                message += `\n‚ùå Aucune invitation n'a pu √™tre envoy√©e. V√©rifiez la configuration EmailJS.`;
            }
            
            alert(message);
        }

        // ==========================================
        // CONFIGURATION EMAILJS - INSTRUCTIONS
        // ==========================================

        function checkEmailJSConfiguration() {
            if (typeof emailjs === 'undefined') {
                console.warn('EmailJS non charg√© - Mode simulation activ√©');
                return false;
            }

            if (emailjsConfig.publicKey === 'votre_public_key') {
                console.warn('EmailJS non configur√© - Mode simulation activ√©');
                return false;
            }

            return true;
        }

        function showEmailJSSetupInstructions() {
            const instructions = `
üîß CONFIGURATION EMAILJS REQUISE

Pour envoyer de vrais emails, suivez ces √©tapes :

1. Cr√©ez un compte gratuit sur https://emailjs.com
2. Cr√©ez un service email (Gmail, Outlook, etc.)
3. Cr√©ez un template d'invitation avec ces variables :
   - {{to_name}} : Pr√©nom de l'employ√©
   - {{to_email}} : Email de l'employ√©  
   - {{temp_password}} : Mot de passe temporaire
   - {{login_url}} : URL de connexion
   - {{admin_email}} : Email admin

4. Remplacez dans le code :
   - serviceId: 'votre_service_id'
   - templateId: 'votre_template_id'
   - publicKey: 'votre_public_key'

En attendant, le mode simulation est activ√© (voir console).
            `;
            
            console.log(instructions);
            alert('Configuration EmailJS requise pour envoyer de vrais emails.\nVoir la console pour les instructions d√©taill√©es.');
        }

        function loadSchedules() {
            loadSchedulesFromFirebase().then(() => {
                updateScheduleDisplay();
                alert('Donn√©es recharg√©es depuis Firebase !');
            });
        }

        function openPrintableVersion() {
            const printHTML = generatePrintableHTML();
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.focus();
        }

        function generatePrintableHTML() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const dates = getWeekDates(currentYear, currentWeek);
            const firstDate = dates[0].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const lastDate = dates[6].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            let html = `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Semaine ${currentWeek} - ${currentYear}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: black;
            padding: 10mm;
        }

        @page {
            size: A4 landscape;
            margin: 8mm;
        }

        @media print {
            body { padding: 0; }
            .no-print { display: none; }
        }

        .header {
            text-align: center;
            margin-bottom: 8px;
        }

        .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .subtitle {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .planning-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 8px;
            table-layout: fixed;
        }

        .planning-table th,
        .planning-table td {
            border: 1px solid #95a5a6;
            padding: 1px;
            text-align: center;
            vertical-align: middle;
            height: 15px;
        }

        .time-col {
            width: 70px;
            background: #f8f9fa;
            font-weight: bold;
            font-size: 7px;
            padding: 1px;
            word-wrap: break-word;
        }

        .employee-col {
            width: 30px;
        }

        .day-separator {
            border-right: 3px solid #2c3e50 !important;
            position: relative;
        }

        .day-separator::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: transparent;
        }

        .day-header {
            background: #1a252f;
            color: white;
            font-weight: bold;
            font-size: 9px;
            padding: 3px 2px;
            height: 30px;
        }

        .employee-header {
            background: #ecf0f1;
            font-weight: bold;
            height: 38px;
            position: relative;
        }

        .employee-name {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-size: 8px;
            font-weight: bold;
            height: 35px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .time-slot {
            height: 14px;
            position: relative;
        }

        .assigned {
            font-weight: bold;
            color: white;
            font-size: 11px;
        }

        .closed {
            background: repeating-linear-gradient(
                45deg,
                #cccccc,
                #cccccc 3px,
                #999999 3px,
                #999999 6px
            );
            color: #666;
            font-style: italic;
            font-size: 6px;
        }

        .employee-1 { background: #e74c3c; color: white; }
        .employee-2 { background: #3498db; color: white; }
        .employee-3 { background: #f39c12; color: white; }
        .employee-4 { background: #9b59b6; color: white; }
        .employee-5 { background: #f1c40f; color: black; }

        .default-gray { background: #95a5a6; }
        .default-green { background: #a8d8a8; }

        .planning-table tr:nth-child(even) .time-slot:not(.assigned):not(.closed):not(.default-gray):not(.default-green) {
            background: #f7f7f7;
        }

        .total-row {
            background: #12BBFD;
            color: white;
            font-weight: bold;
            font-size: 7px;
            height: 20px;
        }

        .team-total-row {
            background: #20B077;
            color: white;
            font-weight: bold;
            font-size: 8px;
            height: 20px;
        }

        .print-buttons {
            text-align: center;
            margin: 10px 0;
        }

        .print-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }

        .print-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="no-print print-buttons">
        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
        <button class="print-btn" onclick="window.close()">‚ùå Fermer</button>
    </div>

    <div class="header">
        <div class="title">GESTION PLANNING SPAR LATILLE</div>
        <div class="subtitle">Semaine ${currentWeek} - Du ${firstDate} au ${lastDate}</div>
    </div>

    <table class="planning-table">
        <tr>
            <th class="time-col">Horaires</th>`;

            const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            dayNames.forEach((dayName, dayIndex) => {
                const dateStr = dates[dayIndex].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                html += `<th colspan="5" class="day-header">${dayName}<br>${dateStr}</th>`;
            });

            html += `
        </tr>
        
        <tr>
            <td class="time-col employee-header">Employ√©s</td>`;

            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                employees.forEach((employee, empIndex) => {
                    const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                    const separatorClass = isLastEmployeeOfDay ? ' day-separator' : '';
                    
                    html += `<td class="employee-col employee-header${separatorClass}">
                        <div class="employee-name">${employee.firstName || 'E'}</div>
                    </td>`;
                });
            }

            html += `
        </tr>`;

            timeSlots.forEach((slot, slotIndex) => {
                html += `
        <tr>
            <td class="time-col">${slot.start}-${slot.end}</td>`;

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    employees.forEach((employee, empIndex) => {
                        let cellClass = 'time-slot';
                        let cellContent = '';

                        if (isSlotClosed(dayIndex, slotIndex)) {
                            cellClass += ' closed';
                            cellContent = 'FERM√â';
                        } else {
                            if (schedules[scheduleKey] && 
                                schedules[scheduleKey][dayIndex] && 
                                schedules[scheduleKey][dayIndex][slotIndex] && 
                                schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                                cellClass += ` employee-${empIndex + 1} assigned`;
                                cellContent = '‚óè';
                            } else {
                                const defaultClass = getDefaultClass(slot.start, dayIndex);
                                if (defaultClass === 'default-gray') {
                                    cellClass += ' default-gray';
                                } else if (defaultClass === 'default-green') {
                                    cellClass += ' default-green';
                                }
                            }
                        }

                        const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                        if (isLastEmployeeOfDay) {
                            cellClass += ' day-separator';
                        }

                        html += `<td class="${cellClass}">${cellContent}</td>`;
                    });
                }

                html += `
        </tr>`;
            });

            html += `
        <tr class="total-row">
            <td class="time-col">Total Jour</td>`;

            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                employees.forEach((employee, empIndex) => {
                    let totalMinutes = 0;
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });

                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    
                    const isLastEmployeeOfDay = empIndex === employees.length - 1 && dayIndex < 6;
                    const separatorClass = isLastEmployeeOfDay ? ' day-separator' : '';
                    
                    html += `<td class="total-row${separatorClass}">${hours}h${minutes.toString().padStart(2, '0')}</td>`;
                });
            }

            html += `
        </tr>
        
        <tr class="team-total-row">
            <td class="time-col">√âquipe</td>`;

            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                let totalMinutes = 0;
                employees.forEach((employee, empIndex) => {
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });
                });

                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const teamTotal = `${hours}h${minutes.toString().padStart(2, '0')}`;

                html += `<td colspan="5">${teamTotal}</td>`;
            }

            html += `
        </tr>
    </table>
</body>
</html>`;

            return html;
        }

        function sendByEmail() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            let emailBody = `Planning Semaine ${currentWeek} - ${currentYear}\n\n`;
            
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            employees.forEach((employee, empIndex) => {
                emailBody += `=== ${employee.firstName} ${employee.lastName} ===\n`;
                
                days.forEach((dayName, dayIndex) => {
                    const date = formatDate(dates[dayIndex]);
                    let daySchedule = [];
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            daySchedule.push(`${slot.start}-${slot.end}`);
                        }
                    });
                    
                    if (daySchedule.length > 0) {
                        emailBody += `${dayName} ${date}: ${daySchedule.join(', ')}\n`;
                    }
                });
                
                let totalMinutes = 0;
                timeSlots.forEach((slot, slotIndex) => {
                    days.forEach((_, dayIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                        }
                    });
                });
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                emailBody += `Total: ${hours}h${minutes.toString().padStart(2, '0')}\n\n`;
            });
            
            const subject = `Planning Semaine ${currentWeek} - ${currentYear}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            window.open(mailtoLink);
        }

        window.addEventListener('click', (event) => {
            const employeeModal = document.getElementById('employeeModal');
            const duplicateModal = document.getElementById('duplicateModal');
            const resetModal = document.getElementById('resetModal');
            
            if (event.target === employeeModal) {
                closeEmployeeModal();
            }
            if (event.target === duplicateModal) {
                closeDuplicateModal();
            }
            if (event.target === resetModal) {
                closeResetModal();
            }
        });

        function openDuplicateModal() {
            const modal = document.getElementById('duplicateModal');
            populateDuplicateSelectors();
            updateDuplicateInfo();
            modal.style.display = 'block';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        function populateDuplicateSelectors() {
            console.log('Populate duplicate selectors called');
        }

        function updateDuplicateInfo() {
            console.log('Update duplicate info called');
        }

        function duplicatePlanning() {
            console.log('Duplicate planning called');
        }

        function openResetModal() {
            const modal = document.getElementById('resetModal');
            populateResetSelectors();
            updateResetInfo();
            modal.style.display = 'block';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function populateResetSelectors() {
            console.log('Populate reset selectors called');
        }

        function updateResetInfo() {
            console.log('Update reset info called');
        }

        function resetPlanning() {
            console.log('Reset planning called');
        }

        function toggleDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.toggle('show');
        }

        function closeDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.remove('show');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
