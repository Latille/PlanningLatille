<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Planning LATILLE</title>
    
    <!-- Biblioth√®que SheetJS pour l'export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Biblioth√®que jsPDF pour la g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-messaging.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB70gXioCFDN7qBQ21vDGviGSzb7Sg1slQ",
            authDomain: "planning-latille.firebaseapp.com",
            projectId: "planning-latille",
            storageBucket: "planning-latille.firebasestorage.app",
            messagingSenderId: "363904305106",
            appId: "1:363904305106:web:ecb94628d4eaaa25a72a0b"
        }

        // Autres fonctions
        function openPrintableVersion() {
            generatePlanningPDF(`${currentYear}-${currentWeek}`).then(blob => {
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            });
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const messaging = getMessaging(app);

        // Exposer Firebase globalement
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseAuth = auth;
        window.firebaseMessaging = messaging;
        window.firestoreSDK = { doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot };
        window.authSDK = { signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail, createUserWithEmailAndPassword, deleteUser };
        window.messagingSDK = { getToken, onMessage };
        window.firebaseReady = true;

        // Initialiser EmailJS avec votre cl√© publique
        emailjs.init('jmxM2TzLpG0C5Al7B');
        window.emailjsReady = true;

        // Initialiser l'application une fois Firebase pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                window.initializeApp();
            });
        } else {
            window.initializeApp();
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .forgot-password {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .error-message {
            color: #dc3545;
            margin: 10px 0;
            font-size: 14px;
        }

        .success-message {
            color: #28a745;
            margin: 10px 0;
            font-size: 14px;
        }

        /* User info in header */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .user-email {
            font-weight: bold;
            color: #2c3e50;
        }

        .user-role {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .user-role.admin {
            background: #dc3545;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        /* Validation section - Version compacte */
        .validation-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px 15px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 40px;
        }

        .validation-info {
            margin: 0;
            font-size: 13px;
            flex: 1;
            text-align: left;
        }

        .validate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            margin-left: 15px;
            white-space: nowrap;
        }

        .validate-btn:hover {
            background: #218838;
        }

        .validate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Version info */
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 100;
        }

        /* Password change modal */
        .password-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .password-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* Improved Employee Management - Version compacte */
        .employee-management {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #dee2e6;
        }

        .employee-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .employee-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .status-badge.user {
            background: #007bff;
            color: white;
        }

        .status-badge.admin {
            background: #dc3545;
            color: white;
        }

        .status-badge.super-admin {
            background: #6f42c1;
            color: white;
        }

        .status-badge.no-account {
            background: #6c757d;
            color: white;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .status-badge.active {
            background: #28a745;
            color: white;
        }

        .employee-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .employee-input {
            width: 100%;
            padding: 6px;
            margin: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .employee-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.2s;
            line-height: 1.2;
        }

        .action-btn.create {
            background: #28a745;
            color: white;
        }

        .action-btn.reset {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn.promote {
            background: #6f42c1;
            color: white;
        }

        .action-btn.demote {
            background: #17a2b8;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Admin protection notice */
        .admin-protection {
            background: #e8f4f8;
            border: 1px solid #b3d9e6;
            padding: 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #0c5460;
            text-align: center;
            margin-top: 4px;
        }

        /* Read-only styling */
        .read-only .time-slot {
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .read-only .day-toggle {
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .read-only .btn-save,
        .read-only .btn-employees,
        .read-only .dropdown {
            display: none !important;
        }

        /* Le bouton email reste visible pour tous les utilisateurs */
        .read-only .btn-email {
            display: inline-block !important;
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 18px;
        }

        .header {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .week-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .week-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .week-nav-btn {
            height: 36px;
            width: 24px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .week-nav-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }

        .week-nav-btn:active {
            background: #e0e0e0;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-employees { background: #6c757d; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-email { background: #28a745; color: white; }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
            transition: background-color 0.3s;
        }

        .dropdown-content button:first-child {
            border-radius: 5px 5px 0 0;
        }

        .dropdown-content button:last-child {
            border-radius: 0 0 5px 5px;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content button.danger {
            color: #dc3545;
        }

        .dropdown-content button.danger:hover {
            background-color: #f8d7da;
        }

        .dropdown.show .dropdown-content {
            display: block;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .summary {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        .employee-summary {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .employee-summary.hours-zero {
            background: #f8f9fa;
        }

        .employee-summary.hours-partial {
            background: #ffebee;
            border: 1px solid #ef5350;
        }

        .employee-summary.hours-complete {
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        @keyframes greenFlash {
            0% { 
                background: #2e7d32;
                transform: scale(1.05);
            }
            50% { 
                background: #388e3c;
                transform: scale(1.02);
            }
            100% { 
                background: #e8f5e8;
                transform: scale(1);
            }
        }

        @keyframes textFlash {
            0% { 
                color: white;
            }
            50% { 
                color: white;
            }
            100% { 
                color: inherit;
            }
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        .employee-summary.hours-complete.flash .employee-name,
        .employee-summary.hours-complete.flash .hours-total,
        .employee-summary.hours-complete.flash .hours-remaining {
            animation: textFlash 0.8s ease-out;
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hours-total {
            font-size: 14px;
            color: #495057;
        }

        .hours-remaining {
            font-size: 12px;
            margin-top: 5px;
        }

        .hours-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .schedule-grid {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .days-header {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #1a252f;
            color: white;
        }

        .time-header {
            background: #243342;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            padding: 10px 8px;
            text-align: center;
            border-left: 1px solid #485b6b;
            position: relative;
        }

        .day-toggle-container {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .day-toggle {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            user-select: none;
        }

        .day-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .day-toggle.open {
            background: #4caf50;
            color: white;
        }

        .day-toggle.closed {
            background: #f44336;
            color: white;
        }

        .day-toggle.am-closed {
            background: #ff9800;
            color: white;
        }

        .day-toggle.pm-closed {
            background: #ff9800;
            color: white;
        }

        .schedule-cell.closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
        }

        .schedule-cell.establishment-closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .schedule-cell.establishment-closed::after {
            content: "FERM√â";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .schedule-cell.closed::after {
            content: "FERM√â";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .time-row.closed .schedule-cell {
            position: relative;
        }

        .day-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .day-date {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.9;
        }

        .employees-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
            background: #ecf0f1;
        }

        .time-cell {
            padding: 3px 6px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 10px;
            line-height: 1.1;
        }

        .time-row:nth-child(odd) .time-cell {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) .time-cell {
            background-color: #ffffff;
        }

        .employees-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            border-left: 2px solid #95a5a6;
            min-height: 40px;
        }

        .time-cell.employees-header {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
            padding: 2px;
            transform: rotate(180deg);
        }

        .time-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
        }

        .time-row:nth-child(odd) {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) {
            background-color: #ffffff;
        }

        .schedule-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1px;
            border-left: 2px solid #95a5a6;
            min-height: 20px;
        }

        .time-slot {
            width: 18px;
            height: 18px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .time-slot.default-gray {
            background-color: #95a5a6;
        }

        .time-slot.default-green {
            background-color: #a8d8a8;
        }

        .time-slot.employee-1 { background-color: #e74c3c; }
        .time-slot.employee-2 { background-color: #3498db; }
        .time-slot.employee-3 { background-color: #f39c12; }
        .time-slot.employee-4 { background-color: #9b59b6; }
        .time-slot.employee-5 { background-color: #f1c40f; }

        .time-slot:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .time-slot.drag-preview {
            border: 2px solid #27ae60;
            opacity: 0.8;
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }

        .time-slot.drag-invalid {
            border: 2px solid #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .daily-totals {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #12BBFD;
            color: white;
            font-weight: bold;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            min-height: 35px;
        }

        .total-cell {
            padding: 8px 6px;
            text-align: center;
            border-left: 2px solid rgba(255,255,255,0.2);
            transition: background-color 0.3s ease;
            font-size: 11px;
        }

        .total-cell:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .total-label {
            background: #12BBFD;
            font-size: 10px;
            font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .daily-employee-totals {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .daily-employee-totals > div {
            background: rgba(255,255,255,0.15);
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .daily-employee-totals > div:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 15px;
            border-radius: 10px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Email Modal Styles */
        .email-recipient {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .email-recipient label {
            display: flex;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }

        .email-recipient input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .recipient-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .recipient-details {
            flex: 1;
        }

        .recipient-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .recipient-email {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .recipient-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #28a745;
            color: white;
        }

        .recipient-status.no-email {
            background: #6c757d;
        }

        /* Modal employ√© optimis√© pour la hauteur */
        #employeeModal .modal-content {
            margin: 2% auto;
            padding: 10px 15px;
            max-height: 95vh;
        }
        
        #employeeModal h2 {
            margin: 5px 0 10px 0;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            margin: -5px 0 0 0;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 1200px) {
            .main-content {
                padding: 0 10px;
            }
            
            .time-slot {
                width: 15px;
                height: 15px;
            }
            
            .employee-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h2 class="login-title">üîê Connexion LATILLE</h2>
            <input type="email" id="loginEmail" class="login-input" placeholder="Adresse email" required>
            <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" required>
            <button onclick="login()" class="login-btn">Se connecter</button>
            <div id="loginError" class="error-message"></div>
            <div id="loginSuccess" class="success-message"></div>
            <div class="forgot-password" onclick="forgotPassword()">Mot de passe oubli√© ?</div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <span class="close" onclick="closePasswordModal()" id="passwordCloseBtn">&times;</span>
            <h2 id="passwordModalTitle">Changer le mot de passe</h2>
            <div id="passwordWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; color: #856404;">
                <strong>‚ö†Ô∏è Changement obligatoire</strong><br>
                Vous devez changer votre mot de passe temporaire.
            </div>
            <input type="password" id="newPassword" class="login-input" placeholder="Nouveau mot de passe" required>
            <input type="password" id="confirmPassword" class="login-input" placeholder="Confirmer le mot de passe" required>
            <button onclick="changePassword()" class="login-btn">Modifier</button>
            <div id="passwordError" class="error-message"></div>
            <div id="passwordSuccess" class="success-message"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1>üìã Gestion Planning LATILLE</h1>
            <div class="controls">
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                    <button class="logout-btn" onclick="openPasswordModal()">Changer MDP</button>
                </div>
                <div class="week-selector">
                    <div class="week-group">
                        <label>Semaine</label>
                        <select id="weekSelect"></select>
                        <button class="week-nav-btn" onclick="changeWeek(-1)" title="Semaine pr√©c√©dente">‚óÄ</button>
                        <button class="week-nav-btn" onclick="changeWeek(1)" title="Semaine suivante">‚ñ∂</button>
                    </div>
                    <div class="week-group">
                        <label>Ann√©e</label>
                        <select id="yearSelect"></select>
                    </div>
                </div>
                <div class="dropdown" id="adminControls">
                    <button class="btn btn-employees" onclick="toggleDropdown()">Actions ‚ãÆ</button>
                    <div class="dropdown-content" id="actionsDropdown">
                        <button onclick="openEmployeeModal(); closeDropdown()">G√©rer Employ√©s</button>
                        <button onclick="openDuplicateModal(); closeDropdown()">Dupliquer Planning</button>
                        <button class="danger" onclick="openResetModal(); closeDropdown()">R√©initialiser</button>
                    </div>
                </div>
                <button class="btn btn-save" onclick="openPrintableVersion()">Planning Impression</button>
                <button class="btn btn-email" onclick="sendByEmail()">Envoyer par Email</button>
            </div>
        </div>

        <div class="main-content">
            <div id="accessDenied" class="access-denied" style="display: none;">
                <h2>üö´ Acc√®s refus√©</h2>
                <p>Vous n'avez pas acc√®s √† ce planning car vous n'y √™tes pas assign√©.</p>
            </div>

            <div id="validationSection" class="validation-section" style="display: none;">
                <div class="validation-info">
                    <strong>üîÑ Planning modifi√©</strong> - Ce planning a √©t√© modifi√© et n'est pas encore valid√©.
                </div>
                <button class="validate-btn" onclick="validatePlanning()">‚úÖ Valider et Notifier</button>
            </div>

            <div id="scheduleContent">
                <div class="summary">
                    <h3>R√©sum√© Hebdomadaire</h3>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>

                <div class="schedule-grid">
                    <div class="days-header">
                        <div class="time-header">Horaires</div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(0)" title="Ouvrir/Fermer lundi" data-day="0">‚úì</div>
                            </div>
                            <div class="day-title">Lundi</div>
                            <div class="day-date" id="monday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(1)" title="Ouvrir/Fermer mardi" data-day="1">‚úì</div>
                            </div>
                            <div class="day-title">Mardi</div>
                            <div class="day-date" id="tuesday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(2)" title="Ouvrir/Fermer mercredi" data-day="2">‚úì</div>
                            </div>
                            <div class="day-title">Mercredi</div>
                            <div class="day-date" id="wednesday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(3)" title="Ouvrir/Fermer jeudi" data-day="3">‚úì</div>
                            </div>
                            <div class="day-title">Jeudi</div>
                            <div class="day-date" id="thursday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(4)" title="Ouvrir/Fermer vendredi" data-day="4">‚úì</div>
                            </div>
                            <div class="day-title">Vendredi</div>
                            <div class="day-date" id="friday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(5)" title="Ouvrir/Fermer samedi" data-day="5">‚úì</div>
                            </div>
                            <div class="day-title">Samedi</div>
                            <div class="day-date" id="saturday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(6)" title="Ouvrir/Fermer dimanche" data-day="6">‚úì</div>
                            </div>
                            <div class="day-title">Dimanche</div>
                            <div class="day-date" id="sunday-date"></div>
                        </div>
                    </div>

                    <div class="employees-row">
                        <div class="time-cell employees-header">Employ√©s</div>
                        <div class="employees-cell" id="monday-employees"></div>
                        <div class="employees-cell" id="tuesday-employees"></div>
                        <div class="employees-cell" id="wednesday-employees"></div>
                        <div class="employees-cell" id="thursday-employees"></div>
                        <div class="employees-cell" id="friday-employees"></div>
                        <div class="employees-cell" id="saturday-employees"></div>
                        <div class="employees-cell" id="sunday-employees"></div>
                    </div>

                    <div id="timeSlots"></div>

                    <div class="daily-totals">
                        <div class="total-cell total-label" style="font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px;">Total Jour</div>
                        <div class="total-cell" id="monday-totals"></div>
                        <div class="total-cell" id="tuesday-totals"></div>
                        <div class="total-cell" id="wednesday-totals"></div>
                        <div class="total-cell" id="thursday-totals"></div>
                        <div class="total-cell" id="friday-totals"></div>
                        <div class="total-cell" id="saturday-totals"></div>
                        <div class="total-cell" id="sunday-totals"></div>
                    </div>

                    <div class="daily-totals" style="background: #20B077; min-height: 35px;">
                        <div class="total-cell total-label" style="background: #20B077; font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px; display: flex; align-items: center; justify-content: center;">√âquipe</div>
                        <div class="total-cell" id="monday-team-total">0h</div>
                        <div class="total-cell" id="tuesday-team-total">0h</div>
                        <div class="total-cell" id="wednesday-team-total">0h</div>
                        <div class="total-cell" id="thursday-team-total">0h</div>
                        <div class="total-cell" id="friday-team-total">0h</div>
                        <div class="total-cell" id="saturday-team-total">0h</div>
                        <div class="total-cell" id="sunday-team-total">0h</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version info -->
    <div class="version-info" id="versionInfo"></div>

    <!-- Modal pour g√©rer les employ√©s (Version am√©lior√©e) -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2>Gestion des Employ√©s et Administrateurs</h2>
            <div style="background: #e8f4f8; border: 1px solid #b3d9e6; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px;">
                <strong>üí° Gestion des administrateurs :</strong><br>
                ‚Ä¢ L'administrateur principal (LATILLE) ne peut pas √™tre modifi√©<br>
                ‚Ä¢ Vous pouvez promouvoir d'autres employ√©s comme administrateurs<br>
                ‚Ä¢ Les administrateurs secondaires peuvent √™tre r√©trograd√©s<br>
                ‚Ä¢ Tous les administrateurs ont les m√™mes droits de gestion
            </div>
            <div id="employeeManagement"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn btn-save" onclick="saveEmployees()">üíæ Sauvegarder les Modifications</button>
            </div>
        </div>
    </div>

    <!-- Modal pour dupliquer un planning -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDuplicateModal()">&times;</span>
            <h2>Dupliquer un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning source :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="sourceWeek" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                    <select id="sourceYear" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning destination :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="destWeek" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                    <select id="destYear" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                </div>
                
                <div id="duplicateInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
            </div>
            <button class="btn btn-save" onclick="duplicatePlanning()">Dupliquer le Planning</button>
        </div>
    </div>

    <!-- Modal pour s√©lectionner les destinataires (Admin) -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmailModal()">&times;</span>
            <h2>Envoyer le Planning par Email</h2>
            <div style="margin: 20px 0;">
                <h3>S√©lectionnez les destinataires :</h3>
                <div id="emailRecipients" style="margin: 15px 0;">
                    <!-- Les destinataires seront g√©n√©r√©s dynamiquement -->
                </div>
                
                <div style="margin: 15px 0;">
                    <label>
                        <input type="checkbox" id="selectAllEmployees" onchange="toggleAllEmployees()">
                        <strong>S√©lectionner tous les employ√©s</strong>
                    </label>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>üìã Planning √† envoyer :</strong><br>
                    Semaine <span id="emailWeekInfo"></span><br>
                    <span id="emailVersionInfo"></span>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-email" onclick="sendPlanningToSelected()" id="sendEmailBtn" disabled>
                    üìß Envoyer le Planning
                </button>
            </div>
        </div>
    </div>
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h2>R√©initialiser un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Semaine √† r√©initialiser :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="resetWeek" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                    <select id="resetYear" style="flex: 1;">
                        <!-- Options g√©n√©r√©es dynamiquement -->
                    </select>
                </div>
                
                <div id="resetInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è Attention :</strong> Cette action supprimera d√©finitivement tous les plannings et fermetures de cette semaine. Cette action est irr√©versible.
                </div>
            </div>
            <button class="btn" style="background: #dc3545; color: white;" onclick="resetPlanning()">R√©initialiser le Planning</button>
        </div>
    </div>

    <script>
        // Variables globales pour le drag & drop
        let currentUser = null;
        let userRole = null;
        let currentWeek = 25;
        let currentYear = 2025;
        let mustChangePassword = false;
        let employees = [
            { firstName: 'Antoine', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
            { firstName: 'L√©a', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
            { firstName: 'No√©mie', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
            { firstName: 'Christelle', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
            { firstName: 'Admin', lastName: 'LATILLE', email: 'latilledistribution@gmail.com', role: 'admin', accountStatus: 'active' }
        ];
        let schedules = {};
        let closures = {};
        let activeListeners = {};
        let isUpdatingFromFirebase = false;
        let isDragging = false;
        let dragStart = null;
        let dragEnd = null;
        let dragStartState = null;
        let dragCurrentEmployee = null;
        let dragCurrentDay = null;
        let draggedSlots = new Set();
        
        // Gestion des modifications et validation par semaine
        let weekModifications = {}; // Format: {"2025-26": true/false}
        let weekValidations = {}; // Format: {"2025-26": true/false}
        
        let weekVersions = {}; // Versions par semaine - format: {"2025-26": {number: 1.2, date: "210625"}}
        let currentWeekVersion = { number: 1.0, date: getCurrentDateString() };

        // Fonction pour obtenir la date au format correct (DDMMYY avec les 2 derniers chiffres de l'ann√©e)
        function getCurrentDateString() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear().toString().slice(-2); // 2 derniers chiffres
            return day + month + year;
        }

        let weekValidationInfo = {}; // Informations de validation par semaine - format: {"2025-26": {validatedAt: "...", version: {...}}}

        // Fonction pour obtenir les informations de validation de la semaine courante
        function getCurrentWeekValidationInfo() {
            const weekKey = `${currentYear}-${currentWeek}`;
            return weekValidationInfo[weekKey] || null;
        }

        // Fonction pour mettre √† jour le titre du r√©sum√© avec les informations de validation
        // Fonctions pour g√©rer les modifications par semaine
        function getCurrentWeekKey() {
            return `${currentYear}-${currentWeek}`;
        }

        function isCurrentWeekModified() {
            const weekKey = getCurrentWeekKey();
            return weekModifications[weekKey] === true;
        }

        function isCurrentWeekValidated() {
            const weekKey = getCurrentWeekKey();
            return weekValidations[weekKey] === true;
        }

        function markCurrentWeekAsModified() {
            if (userRole === 'admin' && !isUpdatingFromFirebase) {
                const weekKey = getCurrentWeekKey();
                weekModifications[weekKey] = true;
                weekValidations[weekKey] = false; // Si modifi√©, alors plus valid√©
                
                console.log(`Semaine ${weekKey} marqu√©e comme modifi√©e`);
                
                // Sauvegarder imm√©diatement dans Firebase
                saveModificationStates();
                updateValidationDisplay();
            }
        }

        function markCurrentWeekAsValidated() {
            const weekKey = getCurrentWeekKey();
            weekModifications[weekKey] = false;
            weekValidations[weekKey] = true;
            
            // Sauvegarder imm√©diatement dans Firebase
            saveModificationStates();
            updateValidationDisplay();
        }

        // Fonction pour sauvegarder les √©tats de modification
        async function saveModificationStates() {
            if (!window.firebaseReady || !window.firestoreSDK) return;
            
            try {
                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'planning-data', 'week-modifications'), {
                    modifications: weekModifications,
                    validations: weekValidations,
                    lastUpdated: new Date().toISOString()
                });
                console.log('√âtats de modification sauvegard√©s');
            } catch (error) {
                console.error('Erreur sauvegarde √©tats modification:', error);
            }
        }

        // Fonction pour charger les √©tats de modification pour la semaine courante
        async function loadCurrentWeekStates() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                console.log('Firebase non pr√™t, impossible de charger les √©tats');
                return;
            }
            
            const weekKey = getCurrentWeekKey();
            console.log(`Chargement des √©tats pour la semaine: ${weekKey}`);
            
            try {
                const { doc, getDoc } = window.firestoreSDK;
                const modificationsDoc = await getDoc(doc(window.firestore, 'planning-data', 'week-modifications'));
                
                if (modificationsDoc.exists()) {
                    const data = modificationsDoc.data();
                    weekModifications = data.modifications || {};
                    weekValidations = data.validations || {};
                    
                    console.log(`√âtats charg√©s - Modifi√©: ${weekModifications[weekKey]}, Valid√©: ${weekValidations[weekKey]}`);
                } else {
                    console.log('Aucun document d\'√©tats trouv√© dans Firebase');
                }
                
                // Mettre √† jour l'affichage apr√®s chargement
                setTimeout(() => {
                    updateValidationDisplay();
                }, 50);
                
            } catch (error) {
                console.error('Erreur chargement √©tats modification:', error);
            }
        }

        function updateValidationDisplay() {
            const validationSection = document.getElementById('validationSection');
            const isAdmin = userRole === 'admin';
            const isModified = isCurrentWeekModified();
            const isValidated = isCurrentWeekValidated();
            const weekKey = getCurrentWeekKey();
            
            // Log de d√©bogage
            console.log(`Validation Display - Semaine: ${weekKey}`);
            console.log(`Admin: ${isAdmin}, Modifi√©: ${isModified}, Valid√©: ${isValidated}`);
            console.log('√âtat modifications:', weekModifications);
            console.log('√âtat validations:', weekValidations);
            
            // Afficher seulement si : admin ET (modifi√© ET non valid√©)
            const shouldShow = isAdmin && isModified && !isValidated;
            validationSection.style.display = shouldShow ? 'flex' : 'none';
            
            console.log(`Bandeau affich√©: ${shouldShow}`);
        }

        // Fonction pour mettre √† jour le titre du r√©sum√© avec les informations de validation
        function updateSummaryTitle() {
            const summaryTitle = document.querySelector('.summary h3');
            const validationInfo = getCurrentWeekValidationInfo();
            
            if (validationInfo && validationInfo.validatedAt) {
                const validatedDate = new Date(validationInfo.validatedAt);
                const dateStr = validatedDate.toLocaleDateString('fr-FR');
                const timeStr = validatedDate.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const version = validationInfo.version ? validationInfo.version.number : 'N/A';
                
                summaryTitle.textContent = `R√©sum√© Hebdomadaire (${dateStr} ${timeStr} - v${version})`;
            } else {
                summaryTitle.textContent = 'R√©sum√© Hebdomadaire (Non valid√©)';
            }
        }
        function getCurrentWeekVersion() {
            const weekKey = `${currentYear}-${currentWeek}`;
            if (!weekVersions[weekKey]) {
                weekVersions[weekKey] = { 
                    number: 1.0, 
                    date: getCurrentDateString() 
                };
            }
            return weekVersions[weekKey];
        }

        // Fonction pour incr√©menter la version de la semaine courante
        function incrementCurrentWeekVersion() {
            const weekKey = `${currentYear}-${currentWeek}`;
            if (!weekVersions[weekKey]) {
                weekVersions[weekKey] = { 
                    number: 1.0, 
                    date: getCurrentDateString() 
                };
            }
            
            weekVersions[weekKey].number += 0.1;
            weekVersions[weekKey].number = Math.round(weekVersions[weekKey].number * 10) / 10;
            weekVersions[weekKey].date = getCurrentDateString();
            
            return weekVersions[weekKey];
        }

        // Fonctions de gestion du drag & drop pour la s√©lection multiple
        function startDragSelection(element, dayIndex, slotIndex, empIndex, event) {
            if (userRole !== 'admin') return;
            
            isDragging = true;
            dragStart = { day: dayIndex, slot: slotIndex, employee: empIndex };
            dragCurrentEmployee = empIndex;
            dragCurrentDay = dayIndex;
            draggedSlots.clear();
            
            // D√©terminer l'√©tat initial (actif ou inactif)
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const isCurrentlyActive = schedules[scheduleKey] && 
                                    schedules[scheduleKey][dayIndex] && 
                                    schedules[scheduleKey][dayIndex][slotIndex] && 
                                    schedules[scheduleKey][dayIndex][slotIndex][empIndex];
            
            dragStartState = !isCurrentlyActive; // On basculera vers l'√©tat oppos√©
            
            // Ajouter le slot de d√©part
            const slotKey = `${dayIndex}-${slotIndex}-${empIndex}`;
            draggedSlots.add(slotKey);
            
            // Ajouter la classe de preview
            element.classList.add('drag-preview');
            
            // Emp√™cher la s√©lection de texte
            document.body.style.userSelect = 'none';
            
            event.preventDefault();
        }

        function updateDragSelection(element, dayIndex, slotIndex, empIndex) {
            if (!isDragging || userRole !== 'admin') return;
            
            // Ne permettre la s√©lection que pour le m√™me employ√© et le m√™me jour
            if (empIndex !== dragCurrentEmployee || dayIndex !== dragCurrentDay) {
                element.classList.add('drag-invalid');
                return;
            }
            
            element.classList.remove('drag-invalid');
            
            // Mettre √† jour la fin de la s√©lection
            dragEnd = { day: dayIndex, slot: slotIndex, employee: empIndex };
            
            // Effacer tous les previews pr√©c√©dents
            document.querySelectorAll('.drag-preview').forEach(slot => {
                slot.classList.remove('drag-preview');
            });
            
            // Calculer la plage de slots s√©lectionn√©s
            const startSlot = Math.min(dragStart.slot, dragEnd.slot);
            const endSlot = Math.max(dragStart.slot, dragEnd.slot);
            
            // Effacer la liste des slots s√©lectionn√©s
            draggedSlots.clear();
            
            // Ajouter tous les slots dans la plage
            for (let slot = startSlot; slot <= endSlot; slot++) {
                const slotKey = `${dayIndex}-${slot}-${empIndex}`;
                draggedSlots.add(slotKey);
                
                // Ajouter la classe de preview
                const slotElement = document.querySelector(`[data-day="${dayIndex}"][data-slot="${slot}"][data-employee="${empIndex}"]`);
                if (slotElement) {
                    slotElement.classList.add('drag-preview');
                }
            }
        }

        function endDragSelection() {
            if (!isDragging || userRole !== 'admin') return;
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
            
            // Appliquer les changements √† tous les slots s√©lectionn√©s
            draggedSlots.forEach(slotKey => {
                const [dayIndex, slotIndex, empIndex] = slotKey.split('-').map(Number);
                
                if (!schedules[scheduleKey][dayIndex]) schedules[scheduleKey][dayIndex] = {};
                if (!schedules[scheduleKey][dayIndex][slotIndex]) schedules[scheduleKey][dayIndex][slotIndex] = {};
                
                // Appliquer le nouvel √©tat
                schedules[scheduleKey][dayIndex][slotIndex][empIndex] = dragStartState;
                
                // Mettre √† jour l'affichage
                const element = document.querySelector(`[data-day="${dayIndex}"][data-slot="${slotIndex}"][data-employee="${empIndex}"]`);
                if (element) {
                    if (dragStartState) {
                        element.className = 'time-slot employee-' + (empIndex + 1);
                    } else {
                        element.className = 'time-slot';
                        const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dayIndex);
                        if (defaultClass) {
                            element.classList.add(defaultClass);
                        }
                    }
                }
            });
            
            // Nettoyer les classes de preview
            document.querySelectorAll('.drag-preview, .drag-invalid').forEach(slot => {
                slot.classList.remove('drag-preview', 'drag-invalid');
            });
            
            // R√©initialiser les variables
            isDragging = false;
            dragStart = null;
            dragEnd = null;
            dragStartState = null;
            dragCurrentEmployee = null;
            dragCurrentDay = null;
            draggedSlots.clear();
            
            // Restaurer la s√©lection de texte
            document.body.style.userSelect = '';
            
            // Mettre √† jour le r√©sum√© et sauvegarder
            updateSummary();
            saveSchedulesToFirebase();
        }

        // Configuration des cr√©neaux horaires
        const timeSlots = [
            { start: '07:00', end: '07:30', duration: 30 },
            { start: '07:30', end: '08:00', duration: 30 },
            { start: '08:00', end: '08:30', duration: 30 },
            { start: '08:30', end: '08:45', duration: 15 },
            { start: '08:45', end: '09:00', duration: 15 },
            { start: '09:00', end: '09:30', duration: 30 },
            { start: '09:30', end: '10:00', duration: 30 },
            { start: '10:00', end: '10:30', duration: 30 },
            { start: '10:30', end: '11:00', duration: 30 },
            { start: '11:00', end: '11:30', duration: 30 },
            { start: '11:30', end: '12:00', duration: 30 },
            { start: '12:00', end: '12:30', duration: 30 },
            { start: '12:30', end: '12:45', duration: 15 },
            { start: '12:45', end: '13:00', duration: 15 },
            { start: '13:00', end: '13:30', duration: 30 },
            { start: '13:30', end: '14:00', duration: 30 },
            { start: '14:00', end: '14:30', duration: 30 },
            { start: '14:30', end: '15:00', duration: 30 },
            { start: '15:00', end: '15:15', duration: 15 },
            { start: '15:15', end: '15:30', duration: 15 },
            { start: '15:30', end: '16:00', duration: 30 },
            { start: '16:00', end: '16:30', duration: 30 },
            { start: '16:30', end: '17:00', duration: 30 },
            { start: '17:00', end: '17:30', duration: 30 },
            { start: '17:30', end: '18:00', duration: 30 },
            { start: '18:00', end: '18:30', duration: 30 },
            { start: '18:30', end: '19:00', duration: 30 },
            { start: '19:00', end: '19:15', duration: 15 },
            { start: '19:15', end: '19:30', duration: 15 },
            { start: '19:30', end: '20:00', duration: 30 }
        ];

        // Cr√©neaux par d√©faut
        const defaultGraySlots = ['13:00', '13:30', '14:00', '14:30'];
        const sundayGraySlots = ['13:00', '13:30', '14:00', '14:30', '15:00', '15:15', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:15', '19:30'];
        const defaultGreenSlots = ['08:30', '08:45', '12:30', '12:45', '15:00', '15:15'];
        const weekdayGreenSlots = ['19:00', '19:15'];

        // Fonctions d'authentification
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');

            if (!email || !password) {
                errorDiv.textContent = 'Veuillez remplir tous les champs';
                return;
            }

            try {
                const { signInWithEmailAndPassword } = window.authSDK;
                await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                successDiv.textContent = 'Connexion r√©ussie...';
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Erreur de connexion:', error);
                errorDiv.textContent = 'Email ou mot de passe incorrect';
                successDiv.textContent = '';
            }
        }

        async function logout() {
            try {
                const { signOut } = window.authSDK;
                await signOut(window.firebaseAuth);
            } catch (error) {
                console.error('Erreur de d√©connexion:', error);
            }
        }

        async function forgotPassword() {
            const email = document.getElementById('loginEmail').value;
            if (!email) {
                document.getElementById('loginError').textContent = 'Veuillez entrer votre adresse email';
                return;
            }

            try {
                const { sendPasswordResetEmail } = window.authSDK;
                await sendPasswordResetEmail(window.firebaseAuth, email);
                document.getElementById('loginSuccess').textContent = 'Email de r√©initialisation envoy√©';
                document.getElementById('loginError').textContent = '';
            } catch (error) {
                console.error('Erreur envoi email:', error);
                document.getElementById('loginError').textContent = 'Erreur lors de l\'envoi de l\'email';
            }
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
            
            const isRequired = mustChangePassword;
            const closeBtn = document.getElementById('passwordCloseBtn');
            const warning = document.getElementById('passwordWarning');
            const title = document.getElementById('passwordModalTitle');
            
            if (isRequired) {
                closeBtn.style.display = 'none';
                warning.style.display = 'block';
                title.textContent = 'Changement de mot de passe obligatoire';
            } else {
                closeBtn.style.display = 'block';
                warning.style.display = 'none';
                title.textContent = 'Changer le mot de passe';
            }
        }

        function closePasswordModal() {
            if (mustChangePassword) {
                alert('‚ö†Ô∏è Vous devez changer votre mot de passe temporaire avant de continuer.');
                return;
            }
            
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('passwordSuccess').textContent = '';
        }

        async function checkPasswordChangeRequired(email) {
            try {
                const { doc, getDoc } = window.firestoreSDK;
                const userSettingsDoc = await getDoc(doc(window.firestore, 'user-settings', email));
                
                if (userSettingsDoc.exists()) {
                    const data = userSettingsDoc.data();
                    mustChangePassword = data.requirePasswordChange || false;
                } else {
                    mustChangePassword = false;
                }
            } catch (error) {
                console.error('Erreur v√©rification changement MDP:', error);
                mustChangePassword = false;
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
                return;
            }

            try {
                const { updatePassword } = window.authSDK;
                await updatePassword(window.firebaseAuth.currentUser, newPassword);
                
                if (mustChangePassword) {
                    const { doc, setDoc } = window.firestoreSDK;
                    await setDoc(doc(window.firestore, 'user-settings', currentUser.email), {
                        requirePasswordChange: false,
                        passwordChangedAt: new Date().toISOString()
                    });
                    mustChangePassword = false;
                }
                
                successDiv.textContent = 'Mot de passe modifi√© avec succ√®s';
                errorDiv.textContent = '';
                setTimeout(() => {
                    closePasswordModal();
                }, 2000);
            } catch (error) {
                console.error('Erreur changement mot de passe:', error);
                
                let errorMessage = 'Erreur lors du changement de mot de passe';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Veuillez vous reconnecter pour changer votre mot de passe';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Le mot de passe doit contenir au moins 6 caract√®res';
                }
                
                errorDiv.textContent = errorMessage;
            }
        }

        // Fonctions de gestion des r√¥les et permissions
        function determineUserRole(email) {
            const employee = employees.find(emp => emp.email === email);
            if (employee) {
                return employee.role;
            }
            return email === 'latilledistribution@gmail.com' ? 'admin' : 'user';
        }

        function getUserEmployeeIndex(email) {
            return employees.findIndex(emp => emp.email === email);
        }

        function checkWeekAccess(weekKey, userEmail) {
            if (userRole === 'admin') return true;
            
            const employeeIndex = getUserEmployeeIndex(userEmail);
            if (employeeIndex === -1) return false;

            const weekSchedule = schedules[weekKey];
            if (!weekSchedule) return false;

            let totalMinutes = 0;
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                if (weekSchedule[dayIndex]) {
                    for (let slotIndex = 0; slotIndex < timeSlots.length; slotIndex++) {
                        if (weekSchedule[dayIndex][slotIndex] && weekSchedule[dayIndex][slotIndex][employeeIndex]) {
                            totalMinutes += timeSlots[slotIndex].duration;
                        }
                    }
                }
            }

            return totalMinutes >= 60;
        }

        function updateUIForRole() {
            const isAdmin = userRole === 'admin';
            const weekKey = `${currentYear}-${currentWeek}`;
            const hasAccess = checkWeekAccess(weekKey, currentUser.email);

            document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';

            if (!hasAccess) {
                document.getElementById('accessDenied').style.display = 'block';
                document.getElementById('scheduleContent').style.display = 'none';
                document.getElementById('validationSection').style.display = 'none';
            } else {
                document.getElementById('accessDenied').style.display = 'none';
                document.getElementById('scheduleContent').style.display = 'block';
                
                if (!isAdmin) {
                    document.body.classList.add('read-only');
                } else {
                    document.body.classList.remove('read-only');
                }

                // Utiliser le nouveau syst√®me de validation par semaine
                updateValidationDisplay();
            }

            // Mise √† jour am√©lior√©e de l'affichage du r√¥le
            document.getElementById('userEmail').textContent = currentUser.email;
            const userRoleElement = document.getElementById('userRole');
            
            if (isAdmin) {
                // V√©rifier si c'est l'administrateur principal
                const isPrimaryAdmin = currentUser.email === 'latilledistribution@gmail.com';
                if (isPrimaryAdmin) {
                    userRoleElement.textContent = 'Super Admin';
                    userRoleElement.className = 'user-role admin';
                } else {
                    userRoleElement.textContent = 'Administrateur';
                    userRoleElement.className = 'user-role admin';
                }
            } else {
                userRoleElement.textContent = 'Utilisateur';
                userRoleElement.className = 'user-role';
            }
        }

        // Gestion am√©lior√©e des employ√©s
        async function getEmployeeAccountStatus(email) {
            if (!email) return 'no-account';
            
            try {
                const { doc, getDoc } = window.firestoreSDK;
                const userSettingsDoc = await getDoc(doc(window.firestore, 'user-settings', email));
                
                if (userSettingsDoc.exists()) {
                    const data = userSettingsDoc.data();
                    return data.requirePasswordChange ? 'pending' : 'active';
                } else {
                    return 'no-account';
                }
            } catch (error) {
                return 'no-account';
            }
        }

        async function updateEmployeeAccountStatuses() {
            for (let i = 0; i < employees.length; i++) {
                if (employees[i].email) {
                    employees[i].accountStatus = await getEmployeeAccountStatus(employees[i].email);
                }
            }
        }

        // Fonction pour v√©rifier si un employ√© est l'administrateur principal
        function isPrimaryAdmin(index) {
            return index === 4 && employees[index].email === 'latilledistribution@gmail.com';
        }

        // Fonction pour g√©n√©rer un mot de passe temporaire
        function generateTempPassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Fonction am√©lior√©e pour cr√©er un compte
        async function createEmployeeAccount(employeeIndex) {
            const employee = employees[employeeIndex];
            if (!employee.email) {
                alert('Veuillez d\'abord saisir l\'adresse email de cet employ√©');
                return;
            }

            if (!confirm(`Cr√©er un compte pour ${employee.firstName} (${employee.email}) ?`)) {
                return;
            }

            try {
                const tempPassword = generateTempPassword();
                const currentUserEmail = currentUser.email;
                
                const { createUserWithEmailAndPassword } = window.authSDK;
                await createUserWithEmailAndPassword(window.firebaseAuth, employee.email, tempPassword);
                
                // Se reconnecter en tant qu'admin
                await new Promise(resolve => setTimeout(resolve, 1000));
                const { signInWithEmailAndPassword } = window.authSDK;
                await signInWithEmailAndPassword(window.firebaseAuth, currentUserEmail, 'admin123');
                
                // Marquer le compte comme n√©cessitant un changement de mot de passe
                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'user-settings', employee.email), {
                    requirePasswordChange: true,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email,
                    employeeIndex: employeeIndex,
                    role: employee.role || 'user'
                });

                // Envoyer l'email avec le template correct
                await sendEmployeeEmail(employee, tempPassword, 'creation');
                
                // Mettre √† jour le statut
                employees[employeeIndex].accountStatus = 'pending';
                await openEmployeeModal(); // Refresh de l'affichage
                
                alert(`‚úÖ Compte cr√©√© avec succ√®s !\n\nEmail : ${employee.email}\nMot de passe temporaire : ${tempPassword}\n\n(Ces informations ont √©t√© envoy√©es par email)`);

            } catch (error) {
                console.error('Erreur cr√©ation compte:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    alert('Un compte existe d√©j√† avec cette adresse email');
                } else {
                    alert('Erreur lors de la cr√©ation du compte');
                }
            }
        }

        // Fonction pour r√©initialiser le mot de passe
        async function resetEmployeePassword(employeeIndex) {
            const employee = employees[employeeIndex];
            if (!employee.email) return;

            if (!confirm(`R√©initialiser le mot de passe de ${employee.firstName} ?`)) {
                return;
            }

            try {
                const tempPassword = generateTempPassword();
                
                // Mettre √† jour dans user-settings
                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'user-settings', employee.email), {
                    requirePasswordChange: true,
                    passwordResetAt: new Date().toISOString(),
                    resetBy: currentUser.email,
                    role: employee.role || 'user'
                });

                // Envoyer l'email avec le nouveau mot de passe
                await sendEmployeeEmail(employee, tempPassword, 'reset');
                
                // Mettre √† jour le statut
                employees[employeeIndex].accountStatus = 'pending';
                await openEmployeeModal(); // Refresh de l'affichage
                
                alert(`‚úÖ Mot de passe r√©initialis√© !\n\nNouveau mot de passe temporaire : ${tempPassword}\n\n(Envoy√© par email √† ${employee.email})`);

            } catch (error) {
                console.error('Erreur r√©initialisation:', error);
                alert('Erreur lors de la r√©initialisation');
            }
        }

        // Fonction pour supprimer l'acc√®s d'un employ√©
        async function deleteEmployeeAccess(employeeIndex) {
            const employee = employees[employeeIndex];
            if (!employee.email) return;

            if (isPrimaryAdmin(employeeIndex)) {
                alert('‚ö†Ô∏è Impossible de supprimer l\'acc√®s de l\'administrateur principal.');
                return;
            }

            if (!confirm(`Supprimer l'acc√®s de ${employee.firstName} ?\n\nCela supprimera son compte utilisateur mais conservera ses informations personnelles.`)) {
                return;
            }

            try {
                // Supprimer de user-settings
                const { doc, deleteDoc } = window.firestoreSDK;
                await deleteDoc(doc(window.firestore, 'user-settings', employee.email));
                
                // Marquer le statut comme pas de compte
                employees[employeeIndex].accountStatus = 'no-account';
                await openEmployeeModal(); // Refresh de l'affichage
                
                alert(`‚úÖ Acc√®s supprim√© pour ${employee.firstName}`);

            } catch (error) {
                console.error('Erreur suppression acc√®s:', error);
                alert('Erreur lors de la suppression de l\'acc√®s');
            }
        }

        // Fonction am√©lior√©e pour changer le r√¥le d'un employ√©
        async function changeEmployeeRole(employeeIndex, newRole) {
            const employee = employees[employeeIndex];
            
            if (isPrimaryAdmin(employeeIndex)) {
                alert('‚ö†Ô∏è Impossible de modifier le r√¥le de l\'administrateur principal.');
                return;
            }

            const roleName = newRole === 'admin' ? 'Administrateur' : 'Utilisateur';
            const currentRoleName = employee.role === 'admin' ? 'Administrateur' : 'Utilisateur';
            
            if (!confirm(`Changer le r√¥le de ${employee.firstName} de ${currentRoleName} vers ${roleName} ?`)) {
                return;
            }

            try {
                employees[employeeIndex].role = newRole;
                
                // Si l'employ√© a un compte, mettre √† jour dans user-settings
                if (employee.email && employee.accountStatus !== 'no-account') {
                    const { doc, setDoc, getDoc } = window.firestoreSDK;
                    const userSettingsDoc = await getDoc(doc(window.firestore, 'user-settings', employee.email));
                    
                    if (userSettingsDoc.exists()) {
                        const existingData = userSettingsDoc.data();
                        await setDoc(doc(window.firestore, 'user-settings', employee.email), {
                            ...existingData,
                            role: newRole,
                            roleChangedAt: new Date().toISOString(),
                            roleChangedBy: currentUser.email
                        });
                    }
                }
                
                await saveEmployees();
                await openEmployeeModal(); // Refresh de l'affichage
                
                alert(`‚úÖ R√¥le de ${employee.firstName} chang√© vers ${roleName}`);

            } catch (error) {
                console.error('Erreur changement r√¥le:', error);
                alert('Erreur lors du changement de r√¥le');
            }
        }

        // Fonction pour envoyer des emails
        async function sendEmployeeEmail(employee, tempPassword, type) {
            try {
                let subject, message;
                
                if (type === 'creation') {
                    subject = `Bienvenue - Acc√®s au planning LATILLE`;
                    message = `Bonjour ${employee.firstName},

Votre compte a √©t√© cr√©√© pour acc√©der au syst√®me de planning LATILLE.

üîê VOS IDENTIFIANTS :
Email : ${employee.email}
Mot de passe temporaire : ${tempPassword}

‚ö†Ô∏è IMPORTANT :
- Vous devez changer ce mot de passe temporaire lors de votre premi√®re connexion
- Gardez ces identifiants en s√©curit√©

üìã ACC√àS AU PLANNING :
Connectez-vous sur : https://latille.github.io/PlanningLatille/

Vous pourrez consulter et imprimer vos plannings hebdomadaires.

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'√©quipe LATILLE`;
                } else {
                    subject = `R√©initialisation - Acc√®s au planning LATILLE`;
                    message = `Bonjour ${employee.firstName},

Votre mot de passe a √©t√© r√©initialis√©.

üîê NOUVEAUX IDENTIFIANTS :
Email : ${employee.email}
Nouveau mot de passe temporaire : ${tempPassword}

‚ö†Ô∏è IMPORTANT :
- Vous devez changer ce mot de passe temporaire lors de votre prochaine connexion
- Gardez ces identifiants en s√©curit√©

üìã ACC√àS AU PLANNING :
Connectez-vous sur : https://latille.github.io/PlanningLatille/

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'√©quipe LATILLE`;
                }

                const templateParams = {
                    to_name: employee.firstName,
                    to_email: employee.email,
                    from_name: 'LATILLE Distribution',
                    subject: subject,
                    message: message,
                    password_temp: tempPassword,
                    planning_url: 'https://latille.github.io/PlanningLatille/',
                    admin_email: 'latilledistribution@gmail.com'
                };

                await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                console.log(`Email envoy√© √† ${employee.email}`);

            } catch (error) {
                console.error(`Erreur envoi email √† ${employee.email}:`, error);
                throw error;
            }
        }

        // Modal employ√© am√©lior√©e pour la gestion des administrateurs multiples
        async function openEmployeeModal() {
            if (userRole !== 'admin') {
                alert('‚ö†Ô∏è Acc√®s refus√© : Vous devez √™tre administrateur pour g√©rer les employ√©s.');
                return;
            }
            
            await updateEmployeeAccountStatuses();
            
            const modal = document.getElementById('employeeModal');
            const container = document.getElementById('employeeManagement');
            container.innerHTML = '';
            
            for (let index = 0; index < employees.length; index++) {
                const employee = employees[index];
                const isPrimary = isPrimaryAdmin(index);
                
                const employeeDiv = document.createElement('div');
                employeeDiv.className = 'employee-management';
                
                // Statut badge am√©lior√©
                let statusClass = 'no-account';
                let statusText = 'Pas de compte';
                
                switch (employee.accountStatus) {
                    case 'active':
                        statusClass = 'active';
                        statusText = 'Actif';
                        break;
                    case 'pending':
                        statusClass = 'pending';
                        statusText = 'MDP temporaire';
                        break;
                    case 'no-account':
                    default:
                        statusClass = 'no-account';
                        statusText = 'Pas de compte';
                        break;
                }
                
                // Badge de r√¥le avec distinction super admin
                let roleClass = employee.role || 'user';
                let roleText = (employee.role === 'admin') ? 'Admin' : 'User';
                
                if (isPrimary) {
                    roleClass = 'super-admin';
                    roleText = 'Super Admin';
                }
                
                // Actions disponibles (am√©lior√©es et toujours visibles)
                let actionsHTML = '';
                
                // Section gestion de compte
                if (!isPrimary) {
                    if (employee.accountStatus === 'no-account') {
                        actionsHTML += `
                            <button class="action-btn create" onclick="createEmployeeAccount(${index})" ${!employee.email ? 'disabled' : ''}>
                                üë§ Cr√©er compte
                            </button>`;
                    } else {
                        actionsHTML += `
                            <button class="action-btn reset" onclick="resetEmployeePassword(${index})">
                                üîÑ R√©initialiser MDP
                            </button>
                            <button class="action-btn delete" onclick="deleteEmployeeAccess(${index})">
                                üóëÔ∏è Supprimer acc√®s
                            </button>`;
                    }
                }
                
                // Section gestion des r√¥les (TOUJOURS affich√©e pour non-admin-principal)
                if (!isPrimary) {
                    const currentRole = employee.role || 'user';
                    if (currentRole === 'user' || currentRole !== 'admin') {
                        actionsHTML += `
                            <button class="action-btn promote" onclick="changeEmployeeRole(${index}, 'admin')" title="Promouvoir cet employ√© au rang d'administrateur">
                                ‚¨ÜÔ∏è Promouvoir Admin
                            </button>`;
                    }
                    if (currentRole === 'admin') {
                        actionsHTML += `
                            <button class="action-btn demote" onclick="changeEmployeeRole(${index}, 'user')" title="R√©trograder cet administrateur au rang d'utilisateur">
                                ‚¨áÔ∏è R√©trograder User
                            </button>`;
                    }
                } else {
                    // Pour l'admin principal, afficher une explication
                    actionsHTML += `
                        <div style="font-size: 11px; color: #666; font-style: italic; margin-top: 4px;">
                            R√¥le fixe - Administrateur principal
                        </div>`;
                }
                
                // Notice de protection pour l'admin principal
                let protectionNotice = '';
                if (isPrimary) {
                    protectionNotice = `
                        <div class="admin-protection">
                            üîí Administrateur principal - Modifications prot√©g√©es
                        </div>`;
                } else {
                    // Aide contextuelle pour les autres employ√©s
                    protectionNotice = `
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 6px; border-radius: 4px; font-size: 11px; color: #0c4a6e; margin-top: 4px;">
                            üí° R√¥le actuel: <strong>${roleText}</strong> - ${(employee.role === 'admin') ? 'Peut g√©rer tous les plannings' : 'Acc√®s lecture seule aux plannings'}
                        </div>`;
                }
                
                employeeDiv.innerHTML = `
                    <div class="employee-header">
                        <div class="employee-title">${isPrimary ? 'Administrateur Principal' : `Employ√© ${index + 1}`}</div>
                        <div class="employee-status">
                            <span class="status-badge ${roleClass}">${roleText}</span>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="employee-details">
                        <input type="text" class="employee-input" value="${employee.firstName}" 
                               placeholder="Pr√©nom" id="employee-firstName-${index}" 
                               ${isPrimary ? 'readonly' : ''} oninput="formatFirstName(this)">
                        <input type="text" class="employee-input" value="${employee.lastName}" 
                               placeholder="Nom" id="employee-lastName-${index}" 
                               ${isPrimary ? 'readonly' : ''} oninput="formatLastName(this)">
                        <input type="email" class="employee-input" value="${employee.email}" 
                               placeholder="Email" id="employee-email-${index}" 
                               ${isPrimary ? 'readonly' : ''} oninput="formatEmail(this)">
                    </div>
                    <div class="employee-actions">
                        ${actionsHTML}
                    </div>
                    ${protectionNotice}
                `;
                
                container.appendChild(employeeDiv);
            }
            
            modal.style.display = 'block';
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        // Fonctions de formatage automatique
        function formatFirstName(input) {
            let value = input.value;
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                input.value = value;
            }
        }

        function formatLastName(input) {
            input.value = input.value.toUpperCase();
        }

        function formatEmail(input) {
            input.value = input.value.toLowerCase();
        }

        function saveEmployees() {
            if (userRole !== 'admin') return;
            
            const newEmployees = [];
            for (let i = 0; i < 5; i++) {
                if (isPrimaryAdmin(i)) {
                    // Conserver l'admin principal tel quel
                    newEmployees.push(employees[4]);
                } else {
                    const firstName = document.getElementById(`employee-firstName-${i}`).value || '';
                    const lastName = document.getElementById(`employee-lastName-${i}`).value || '';
                    const email = document.getElementById(`employee-email-${i}`).value || '';
                    
                    newEmployees.push({
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        role: employees[i].role || 'user',
                        accountStatus: employees[i].accountStatus || 'no-account'
                    });
                }
            }
            
            employees = newEmployees;
            updateScheduleDisplay();
            closeEmployeeModal();
            
            saveSchedulesToFirebase().then(success => {
                if (success) {
                    alert('Informations des employ√©s sauvegard√©es !');
                } else {
                    alert('Erreur lors de la sauvegarde');
                }
            });
        }

        // Fonctions de version et validation
        function updateVersionInfo() {
            const weekVersion = getCurrentWeekVersion();
            const versionStr = `S${currentWeek}/${currentYear} - ${weekVersion.date} - v${weekVersion.number}`;
            document.getElementById('versionInfo').textContent = versionStr;
        }

        async function validatePlanning() {
            try {
                const weekKey = `${currentYear}-${currentWeek}`;
                
                // Incr√©menter la version de la semaine courante
                const newVersion = incrementCurrentWeekVersion();

                // Marquer comme valid√© dans le nouveau syst√®me
                markCurrentWeekAsValidated();
                
                const validatedAt = new Date().toISOString();

                const planningData = {
                    schedule: schedules[weekKey] || {},
                    closure: closures[weekKey] || {},
                    version: newVersion,
                    validated: true,
                    validatedBy: currentUser.email,
                    validatedAt: validatedAt
                };

                // Mettre √† jour les informations de validation localement
                weekValidationInfo[weekKey] = {
                    validatedAt: validatedAt,
                    version: newVersion,
                    validatedBy: currentUser.email
                };

                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'planning-data', `validated-${weekKey}`), planningData);

                // Sauvegarder les versions
                await setDoc(doc(window.firestore, 'planning-data', 'week-versions'), {
                    versions: weekVersions,
                    lastUpdated: new Date().toISOString()
                });

                // Sauvegarder les informations de validation
                await setDoc(doc(window.firestore, 'planning-data', 'week-validation-info'), {
                    validationInfo: weekValidationInfo,
                    lastUpdated: new Date().toISOString()
                });

                await sendPlanningNotifications(weekKey);

                updateValidationDisplay();
                updateVersionInfo();
                updateSummaryTitle(); // Mettre √† jour le titre du r√©sum√©
                alert('Planning valid√© et notifications envoy√©es !');

            } catch (error) {
                console.error('Erreur validation:', error);
                alert('Erreur lors de la validation');
            }
        }

        async function sendPlanningNotifications(weekKey) {
            try {
                const concernedEmployees = [];
                const weekSchedule = schedules[weekKey];
                
                if (weekSchedule) {
                    for (let empIndex = 0; empIndex < employees.length; empIndex++) {
                        let hasHours = false;
                        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                            if (weekSchedule[dayIndex]) {
                                for (let slotIndex = 0; slotIndex < timeSlots.length; slotIndex++) {
                                    if (weekSchedule[dayIndex][slotIndex] && weekSchedule[dayIndex][slotIndex][empIndex]) {
                                        hasHours = true;
                                        break;
                                    }
                                }
                            }
                            if (hasHours) break;
                        }
                        
                        if (hasHours && employees[empIndex].email) {
                            concernedEmployees.push(employees[empIndex]);
                        }
                    }
                }

                if (!concernedEmployees.find(emp => emp.email === 'latilledistribution@gmail.com')) {
                    concernedEmployees.push(employees[4]);
                }

                const pdfBlob = await generatePlanningPDF(weekKey);
                const pdfBase64 = await blobToBase64(pdfBlob);

                for (const employee of concernedEmployees) {
                    if (employee.email) {
                        await sendPlanningEmail(employee, weekKey, pdfBase64);
                    }
                }

            } catch (error) {
                console.error('Erreur envoi notifications:', error);
                throw error;
            }
        }

        async function sendPlanningEmail(employee, weekKey, pdfBase64) {
            try {
                const weekVersion = getCurrentWeekVersion();
                const message = `Bonjour ${employee.firstName},

Voici le planning valid√© pour la semaine ${currentWeek}/${currentYear}.

üìã PLANNING SEMAINE ${currentWeek} - ${currentYear}
Version : ${weekVersion.number}
Date de validation : ${weekVersion.date}

Le planning est en pi√®ce jointe au format PDF.

üåê ACC√àS EN LIGNE :
Vous pouvez aussi consulter vos plannings sur : https://latille.github.io/PlanningLatille/

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'√©quipe LATILLE`;

                const templateParams = {
                    to_name: employee.firstName,
                    to_email: employee.email,
                    from_name: 'LATILLE Distribution',
                    subject: `Planning Semaine ${currentWeek}/${currentYear} - Version ${weekVersion.number}`,
                    message: message,
                    planning_url: 'https://latille.github.io/PlanningLatille/',
                    admin_email: 'latilledistribution@gmail.com'
                };

                await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                console.log(`Email planning envoy√© √† ${employee.email}`);

            } catch (error) {
                console.error(`Erreur envoi email planning √† ${employee.email}:`, error);
            }
        }

        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // G√©n√©ration PDF
        async function generatePlanningPDF(weekKey) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            const dates = getWeekDates(currentYear, currentWeek);
            const weekVersion = getCurrentWeekVersion();

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PLANNING SPAR LATILLE', pageWidth / 2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Semaine ${currentWeek} - ${currentYear}`, pageWidth / 2, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Du ${dates[0].toLocaleDateString('fr-FR')} au ${dates[6].toLocaleDateString('fr-FR')}`, pageWidth / 2, 35, { align: 'center' });

            doc.setFontSize(8);
            const versionStr = `S${currentWeek}/${currentYear} - ${weekVersion.date} - v${weekVersion.number}`;
            doc.text(versionStr, pageWidth - margin, pageHeight - 5, { align: 'right' });

            const tableData = [];
            const headerRow = ['Horaires'];
            const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            for (let i = 0; i < 7; i++) {
                headerRow.push(`${dayNames[i]}\n${dates[i].toLocaleDateString('fr-FR')}`);
            }
            tableData.push(headerRow);

            const employeeRow = ['Employ√©s'];
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const dayEmployees = employees.map(emp => emp.firstName).join(' | ');
                employeeRow.push(dayEmployees);
            }
            tableData.push(employeeRow);

            timeSlots.forEach((slot, slotIndex) => {
                const row = [`${slot.start}-${slot.end}`];
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    let cellContent = '';
                    employees.forEach((employee, empIndex) => {
                        if (schedules[weekKey] && 
                            schedules[weekKey][dayIndex] && 
                            schedules[weekKey][dayIndex][slotIndex] && 
                            schedules[weekKey][dayIndex][slotIndex][empIndex]) {
                            cellContent += employee.firstName + ' ';
                        }
                    });
                    
                    if (isSlotClosed(dayIndex, slotIndex)) {
                        cellContent = 'FERM√â';
                    }
                    
                    row.push(cellContent.trim());
                }
                tableData.push(row);
            });

            doc.autoTable({
                startY: 45,
                head: [tableData[0], tableData[1]],
                body: tableData.slice(2),
                styles: {
                    fontSize: 6,
                    cellPadding: 1,
                },
                headStyles: {
                    fillColor: [26, 37, 47],
                    textColor: 255,
                    fontSize: 7,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 20, fontStyle: 'bold' }
                },
                margin: { left: margin, right: margin }
            });

            return doc.output('blob');
        }

        // Initialisation de l'application
        window.initializeApp = function() {
            if (!window.firebaseReady || !window.emailjsReady) {
                setTimeout(window.initializeApp, 100);
                return;
            }

            const { onAuthStateChanged } = window.authSDK;
            onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    currentUser = user;
                    userRole = determineUserRole(user.email);
                    
                    await checkPasswordChangeRequired(user.email);
                    
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    if (mustChangePassword) {
                        openPasswordModal();
                        alert('‚ö†Ô∏è Premi√®re connexion d√©tect√©e !\nVous devez changer votre mot de passe temporaire.');
                    }
                    
                    populateSelectors();
                    loadEmployees();
                    loadSchedulesFromFirebase();
                    updateScheduleDisplay();
                    updateVersionInfo();
                    
                } else {
                    document.getElementById('loginModal').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    currentUser = null;
                    userRole = null;
                    mustChangePassword = false;
                }
            });
        };

        // Fonction pour calculer le num√©ro de semaine ISO 8601
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getWeekDates(year, week) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const firstMondayOfYear = new Date(jan4);
            firstMondayOfYear.setDate(jan4.getDate() - jan4Day + 1);
            const mondayOfWeek = new Date(firstMondayOfYear);
            mondayOfWeek.setDate(firstMondayOfYear.getDate() + (week - 1) * 7);
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(mondayOfWeek);
                date.setDate(mondayOfWeek.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        // Firebase functions avec v√©rification de permissions
        async function saveSchedulesToFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK || userRole !== 'admin') {
                return false;
            }

            try {
                const { doc, setDoc } = window.firestoreSDK;
                
                await setDoc(doc(window.firestore, 'planning-data', 'employees'), {
                    employees: employees,
                    lastUpdated: new Date().toISOString()
                });

                // Sauvegarder les versions par semaine
                await setDoc(doc(window.firestore, 'planning-data', 'week-versions'), {
                    versions: weekVersions,
                    lastUpdated: new Date().toISOString()
                });

                for (const [key, schedule] of Object.entries(schedules)) {
                    await setDoc(doc(window.firestore, 'planning-data', `schedule-${key}`), {
                        schedule: schedule,
                        lastUpdated: new Date().toISOString()
                    });
                }

                for (const [key, closure] of Object.entries(closures)) {
                    await setDoc(doc(window.firestore, 'planning-data', `closure-${key}`), {
                        closure: closure,
                        lastUpdated: new Date().toISOString()
                    });
                }

                // Marquer la semaine courante comme modifi√©e
                markCurrentWeekAsModified();

                console.log('Donn√©es sauvegard√©es sur Firebase');
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                return false;
            }
        }

        async function loadSchedulesFromFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                loadEmployees();
                return;
            }

            try {
                const { doc, getDoc, collection, getDocs } = window.firestoreSDK;
                
                const employeesDoc = await getDoc(doc(window.firestore, 'planning-data', 'employees'));
                if (employeesDoc.exists()) {
                    employees = employeesDoc.data().employees || employees;
                }

                // Charger les versions par semaine
                const versionsDoc = await getDoc(doc(window.firestore, 'planning-data', 'week-versions'));
                if (versionsDoc.exists()) {
                    weekVersions = versionsDoc.data().versions || {};
                }

                // IMPORTANT : Charger les √©tats de modification EN PREMIER
                const modificationsDoc = await getDoc(doc(window.firestore, 'planning-data', 'week-modifications'));
                if (modificationsDoc.exists()) {
                    const data = modificationsDoc.data();
                    weekModifications = data.modifications || {};
                    weekValidations = data.validations || {};
                    console.log('√âtats de modification charg√©s:', weekModifications);
                    console.log('√âtats de validation charg√©s:', weekValidations);
                }

                // Charger les informations de validation par semaine
                const validationInfoDoc = await getDoc(doc(window.firestore, 'planning-data', 'week-validation-info'));
                if (validationInfoDoc.exists()) {
                    weekValidationInfo = validationInfoDoc.data().validationInfo || {};
                }

                const planningCollection = collection(window.firestore, 'planning-data');
                const snapshot = await getDocs(planningCollection);
                
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id;
                    
                    if (docId.startsWith('schedule-')) {
                        const key = docId.replace('schedule-', '');
                        schedules[key] = data.schedule;
                    } else if (docId.startsWith('closure-')) {
                        const key = docId.replace('closure-', '');
                        closures[key] = data.closure;
                    } else if (docId.startsWith('validated-')) {
                        const key = docId.replace('validated-', '');
                        if (key === `${currentYear}-${currentWeek}`) {
                            // Utiliser le nouveau syst√®me
                            if (data.validated) {
                                weekValidations[key] = true;
                                weekModifications[key] = false;
                            }
                            
                            // Charger la version sp√©cifique de cette semaine si elle existe
                            if (data.version) {
                                weekVersions[key] = data.version;
                            }
                            // Charger les informations de validation
                            if (data.validatedAt) {
                                weekValidationInfo[key] = {
                                    validatedAt: data.validatedAt,
                                    version: data.version,
                                    validatedBy: data.validatedBy
                                };
                            }
                        }
                    }
                });

                console.log('Donn√©es charg√©es depuis Firebase');
                
                // Forcer la mise √† jour de l'affichage de validation apr√®s chargement
                setTimeout(() => {
                    updateValidationDisplay();
                }, 100);
                
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                loadEmployees();
            }
        }

        function setupRealtimeListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;

            // Nettoyer les anciens listeners
            Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
            activeListeners = {};

            // √âcouter les changements des employ√©s
            activeListeners.employees = onSnapshot(
                doc(window.firestore, 'planning-data', 'employees'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newEmployees = docSnapshot.data().employees;
                        if (JSON.stringify(newEmployees) !== JSON.stringify(employees)) {
                            isUpdatingFromFirebase = true;
                            employees = newEmployees;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log('üîÑ Employ√©s mis √† jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener employ√©s:', error)
            );

            // √âcouter les changements de la semaine courante
            setupCurrentWeekListeners();
        }

        function setupCurrentWeekListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;
            const currentKey = `${currentYear}-${currentWeek}`;

            // Nettoyer les listeners de la semaine pr√©c√©dente
            if (activeListeners.currentSchedule) {
                activeListeners.currentSchedule();
                delete activeListeners.currentSchedule;
            }
            if (activeListeners.currentClosure) {
                activeListeners.currentClosure();
                delete activeListeners.currentClosure;
            }
            if (activeListeners.currentValidated) {
                activeListeners.currentValidated();
                delete activeListeners.currentValidated;
            }
            if (activeListeners.weekVersions) {
                activeListeners.weekVersions();
                delete activeListeners.weekVersions;
            }
            if (activeListeners.validationInfo) {
                activeListeners.validationInfo();
                delete activeListeners.validationInfo;
            }
            if (activeListeners.weekModifications) {
                activeListeners.weekModifications();
                delete activeListeners.weekModifications;
            }

            // √âcouter les changements du planning de la semaine courante
            activeListeners.currentSchedule = onSnapshot(
                doc(window.firestore, 'planning-data', `schedule-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newSchedule = docSnapshot.data().schedule;
                        if (JSON.stringify(newSchedule) !== JSON.stringify(schedules[currentKey])) {
                            isUpdatingFromFirebase = true;
                            schedules[currentKey] = newSchedule;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üîÑ Planning semaine ${currentKey} mis √† jour depuis Firebase`);
                        }
                    } else {
                        if (schedules[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete schedules[currentKey];
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üóëÔ∏è Planning semaine ${currentKey} supprim√©`);
                        }
                    }
                },
                (error) => console.error('Erreur listener planning:', error)
            );

            // √âcouter les changements des fermetures de la semaine courante
            activeListeners.currentClosure = onSnapshot(
                doc(window.firestore, 'planning-data', `closure-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newClosure = docSnapshot.data().closure;
                        if (JSON.stringify(newClosure) !== JSON.stringify(closures[currentKey])) {
                            isUpdatingFromFirebase = true;
                            closures[currentKey] = newClosure;
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üîÑ Fermetures semaine ${currentKey} mises √† jour depuis Firebase`);
                        }
                    } else {
                        if (closures[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete closures[currentKey];
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`üóëÔ∏è Fermetures semaine ${currentKey} supprim√©es`);
                        }
                    }
                },
                (error) => console.error('Erreur listener fermetures:', error)
            );

            // √âcouter les changements de validation
            activeListeners.currentValidated = onSnapshot(
                doc(window.firestore, 'planning-data', `validated-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        
                        // Utiliser le nouveau syst√®me
                        if (data.validated) {
                            weekValidations[currentKey] = true;
                            weekModifications[currentKey] = false;
                        }
                        
                        // Mettre √† jour la version sp√©cifique de cette semaine
                        if (data.version) {
                            weekVersions[currentKey] = data.version;
                        }
                        
                        // Mettre √† jour les informations de validation
                        if (data.validatedAt) {
                            weekValidationInfo[currentKey] = {
                                validatedAt: data.validatedAt,
                                version: data.version,
                                validatedBy: data.validatedBy
                            };
                        }
                        
                        updateValidationDisplay();
                        updateVersionInfo();
                        updateSummaryTitle(); // Mettre √† jour le titre du r√©sum√©
                        console.log(`üîÑ Validation semaine ${currentKey} mise √† jour`);
                    }
                },
                (error) => console.error('Erreur listener validation:', error)
            );

            // √âcouter les changements des √©tats de modification
            activeListeners.weekModifications = onSnapshot(
                doc(window.firestore, 'planning-data', 'week-modifications'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const newModifications = data.modifications || {};
                        const newValidations = data.validations || {};
                        
                        if (JSON.stringify(newModifications) !== JSON.stringify(weekModifications) ||
                            JSON.stringify(newValidations) !== JSON.stringify(weekValidations)) {
                            isUpdatingFromFirebase = true;
                            weekModifications = newModifications;
                            weekValidations = newValidations;
                            updateValidationDisplay();
                            isUpdatingFromFirebase = false;
                            console.log('üîÑ √âtats de modification mis √† jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener modifications:', error)
            );

            // √âcouter les changements des versions par semaine
            activeListeners.weekVersions = onSnapshot(
                doc(window.firestore, 'planning-data', 'week-versions'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newVersions = docSnapshot.data().versions;
                        if (JSON.stringify(newVersions) !== JSON.stringify(weekVersions)) {
                            isUpdatingFromFirebase = true;
                            weekVersions = newVersions || {};
                            updateVersionInfo();
                            isUpdatingFromFirebase = false;
                            console.log('üîÑ Versions par semaine mises √† jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener versions:', error)
            );

            // √âcouter les changements des informations de validation
            activeListeners.validationInfo = onSnapshot(
                doc(window.firestore, 'planning-data', 'week-validation-info'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newValidationInfo = docSnapshot.data().validationInfo;
                        if (JSON.stringify(newValidationInfo) !== JSON.stringify(weekValidationInfo)) {
                            isUpdatingFromFirebase = true;
                            weekValidationInfo = newValidationInfo || {};
                            updateSummaryTitle(); // Mettre √† jour le titre du r√©sum√©
                            isUpdatingFromFirebase = false;
                            console.log('üîÑ Informations de validation mises √† jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener informations validation:', error)
            );
        }

        function populateSelectors() {
            const weekSelect = document.getElementById('weekSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            weekSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                weekSelect.appendChild(option);
            }
            
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            weekSelect.addEventListener('change', (e) => {
                currentWeek = parseInt(e.target.value);
                updateScheduleDisplay();
            });
            
            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                updateScheduleDisplay();
            });
        }

        function loadEmployees() {
            if (employees.length !== 5) {
                employees = [
                    { firstName: 'Antoine', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
                    { firstName: 'L√©a', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
                    { firstName: 'No√©mie', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
                    { firstName: 'Christelle', lastName: '', email: '', role: 'user', accountStatus: 'no-account' },
                    { firstName: 'Admin', lastName: 'LATILLE', email: 'latilledistribution@gmail.com', role: 'admin', accountStatus: 'active' }
                ];
            }
        }

        function changeWeek(direction) {
            const newWeek = currentWeek + direction;
            
            if (newWeek >= 1 && newWeek <= 53) {
                currentWeek = newWeek;
                document.getElementById('weekSelect').value = currentWeek;
                updateScheduleDisplay();
            } else if (newWeek === 0) {
                if (currentYear > 2024) {
                    currentYear--;
                    currentWeek = 53;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            } else if (newWeek === 54) {
                if (currentYear < 2030) {
                    currentYear++;
                    currentWeek = 1;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            }
        }

        function updateScheduleDisplay() {
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Update dates in headers
            days.forEach((day, index) => {
                document.getElementById(`${day}-date`).textContent = formatDate(dates[index]);
            });
            
            // Update employee names in each day
            days.forEach(day => {
                const container = document.getElementById(`${day}-employees`);
                container.innerHTML = '';
                employees.forEach(employee => {
                    const label = document.createElement('div');
                    label.className = 'employee-label';
                    label.textContent = employee.firstName || 'Employ√©';
                    container.appendChild(label);
                });
            });
            
            generateTimeSlots();
            updateSummary();
            updateClosureDisplay();
            updateUIForRole();
            updateVersionInfo();
            updateSummaryTitle(); // Mettre √† jour le titre avec les informations de validation
            
            // Charger les √©tats de modification pour la nouvelle semaine
            loadCurrentWeekStates();
            
            // Mettre √† jour les listeners pour la nouvelle semaine (seulement si pas de mise √† jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                setupCurrentWeekListeners();
            }
        }

        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            timeSlots.forEach((slot, slotIndex) => {
                const row = document.createElement('div');
                row.className = 'time-row';
                
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                timeCell.textContent = `${slot.start}-${slot.end}`;
                row.appendChild(timeCell);
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, dayIndex) => {
                    const scheduleCell = document.createElement('div');
                    scheduleCell.className = 'schedule-cell';
                    
                    employees.forEach((employee, empIndex) => {
                        const timeSlotDiv = document.createElement('div');
                        timeSlotDiv.className = 'time-slot';
                        timeSlotDiv.dataset.day = dayIndex;
                        timeSlotDiv.dataset.slot = slotIndex;
                        timeSlotDiv.dataset.employee = empIndex;
                        
                        const defaultClass = getDefaultClass(slot.start, dayIndex);
                        if (defaultClass) {
                            timeSlotDiv.classList.add(defaultClass);
                        }
                        
                        const scheduleKey = `${currentYear}-${currentWeek}`;
                        if (schedules[scheduleKey] && schedules[scheduleKey][dayIndex] && schedules[scheduleKey][dayIndex][slotIndex] && schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            timeSlotDiv.className = 'time-slot employee-' + (empIndex + 1);
                        }
                        
                        if (userRole === 'admin') {
                            let mouseDownTime = 0;
                            let hasMoved = false;
                            
                            // Gestion des √©v√©nements pour le drag & drop
                            timeSlotDiv.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                mouseDownTime = Date.now();
                                hasMoved = false;
                                startDragSelection(timeSlotDiv, dayIndex, slotIndex, empIndex, e);
                            });
                            
                            timeSlotDiv.addEventListener('mouseenter', (e) => {
                                if (isDragging) {
                                    hasMoved = true;
                                    updateDragSelection(timeSlotDiv, dayIndex, slotIndex, empIndex);
                                }
                            });
                            
                            timeSlotDiv.addEventListener('mouseup', (e) => {
                                const clickDuration = Date.now() - mouseDownTime;
                                // Si c'est un clic rapide sans mouvement, consid√©rer comme un clic simple
                                if (!hasMoved && clickDuration < 200) {
                                    // Annuler le drag
                                    document.querySelectorAll('.drag-preview, .drag-invalid').forEach(slot => {
                                        slot.classList.remove('drag-preview', 'drag-invalid');
                                    });
                                    isDragging = false;
                                    draggedSlots.clear();
                                    document.body.style.userSelect = '';
                                    
                                    // Ex√©cuter le toggle normal
                                    toggleTimeSlot(timeSlotDiv, dayIndex, slotIndex, empIndex);
                                }
                            });
                        }
                        
                        scheduleCell.appendChild(timeSlotDiv);
                    });
                    
                    row.appendChild(scheduleCell);
                });
                
                container.appendChild(row);
            });
        }

        function toggleTimeSlot(element, dayIndex, slotIndex, empIndex) {
            if (userRole !== 'admin') return;
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
            if (!schedules[scheduleKey][dayIndex]) schedules[scheduleKey][dayIndex] = {};
            if (!schedules[scheduleKey][dayIndex][slotIndex]) schedules[scheduleKey][dayIndex][slotIndex] = {};
            
            const isActive = schedules[scheduleKey][dayIndex][slotIndex][empIndex];
            schedules[scheduleKey][dayIndex][slotIndex][empIndex] = !isActive;
            
            if (schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                element.className = 'time-slot employee-' + (empIndex + 1);
            } else {
                element.className = 'time-slot';
                const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dayIndex);
                if (defaultClass) {
                    element.classList.add(defaultClass);
                }
            }
            
            updateSummary();
            saveSchedulesToFirebase();
        }

        function getDefaultClass(timeStart, dayIndex) {
            if (defaultGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            if (dayIndex === 6 && sundayGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            if (defaultGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            if (dayIndex < 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            if (dayIndex === 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-gray';
            }
            return null;
        }

        function updateSummary() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';
            
            // Mettre √† jour le titre avec les informations de validation
            updateSummaryTitle();
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const employeeTotals = [0, 0, 0, 0, 0];
            const dailyTotals = [0, 0, 0, 0, 0, 0, 0];
            
            employees.forEach((employee, empIndex) => {
                let totalMinutes = 0;
                
                days.forEach((day, dayIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    dailyTotals[dayIndex] += dailyMinutes;
                });
                
                employeeTotals[empIndex] = totalMinutes;
                
                const card = document.createElement('div');
                card.className = 'employee-summary';
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hoursDisplay = `${hours}h${minutes.toString().padStart(2, '0')}`;
                
                const remaining = (35 * 60) - totalMinutes;
                const remainingHours = Math.floor(Math.abs(remaining) / 60);
                const remainingMinutes = Math.abs(remaining) % 60;
                const remainingDisplay = `${remaining < 0 ? '-' : ''}${remainingHours}h${remainingMinutes.toString().padStart(2, '0')}`;
                
                if (totalMinutes === 0) {
                    card.classList.add('hours-zero');
                } else if (totalMinutes === 35 * 60) {
                    card.classList.add('hours-complete');
                } else {
                    card.classList.add('hours-partial');
                }
                
                card.innerHTML = `
                    <div class="employee-name">${employee.firstName || 'Employ√©'}</div>
                    <div class="hours-total">${hoursDisplay} hebdo</div>
                    <div class="hours-remaining ${remaining < 0 ? 'hours-negative' : ''}">(reste ${remainingDisplay} √† r√©partir)</div>
                `;
                summaryGrid.appendChild(card);
            });
            
            // Update daily totals
            days.forEach((day, dayIndex) => {
                const container = document.getElementById(`${day}-totals`);
                container.innerHTML = '';
                
                const totalsDiv = document.createElement('div');
                totalsDiv.className = 'daily-employee-totals';
                
                employees.forEach((employee, empIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    const hours = Math.floor(dailyMinutes / 60);
                    const minutes = dailyMinutes % 60;
                    const display = `${hours}h${minutes.toString().padStart(2, '0')}`;
                    
                    const empTotal = document.createElement('div');
                    empTotal.textContent = display;
                    totalsDiv.appendChild(empTotal);
                });
                
                container.appendChild(totalsDiv);
                
                const teamHours = Math.floor(dailyTotals[dayIndex] / 60);
                const teamMinutes = dailyTotals[dayIndex] % 60;
                const teamElement = document.getElementById(`${day}-team-total`);
                teamElement.textContent = `${teamHours}h${teamMinutes.toString().padStart(2, '0')}`;
                teamElement.style.fontSize = '10px';
            });
        }

        // Fonctions pour la duplication de planning
        function openDuplicateModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('duplicateModal');
            populateDuplicateSelectors();
            updateDuplicateInfo();
            modal.style.display = 'block';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        function populateDuplicateSelectors() {
            const sourceWeek = document.getElementById('sourceWeek');
            const sourceYear = document.getElementById('sourceYear');
            const destWeek = document.getElementById('destWeek');
            const destYear = document.getElementById('destYear');
            
            // Vider les s√©lecteurs
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.innerHTML = '';
            });
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) sourceOption.selected = true;
                sourceWeek.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) destOption.selected = true;
                destWeek.appendChild(destOption);
            }
            
            // Remplir les ann√©es
            for (let i = 2024; i <= 2030; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = i;
                if (i === currentYear) sourceOption.selected = true;
                sourceYear.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = i;
                if (i === currentYear) destOption.selected = true;
                destYear.appendChild(destOption);
            }
            
            // Ajouter les √©v√©nements de changement
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.addEventListener('change', updateDuplicateInfo);
            });
        }

        function updateDuplicateInfo() {
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            const infoDiv = document.getElementById('duplicateInfo');
            
            let message = '';
            let isValid = true;
            
            // V√©rifier si m√™me semaine
            if (sourceWeek === destWeek && sourceYear === destYear) {
                message = '‚ùå La semaine source et destination ne peuvent pas √™tre identiques.';
                isValid = false;
            } else {
                // V√©rifier si la source a des donn√©es
                const sourceKey = `${sourceYear}-${sourceWeek}`;
                const hasSourceData = schedules[sourceKey] && Object.keys(schedules[sourceKey]).length > 0;
                const hasSourceClosures = closures[sourceKey] && Object.keys(closures[sourceKey]).length > 0;
                
                if (!hasSourceData && !hasSourceClosures) {
                    message = '‚ö†Ô∏è La semaine source ne contient aucun planning.';
                    isValid = false;
                } else {
                    // V√©rifier si destination a des donn√©es
                    const destKey = `${destYear}-${destWeek}`;
                    const hasDestData = schedules[destKey] && Object.keys(schedules[destKey]).length > 0;
                    const hasDestClosures = closures[destKey] && Object.keys(closures[destKey]).length > 0;
                    
                    if (hasDestData || hasDestClosures) {
                        message = '‚ö†Ô∏è La semaine destination contient d√©j√† un planning qui sera √©cras√©.';
                    } else {
                        message = '‚úÖ Pr√™t √† dupliquer le planning.';
                    }
                }
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? (message.includes('√©cras√©') ? '#ff9800' : '#4caf50') : '#f44336';
            
            // Activer/d√©sactiver le bouton
            const duplicateBtn = document.querySelector('#duplicateModal .btn-save');
            duplicateBtn.disabled = !isValid;
            duplicateBtn.style.opacity = isValid ? '1' : '0.5';
            duplicateBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function duplicatePlanning() {
            if (userRole !== 'admin') return;
            
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            
            const sourceKey = `${sourceYear}-${sourceWeek}`;
            const destKey = `${destYear}-${destWeek}`;
            
            try {
                // Copier les plannings localement
                if (schedules[sourceKey]) {
                    schedules[destKey] = JSON.parse(JSON.stringify(schedules[sourceKey]));
                } else {
                    delete schedules[destKey];
                }
                
                // Copier les fermetures localement
                if (closures[sourceKey]) {
                    closures[destKey] = JSON.parse(JSON.stringify(closures[sourceKey]));
                } else {
                    delete closures[destKey];
                }
                
                // Sauvegarder sur Firebase
                await saveSchedulesToFirebase();
                
                // Basculer vers la semaine dupliqu√©e
                currentWeek = destWeek;
                currentYear = destYear;
                document.getElementById('weekSelect').value = currentWeek;
                document.getElementById('yearSelect').value = currentYear;
                
                // Fermer la modal
                closeDuplicateModal();
                
                // Forcer la mise √† jour de l'affichage
                setTimeout(() => {
                    updateScheduleDisplay();
                }, 100);
                
                alert(`Planning dupliqu√© avec succ√®s vers la semaine ${destWeek}/${destYear} !`);
                
            } catch (error) {
                console.error('Erreur lors de la duplication:', error);
                alert('Erreur lors de la duplication.');
            }
        }

        // Fonctions pour la r√©initialisation de planning
        function openResetModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('resetModal');
            populateResetSelectors();
            updateResetInfo();
            modal.style.display = 'block';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function populateResetSelectors() {
            const resetWeek = document.getElementById('resetWeek');
            const resetYear = document.getElementById('resetYear');
            
            // Vider les s√©lecteurs
            resetWeek.innerHTML = '';
            resetYear.innerHTML = '';
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                resetWeek.appendChild(option);
            }
            
            // Remplir les ann√©es
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                resetYear.appendChild(option);
            }
            
            // Ajouter les √©v√©nements de changement
            resetWeek.addEventListener('change', updateResetInfo);
            resetYear.addEventListener('change', updateResetInfo);
        }

        function updateResetInfo() {
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            const infoDiv = document.getElementById('resetInfo');
            
            let message = '';
            let isValid = true;
            
            // V√©rifier si la semaine a des donn√©es
            const resetKey = `${resetYear}-${resetWeek}`;
            const hasData = schedules[resetKey] && Object.keys(schedules[resetKey]).length > 0;
            const hasClosures = closures[resetKey] && Object.keys(closures[resetKey]).length > 0;
            
            if (!hasData && !hasClosures) {
                message = '‚ö†Ô∏è Cette semaine ne contient aucun planning √† r√©initialiser.';
                isValid = false;
            } else {
                message = `‚úÖ Pr√™t √† r√©initialiser la semaine ${resetWeek}/${resetYear}.`;
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? '#4caf50' : '#f44336';
            
            // Activer/d√©sactiver le bouton
            const resetBtn = document.querySelector('#resetModal .btn');
            resetBtn.disabled = !isValid;
            resetBtn.style.opacity = isValid ? '1' : '0.5';
            resetBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function resetPlanning() {
            if (userRole !== 'admin') return;
            
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            
            if (!confirm(`√ätes-vous absolument s√ªr de vouloir r√©initialiser la semaine ${resetWeek}/${resetYear} ?\n\nCette action supprimera d√©finitivement :\n- Tous les plannings des employ√©s\n- Tous les √©tats de fermeture\n\nCette action est IRR√âVERSIBLE.`)) {
                return;
            }
            
            const resetKey = `${resetYear}-${resetWeek}`;
            
            try {
                // Supprimer les donn√©es localement
                delete schedules[resetKey];
                delete closures[resetKey];
                
                // Sauvegarder sur Firebase
                await saveSchedulesToFirebase();
                
                // Fermer la modal
                closeResetModal();
                
                // Si c'est la semaine actuellement affich√©e, forcer la mise √† jour
                if (resetWeek === currentWeek && resetYear === currentYear) {
                    setTimeout(() => {
                        updateScheduleDisplay();
                    }, 100);
                }
                
                alert(`Semaine ${resetWeek}/${resetYear} r√©initialis√©e avec succ√®s !`);
                
            } catch (error) {
                console.error('Erreur lors de la r√©initialisation:', error);
                alert('Erreur lors de la r√©initialisation.');
            }
        }

        // Fonctions d'envoi d'email am√©lior√©es
        async function sendByEmail() {
            if (userRole === 'admin') {
                // Administrateur : ouvrir la modal de s√©lection des destinataires
                openEmailModal();
            } else {
                // Utilisateur : s'envoyer le planning √† lui-m√™me
                await sendPlanningToUser();
            }
        }

        function openEmailModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('emailModal');
            const recipientsContainer = document.getElementById('emailRecipients');
            const weekVersion = getCurrentWeekVersion();
            
            // Mettre √† jour les informations du planning
            document.getElementById('emailWeekInfo').textContent = `${currentWeek}/${currentYear}`;
            document.getElementById('emailVersionInfo').textContent = `Version ${weekVersion.number} - ${weekVersion.date}`;
            
            // G√©n√©rer la liste des destinataires
            recipientsContainer.innerHTML = '';
            
            employees.forEach((employee, index) => {
                // Ignorer les employ√©s sans email
                if (!employee.email) return;
                
                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'email-recipient';
                
                const hasValidEmail = employee.email && employee.email.includes('@');
                const statusText = hasValidEmail ? 'Email valide' : 'Pas d\'email';
                const statusClass = hasValidEmail ? '' : 'no-email';
                
                recipientDiv.innerHTML = `
                    <label>
                        <input type="checkbox" value="${index}" onchange="updateSendButton()" ${!hasValidEmail ? 'disabled' : ''}>
                        <div class="recipient-info">
                            <div class="recipient-details">
                                <div class="recipient-name">${employee.firstName} ${employee.lastName}</div>
                                <div class="recipient-email">${employee.email}</div>
                            </div>
                            <div class="recipient-status ${statusClass}">${statusText}</div>
                        </div>
                    </label>
                `;
                
                recipientsContainer.appendChild(recipientDiv);
            });
            
            // R√©initialiser les s√©lections
            document.getElementById('selectAllEmployees').checked = false;
            updateSendButton();
            
            modal.style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function toggleAllEmployees() {
            const selectAll = document.getElementById('selectAllEmployees').checked;
            const checkboxes = document.querySelectorAll('#emailRecipients input[type="checkbox"]:not([disabled])');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            updateSendButton();
        }

        function updateSendButton() {
            const checkboxes = document.querySelectorAll('#emailRecipients input[type="checkbox"]:checked');
            const sendBtn = document.getElementById('sendEmailBtn');
            
            if (checkboxes.length > 0) {
                sendBtn.disabled = false;
                sendBtn.textContent = `üìß Envoyer le Planning (${checkboxes.length} destinataire${checkboxes.length > 1 ? 's' : ''})`;
            } else {
                sendBtn.disabled = true;
                sendBtn.textContent = 'üìß Envoyer le Planning';
            }
        }

        async function sendPlanningToSelected() {
            if (userRole !== 'admin') return;
            
            const selectedCheckboxes = document.querySelectorAll('#emailRecipients input[type="checkbox"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Veuillez s√©lectionner au moins un destinataire.');
                return;
            }
            
            try {
                // G√©n√©rer le PDF du planning
                const weekKey = `${currentYear}-${currentWeek}`;
                const pdfBlob = await generatePlanningPDF(weekKey);
                const pdfBase64 = await blobToBase64(pdfBlob);
                
                // Envoyer √† chaque destinataire s√©lectionn√©
                const selectedEmployees = [];
                selectedCheckboxes.forEach(checkbox => {
                    const employeeIndex = parseInt(checkbox.value);
                    selectedEmployees.push(employees[employeeIndex]);
                });
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const employee of selectedEmployees) {
                    try {
                        await sendPlanningEmailToEmployee(employee, weekKey, pdfBase64);
                        successCount++;
                    } catch (error) {
                        console.error(`Erreur envoi √† ${employee.email}:`, error);
                        errorCount++;
                    }
                }
                
                closeEmailModal();
                
                if (errorCount === 0) {
                    alert(`‚úÖ Planning envoy√© avec succ√®s √† ${successCount} destinataire${successCount > 1 ? 's' : ''} !`);
                } else {
                    alert(`‚ö†Ô∏è Planning envoy√© √† ${successCount} destinataire${successCount > 1 ? 's' : ''}, ${errorCount} erreur${errorCount > 1 ? 's' : ''}.`);
                }
                
            } catch (error) {
                console.error('Erreur g√©n√©ration PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF.');
            }
        }

        async function sendPlanningToUser() {
            if (userRole === 'admin') return;
            
            // Trouver l'employ√© correspondant √† l'utilisateur connect√©
            const userEmployee = employees.find(emp => emp.email === currentUser.email);
            
            if (!userEmployee) {
                alert('Impossible de trouver vos informations d\'employ√©.');
                return;
            }
            
            if (!confirm(`Vous envoyer le planning de la semaine ${currentWeek}/${currentYear} √† votre adresse email ?\n\nüìß ${currentUser.email}`)) {
                return;
            }
            
            try {
                // G√©n√©rer le PDF du planning
                const weekKey = `${currentYear}-${currentWeek}`;
                const pdfBlob = await generatePlanningPDF(weekKey);
                const pdfBase64 = await blobToBase64(pdfBlob);
                
                // Envoyer √† l'utilisateur
                await sendPlanningEmailToEmployee(userEmployee, weekKey, pdfBase64);
                
                alert('‚úÖ Planning envoy√© avec succ√®s √† votre adresse email !');
                
            } catch (error) {
                console.error('Erreur envoi planning utilisateur:', error);
                alert('Erreur lors de l\'envoi du planning.');
            }
        }

        async function sendPlanningEmailToEmployee(employee, weekKey, pdfBase64) {
            try {
                const weekVersion = getCurrentWeekVersion();
                
                // G√©n√©rer un tableau HTML du planning au lieu d'une image
                const planningTableHTML = generatePlanningTableHTML(weekKey);
                
                const message = `Bonjour ${employee.firstName},

Voici le planning pour la semaine ${currentWeek}/${currentYear}.

üìã PLANNING SEMAINE ${currentWeek} - ${currentYear}
Version : ${weekVersion.number}
Date de g√©n√©ration : ${weekVersion.date}

Le planning est affich√© ci-dessous et disponible en ligne.

üåê ACC√àS EN LIGNE :
Consultez vos plannings sur : https://latille.github.io/PlanningLatille/

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'√©quipe LATILLE`;

                const templateParams = {
                    to_name: employee.firstName,
                    to_email: employee.email,
                    from_name: 'LATILLE Distribution',
                    subject: `Planning Semaine ${currentWeek}/${currentYear} - Version ${weekVersion.number}`,
                    message: message,
                    planning_url: 'https://latille.github.io/PlanningLatille/',
                    admin_email: 'latilledistribution@gmail.com',
                    planning_table: planningTableHTML,
                    week_info: `Semaine ${currentWeek}/${currentYear} - Version ${weekVersion.number}`
                };

                await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                console.log(`Email planning envoy√© √† ${employee.email}`);

            } catch (error) {
                console.error(`Erreur envoi email planning √† ${employee.email}:`, error);
                throw error;
            }
        }

        // FONCTION CORRIG√âE - G√©n√©rer un tableau HTML complet du planning pour l'email
        function generatePlanningTableHTML(weekKey) {
            try {
                const dates = getWeekDates(currentYear, currentWeek);
                const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
                
                let html = `
                <table style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 10px; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #2c3e50; color: white;">
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: center; min-width: 80px;">Horaires</th>`;
                
                // En-t√™tes des jours avec dates
                dayNames.forEach((day, index) => {
                    html += `<th style="border: 1px solid #ddd; padding: 6px; text-align: center; min-width: 90px;">
                        ${day}<br><small>${dates[index].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}</small>
                    </th>`;
                });
                
                html += `</tr></thead><tbody>`;
                
                // Ligne des employ√©s
                html += `<tr style="background-color: #ecf0f1; font-weight: bold;">
                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">√âquipe</td>`;
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const employeeNames = employees.map(emp => emp.firstName).join(' - ');
                    html += `<td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">${employeeNames}</td>`;
                }
                html += `</tr>`;
                
                // MODIFICATION PRINCIPALE : Inclure tous les cr√©neaux de 7h00 √† 20h00
                const emailSlots = timeSlots.filter(slot => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    // Inclure tous les cr√©neaux de 7h √† 19h59 (donc jusqu'√† 20h00)
                    return hour >= 7 && hour <= 19;
                });
                
                emailSlots.forEach((slot, slotIndex) => {
                    const originalSlotIndex = timeSlots.findIndex(s => s.start === slot.start);
                    const bgColor = slotIndex % 2 === 0 ? '#f7f7f7' : '#ffffff';
                    
                    html += `<tr style="background-color: ${bgColor};">
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-weight: bold; font-size: 9px;">${slot.start}-${slot.end}</td>`;
                    
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        let cellContent = '';
                        let cellStyle = 'border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 8px;';
                        
                        if (isSlotClosed(dayIndex, originalSlotIndex)) {
                            cellContent = 'FERM√â';
                            cellStyle += ' background-color: #ffebee; color: #c62828; font-weight: bold;';
                        } else {
                            const assignedEmployees = [];
                            employees.forEach((employee, empIndex) => {
                                if (schedules[weekKey] && 
                                    schedules[weekKey][dayIndex] && 
                                    schedules[weekKey][dayIndex][originalSlotIndex] && 
                                    schedules[weekKey][dayIndex][originalSlotIndex][empIndex]) {
                                    assignedEmployees.push(employee.firstName);
                                }
                            });
                            
                            if (assignedEmployees.length > 0) {
                                cellContent = assignedEmployees.join(' ');
                                cellStyle += ' background-color: #e8f5e8; color: #2e7d32; font-weight: bold;';
                            } else {
                                cellContent = '-';
                                cellStyle += ' color: #999;';
                            }
                        }
                        
                        html += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                
                // Note mise √† jour
                html += `<p style="font-size: 9px; color: #666; margin: 10px 0;">
                    üìù <strong>Note :</strong> Planning complet de 7h00 √† 20h00. 
                    Consultez la version en ligne pour plus de fonctionnalit√©s.
                </p>`;
                
                return html;
                
            } catch (error) {
                console.error('Erreur g√©n√©ration tableau planning:', error);
                return `<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">
                    <p><strong>Planning non disponible</strong></p>
                    <p>Consultez le planning complet en ligne</p>
                </div>`;
            }
        }

        function toggleDayClosure(dayIndex) {
            if (userRole !== 'admin') return;
            
            const closureKey = `${currentYear}-${currentWeek}`;
            if (!closures[closureKey]) closures[closureKey] = {};
            
            // √âtats: 'open' -> 'closed' -> 'am-closed' -> 'pm-closed' -> 'open'
            const currentState = closures[closureKey][dayIndex] || 'open';
            let nextState;
            
            switch(currentState) {
                case 'open':
                    nextState = 'closed';
                    break;
                case 'closed':
                    nextState = 'am-closed';
                    break;
                case 'am-closed':
                    nextState = 'pm-closed';
                    break;
                case 'pm-closed':
                    nextState = 'open';
                    break;
                default:
                    nextState = 'open';
            }
            
            closures[closureKey][dayIndex] = nextState;
            updateClosureDisplay();
            saveSchedulesToFirebase();
        }

        function updateClosureDisplay() {
            const closureKey = `${currentYear}-${currentWeek}`;
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((day, dayIndex) => {
                const toggle = document.querySelector(`[data-day="${dayIndex}"]`);
                if (!toggle) return;
                
                const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
                
                // Mettre √† jour l'apparence du bouton
                toggle.className = `day-toggle ${state}`;
                
                switch(state) {
                    case 'open':
                        toggle.textContent = '‚úì';
                        toggle.title = `Ouvrir/Fermer ${getDayName(dayIndex)}`;
                        break;
                    case 'closed':
                        toggle.textContent = '‚úó';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© toute la journ√©e`;
                        break;
                    case 'am-closed':
                        toggle.textContent = 'AM';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© le matin`;
                        break;
                    case 'pm-closed':
                        toggle.textContent = 'PM';
                        toggle.title = `${getDayName(dayIndex)} - Ferm√© l'apr√®s-midi`;
                        break;
                }
                
                // Appliquer les effets visuels sur les lignes
                updateRowsVisual(dayIndex, state);
            });
        }

        function updateRowsVisual(dayIndex, state) {
            // Supprimer les classes existantes
            document.querySelectorAll('.time-row').forEach(row => {
                const cells = row.querySelectorAll('.schedule-cell');
                if (cells[dayIndex]) {
                    cells[dayIndex].classList.remove('closed', 'establishment-closed');
                }
            });
            
            if (state === 'closed') {
                // Fermeture compl√®te
                document.querySelectorAll('.time-row').forEach(row => {
                    const cells = row.querySelectorAll('.schedule-cell');
                    if (cells[dayIndex]) {
                        cells[dayIndex].classList.add('establishment-closed');
                    }
                });
            } else if (state === 'am-closed') {
                // Fermeture matin (07:00-13:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 7 && hour < 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            } else if (state === 'pm-closed') {
                // Fermeture apr√®s-midi (13:00-20:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            }
        }

        function getDayName(dayIndex) {
            const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
            return days[dayIndex];
        }

        function isSlotClosed(dayIndex, slotIndex) {
            const closureKey = `${currentYear}-${currentWeek}`;
            const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
            
            if (state === 'closed') return true;
            if (state === 'open') return false;
            
            const hour = parseInt(timeSlots[slotIndex].start.split(':')[0]);
            if (state === 'am-closed' && hour >= 7 && hour < 13) return true;
            if (state === 'pm-closed' && hour >= 13) return true;
            
            return false;
        }

        function toggleDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.toggle('show');
        }

        function closeDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.remove('show');
        }

        // Click outside modal to close
        window.addEventListener('click', (event) => {
            const employeeModal = document.getElementById('employeeModal');
            const passwordModal = document.getElementById('passwordModal');
            const emailModal = document.getElementById('emailModal');
            
            if (event.target === employeeModal) {
                closeEmployeeModal();
            }
            if (event.target === passwordModal && !mustChangePassword) {
                closePasswordModal();
            }
            if (event.target === emailModal) {
                closeEmailModal();
            }
        });

        // √âv√©nements globaux pour le drag & drop
        document.addEventListener('mouseup', (event) => {
            if (isDragging) {
                endDragSelection();
            }
        });

        document.addEventListener('mousemove', (event) => {
            if (isDragging) {
                // Emp√™cher le comportement par d√©faut pendant le drag
                event.preventDefault();
            }
        });

        // Emp√™cher le menu contextuel pendant le drag
        document.addEventListener('contextmenu', (event) => {
            if (isDragging) {
                event.preventDefault();
            }
        });

        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Gestion des touches Enter pour la connexion
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (document.getElementById('loginModal').style.display !== 'none') {
                    login();
                } else if (document.getElementById('passwordModal').style.display === 'block') {
                    changePassword();
                }
            }
        });

        // Gestion de la touche Escape pour annuler le drag
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isDragging) {
                // Annuler le drag sans appliquer les changements
                document.querySelectorAll('.drag-preview, .drag-invalid').forEach(slot => {
                    slot.classList.remove('drag-preview', 'drag-invalid');
                });
                
                isDragging = false;
                dragStart = null;
                dragEnd = null;
                dragStartState = null;
                dragCurrentEmployee = null;
                dragCurrentDay = null;
                draggedSlots.clear();
                document.body.style.userSelect = '';
            }
        });
    </script>
</body>
</html>
