<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Planning LATILLE</title>
    
    <!-- Bibliothèque SheetJS pour l'export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Bibliothèque jsPDF pour la génération PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-messaging.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB70gXioCFDN7qBQ21vDGviGSzb7Sg1slQ",
            authDomain: "planning-latille.firebaseapp.com",
            projectId: "planning-latille",
            storageBucket: "planning-latille.firebasestorage.app",
            messagingSenderId: "363904305106",
            appId: "1:363904305106:web:ecb94628d4eaaa25a72a0b"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const messaging = getMessaging(app);

        // Exposer Firebase globalement
        window.firebaseApp = app;
        window.firestore = db;
        window.firebaseAuth = auth;
        window.firebaseMessaging = messaging;
        window.firestoreSDK = { doc, setDoc, getDoc, collection, getDocs, deleteDoc, onSnapshot };
        window.authSDK = { signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail, createUserWithEmailAndPassword };
        window.messagingSDK = { getToken, onMessage };
        window.firebaseReady = true;

        // Initialiser EmailJS
        emailjs.init('jmxM2TzLpG0C5Al7B');
        window.emailjsReady = true;

        // Initialiser l'application une fois Firebase prêt
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                window.initializeApp();
            });
        } else {
            window.initializeApp();
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .forgot-password {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .error-message {
            color: #dc3545;
            margin: 10px 0;
            font-size: 14px;
        }

        .success-message {
            color: #28a745;
            margin: 10px 0;
            font-size: 14px;
        }

        /* User info in header */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .user-email {
            font-weight: bold;
            color: #2c3e50;
        }

        .user-role {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .user-role.admin {
            background: #dc3545;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        /* Validation section */
        .validation-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .validation-info {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .validate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .validate-btn:hover {
            background: #218838;
        }

        .validate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Version info */
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 100;
        }

        /* Password change modal */
        .password-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .password-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* Invitation section */
        .invitation-section {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .invite-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .invite-btn:hover {
            background: #218838;
        }

        .invite-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Read-only styling */
        .read-only .time-slot {
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .read-only .day-toggle {
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .read-only .btn-save,
        .read-only .btn-employees,
        .read-only .dropdown {
            display: none !important;
        }

        .access-denied {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 18px;
        }

        .header {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .week-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .week-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .week-nav-btn {
            height: 36px;
            width: 24px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .week-nav-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }

        .week-nav-btn:active {
            background: #e0e0e0;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-employees { background: #6c757d; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-email { background: #28a745; color: white; }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1000;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
            transition: background-color 0.3s;
        }

        .dropdown-content button:first-child {
            border-radius: 5px 5px 0 0;
        }

        .dropdown-content button:last-child {
            border-radius: 0 0 5px 5px;
        }

        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content button.danger {
            color: #dc3545;
        }

        .dropdown-content button.danger:hover {
            background-color: #f8d7da;
        }

        .dropdown.show .dropdown-content {
            display: block;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .summary {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        .employee-summary {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .employee-summary.hours-zero {
            background: #f8f9fa;
        }

        .employee-summary.hours-partial {
            background: #ffebee;
            border: 1px solid #ef5350;
        }

        .employee-summary.hours-complete {
            background: #e8f5e8;
            border: 1px solid #4caf50;
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        @keyframes greenFlash {
            0% { 
                background: #2e7d32;
                transform: scale(1.05);
            }
            50% { 
                background: #388e3c;
                transform: scale(1.02);
            }
            100% { 
                background: #e8f5e8;
                transform: scale(1);
            }
        }

        @keyframes textFlash {
            0% { 
                color: white;
            }
            50% { 
                color: white;
            }
            100% { 
                color: inherit;
            }
        }

        .employee-summary.hours-complete.flash {
            animation: greenFlash 0.8s ease-out;
        }

        .employee-summary.hours-complete.flash .employee-name,
        .employee-summary.hours-complete.flash .hours-total,
        .employee-summary.hours-complete.flash .hours-remaining {
            animation: textFlash 0.8s ease-out;
        }

        .employee-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hours-total {
            font-size: 14px;
            color: #495057;
        }

        .hours-remaining {
            font-size: 12px;
            margin-top: 5px;
        }

        .hours-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .schedule-grid {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .days-header {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #1a252f;
            color: white;
        }

        .time-header {
            background: #243342;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-header {
            padding: 10px 8px;
            text-align: center;
            border-left: 1px solid #485b6b;
            position: relative;
        }

        .day-toggle-container {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .day-toggle {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            user-select: none;
        }

        .day-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .day-toggle.open {
            background: #4caf50;
            color: white;
        }

        .day-toggle.closed {
            background: #f44336;
            color: white;
        }

        .day-toggle.am-closed {
            background: #ff9800;
            color: white;
        }

        .day-toggle.pm-closed {
            background: #ff9800;
            color: white;
        }

        .schedule-cell.closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
        }

        .schedule-cell.establishment-closed {
            background: repeating-linear-gradient(
                45deg,
                #000000,
                #000000 10px,
                #333333 10px,
                #333333 20px
            );
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .schedule-cell.establishment-closed::after {
            content: "FERMÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .schedule-cell.closed::after {
            content: "FERMÉ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .time-row.closed .schedule-cell {
            position: relative;
        }

        .day-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .day-date {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.9;
        }

        .employees-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
            background: #ecf0f1;
        }

        .time-cell {
            padding: 3px 6px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 10px;
            line-height: 1.1;
        }

        .time-row:nth-child(odd) .time-cell {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) .time-cell {
            background-color: #ffffff;
        }

        .employees-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            border-left: 2px solid #95a5a6;
            min-height: 40px;
        }

        .time-cell.employees-header {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
            padding: 2px;
            transform: rotate(180deg);
        }

        .time-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            border-bottom: 1px solid #ecf0f1;
        }

        .time-row:nth-child(odd) {
            background-color: #F7F7F7;
        }

        .time-row:nth-child(even) {
            background-color: #ffffff;
        }

        .schedule-cell {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1px;
            border-left: 2px solid #95a5a6;
            min-height: 20px;
        }

        .time-slot {
            width: 18px;
            height: 18px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .time-slot.default-gray {
            background-color: #95a5a6;
        }

        .time-slot.default-green {
            background-color: #a8d8a8;
        }

        .time-slot.employee-1 { background-color: #e74c3c; }
        .time-slot.employee-2 { background-color: #3498db; }
        .time-slot.employee-3 { background-color: #f39c12; }
        .time-slot.employee-4 { background-color: #9b59b6; }
        .time-slot.employee-5 { background-color: #f1c40f; }

        .time-slot:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .time-slot.drag-preview {
            border: 2px solid #27ae60;
            opacity: 0.8;
        }

        .time-slot.drag-invalid {
            border: 2px solid #e74c3c;
        }

        .daily-totals {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            background: #12BBFD;
            color: white;
            font-weight: bold;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            min-height: 35px;
        }

        .total-cell {
            padding: 8px 6px;
            text-align: center;
            border-left: 2px solid rgba(255,255,255,0.2);
            transition: background-color 0.3s ease;
            font-size: 11px;
        }

        .total-cell:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .total-label {
            background: #12BBFD;
            font-size: 10px;
            font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .daily-employee-totals {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .daily-employee-totals > div {
            background: rgba(255,255,255,0.15);
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .daily-employee-totals > div:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
        }

        .employee-input {
            width: 100%;
            padding: 8px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .employee-form-group {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            align-items: center;
        }

        .form-row input {
            flex: none;
        }

        .form-row input[type="text"]:nth-child(2) {
            width: 120px; /* Prénom */
        }

        .form-row input[type="text"]:nth-child(3) {
            width: 200px; /* Nom */
        }

        .form-row input[type="email"] {
            flex: 1; /* Email prend l'espace restant */
            min-width: 200px;
        }

        .clear-employee-btn {
            width: 32px;
            height: 32px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .clear-employee-btn:hover {
            background: #c82333;
        }

        .employee-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
            display: flex;
            align-items: center;
            min-width: 80px;
            flex-shrink: 0;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 1200px) {
            .main-content {
                padding: 0 10px;
            }
            
            .time-slot {
                width: 15px;
                height: 15px;
            }
            
            .employee-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h2 class="login-title">🔐 Connexion LATILLE</h2>
            <input type="email" id="loginEmail" class="login-input" placeholder="Adresse email" required>
            <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" required>
            <button onclick="login()" class="login-btn">Se connecter</button>
            <div id="loginError" class="error-message"></div>
            <div id="loginSuccess" class="success-message"></div>
            <div class="forgot-password" onclick="forgotPassword()">Mot de passe oublié ?</div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <span class="close" onclick="closePasswordModal()" id="passwordCloseBtn">&times;</span>
            <h2 id="passwordModalTitle">Changer le mot de passe</h2>
            <div id="passwordWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; color: #856404;">
                <strong>⚠️ Changement obligatoire</strong><br>
                Vous devez changer votre mot de passe temporaire.
            </div>
            <input type="password" id="newPassword" class="login-input" placeholder="Nouveau mot de passe" required>
            <input type="password" id="confirmPassword" class="login-input" placeholder="Confirmer le mot de passe" required>
            <button onclick="changePassword()" class="login-btn">Modifier</button>
            <div id="passwordError" class="error-message"></div>
            <div id="passwordSuccess" class="success-message"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1>📋 Gestion Planning LATILLE</h1>
            <div class="controls">
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="logout-btn" onclick="logout()">Déconnexion</button>
                    <button class="logout-btn" onclick="openPasswordModal()">Changer MDP</button>
                </div>
                <div class="week-selector">
                    <div class="week-group">
                        <label>Semaine</label>
                        <select id="weekSelect"></select>
                        <button class="week-nav-btn" onclick="changeWeek(-1)" title="Semaine précédente">◀</button>
                        <button class="week-nav-btn" onclick="changeWeek(1)" title="Semaine suivante">▶</button>
                    </div>
                    <div class="week-group">
                        <label>Année</label>
                        <select id="yearSelect"></select>
                    </div>
                </div>
                <div class="dropdown" id="adminControls">
                    <button class="btn btn-employees" onclick="toggleDropdown()">Actions ⋮</button>
                    <div class="dropdown-content" id="actionsDropdown">
                        <button onclick="openEmployeeModal(); closeDropdown()">Gérer Employés</button>
                        <button onclick="openDuplicateModal(); closeDropdown()">Dupliquer Planning</button>
                        <button class="danger" onclick="openResetModal(); closeDropdown()">Réinitialiser</button>
                    </div>
                </div>
                <button class="btn btn-save" onclick="openPrintableVersion()">Planning Impression</button>
                <button class="btn btn-email" onclick="sendByEmail()">Envoyer par Email</button>
            </div>
        </div>

        <div class="main-content">
            <div id="accessDenied" class="access-denied" style="display: none;">
                <h2>🚫 Accès refusé</h2>
                <p>Vous n'avez pas accès à ce planning car vous n'y êtes pas assigné.</p>
            </div>

            <div id="validationSection" class="validation-section" style="display: none;">
                <div class="validation-info">
                    <strong>🔄 Planning modifié</strong><br>
                    Ce planning a été modifié et n'est pas encore validé.
                </div>
                <button class="validate-btn" onclick="validatePlanning()">✅ Valider et Notifier</button>
            </div>

            <div id="scheduleContent">
                <div class="summary">
                    <h3>Résumé Hebdomadaire</h3>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>

                <div class="schedule-grid">
                    <div class="days-header">
                        <div class="time-header">Horaires</div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(0)" title="Ouvrir/Fermer lundi" data-day="0">✓</div>
                            </div>
                            <div class="day-title">Lundi</div>
                            <div class="day-date" id="monday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(1)" title="Ouvrir/Fermer mardi" data-day="1">✓</div>
                            </div>
                            <div class="day-title">Mardi</div>
                            <div class="day-date" id="tuesday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(2)" title="Ouvrir/Fermer mercredi" data-day="2">✓</div>
                            </div>
                            <div class="day-title">Mercredi</div>
                            <div class="day-date" id="wednesday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(3)" title="Ouvrir/Fermer jeudi" data-day="3">✓</div>
                            </div>
                            <div class="day-title">Jeudi</div>
                            <div class="day-date" id="thursday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(4)" title="Ouvrir/Fermer vendredi" data-day="4">✓</div>
                            </div>
                            <div class="day-title">Vendredi</div>
                            <div class="day-date" id="friday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(5)" title="Ouvrir/Fermer samedi" data-day="5">✓</div>
                            </div>
                            <div class="day-title">Samedi</div>
                            <div class="day-date" id="saturday-date"></div>
                        </div>
                        <div class="day-header">
                            <div class="day-toggle-container">
                                <div class="day-toggle open" onclick="toggleDayClosure(6)" title="Ouvrir/Fermer dimanche" data-day="6">✓</div>
                            </div>
                            <div class="day-title">Dimanche</div>
                            <div class="day-date" id="sunday-date"></div>
                        </div>
                    </div>

                    <div class="employees-row">
                        <div class="time-cell employees-header">Employés</div>
                        <div class="employees-cell" id="monday-employees"></div>
                        <div class="employees-cell" id="tuesday-employees"></div>
                        <div class="employees-cell" id="wednesday-employees"></div>
                        <div class="employees-cell" id="thursday-employees"></div>
                        <div class="employees-cell" id="friday-employees"></div>
                        <div class="employees-cell" id="saturday-employees"></div>
                        <div class="employees-cell" id="sunday-employees"></div>
                    </div>

                    <div id="timeSlots"></div>

                    <div class="daily-totals">
                        <div class="total-cell total-label" style="font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px;">Total Jour</div>
                        <div class="total-cell" id="monday-totals"></div>
                        <div class="total-cell" id="tuesday-totals"></div>
                        <div class="total-cell" id="wednesday-totals"></div>
                        <div class="total-cell" id="thursday-totals"></div>
                        <div class="total-cell" id="friday-totals"></div>
                        <div class="total-cell" id="saturday-totals"></div>
                        <div class="total-cell" id="sunday-totals"></div>
                    </div>

                    <div class="daily-totals" style="background: #20B077; min-height: 35px;">
                        <div class="total-cell total-label" style="background: #20B077; font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 10px; display: flex; align-items: center; justify-content: center;">Équipe</div>
                        <div class="total-cell" id="monday-team-total">0h</div>
                        <div class="total-cell" id="tuesday-team-total">0h</div>
                        <div class="total-cell" id="wednesday-team-total">0h</div>
                        <div class="total-cell" id="thursday-team-total">0h</div>
                        <div class="total-cell" id="friday-team-total">0h</div>
                        <div class="total-cell" id="saturday-team-total">0h</div>
                        <div class="total-cell" id="sunday-team-total">0h</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version info -->
    <div class="version-info" id="versionInfo"></div>

    <!-- Modal pour gérer les employés -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2>Gérer les Employés</h2>
            <div id="employeeInputs"></div>
            <button class="btn btn-save" onclick="saveEmployees()">Sauvegarder les Noms</button>
        </div>
    </div>

    <!-- Modal pour dupliquer un planning -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDuplicateModal()">&times;</span>
            <h2>Dupliquer un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning source :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="sourceWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="sourceYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Planning destination :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="destWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="destYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <div id="duplicateInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
            </div>
            <button class="btn btn-save" onclick="duplicatePlanning()">Dupliquer le Planning</button>
        </div>
    </div>

    <!-- Modal pour réinitialiser un planning -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h2>Réinitialiser un Planning</h2>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Semaine à réinitialiser :</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="resetWeek" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                    <select id="resetYear" style="flex: 1;">
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
                
                <div id="resetInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0; font-size: 14px;"></div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 15px 0;">
                    <strong>⚠️ Attention :</strong> Cette action supprimera définitivement tous les plannings et fermetures de cette semaine. Cette action est irréversible.
                </div>
            </div>
            <button class="btn" style="background: #dc3545; color: white;" onclick="resetPlanning()">Réinitialiser le Planning</button>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let userRole = null;
        let currentWeek = 25;
        let currentYear = 2025;
        let mustChangePassword = false; // Nouveau : indicateur de changement de MDP obligatoire
        let employees = [
            { firstName: 'Antoine', lastName: '', email: '' },
            { firstName: 'Léa', lastName: '', email: '' },
            { firstName: 'Noémie', lastName: '', email: '' },
            { firstName: 'Christelle', lastName: '', email: '' },
            { firstName: 'Admin', lastName: 'LATILLE', email: 'latilledistribution@gmail.com' }
        ];
        let schedules = {};
        let closures = {};
        let activeListeners = {};
        let isUpdatingFromFirebase = false;
        let isDragging = false;
        let dragStart = null;
        let dragStartState = null;
        let dragCurrentEmployee = null;
        let dragCurrentDay = null;
        let planningValidated = true; // État de validation du planning courant
        let currentVersion = { number: 1, date: new Date().toLocaleDateString('fr-FR').slice(0, 8) };

        // Configuration des créneaux horaires
        const timeSlots = [
            { start: '07:00', end: '07:30', duration: 30 },
            { start: '07:30', end: '08:00', duration: 30 },
            { start: '08:00', end: '08:30', duration: 30 },
            { start: '08:30', end: '08:45', duration: 15 },
            { start: '08:45', end: '09:00', duration: 15 },
            { start: '09:00', end: '09:30', duration: 30 },
            { start: '09:30', end: '10:00', duration: 30 },
            { start: '10:00', end: '10:30', duration: 30 },
            { start: '10:30', end: '11:00', duration: 30 },
            { start: '11:00', end: '11:30', duration: 30 },
            { start: '11:30', end: '12:00', duration: 30 },
            { start: '12:00', end: '12:30', duration: 30 },
            { start: '12:30', end: '12:45', duration: 15 },
            { start: '12:45', end: '13:00', duration: 15 },
            { start: '13:00', end: '13:30', duration: 30 },
            { start: '13:30', end: '14:00', duration: 30 },
            { start: '14:00', end: '14:30', duration: 30 },
            { start: '14:30', end: '15:00', duration: 30 },
            { start: '15:00', end: '15:15', duration: 15 },
            { start: '15:15', end: '15:30', duration: 15 },
            { start: '15:30', end: '16:00', duration: 30 },
            { start: '16:00', end: '16:30', duration: 30 },
            { start: '16:30', end: '17:00', duration: 30 },
            { start: '17:00', end: '17:30', duration: 30 },
            { start: '17:30', end: '18:00', duration: 30 },
            { start: '18:00', end: '18:30', duration: 30 },
            { start: '18:30', end: '19:00', duration: 30 },
            { start: '19:00', end: '19:15', duration: 15 },
            { start: '19:15', end: '19:30', duration: 15 },
            { start: '19:30', end: '20:00', duration: 30 }
        ];

        // Créneaux par défaut
        const defaultGraySlots = ['13:00', '13:30', '14:00', '14:30'];
        const sundayGraySlots = ['13:00', '13:30', '14:00', '14:30', '15:00', '15:15', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:15', '19:30'];
        const defaultGreenSlots = ['08:30', '08:45', '12:30', '12:45', '15:00', '15:15'];
        const weekdayGreenSlots = ['19:00', '19:15'];

        // Fonctions d'authentification
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const successDiv = document.getElementById('loginSuccess');

            if (!email || !password) {
                errorDiv.textContent = 'Veuillez remplir tous les champs';
                return;
            }

            try {
                const { signInWithEmailAndPassword } = window.authSDK;
                await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                successDiv.textContent = 'Connexion réussie...';
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Erreur de connexion:', error);
                errorDiv.textContent = 'Email ou mot de passe incorrect';
                successDiv.textContent = '';
            }
        }

        async function logout() {
            try {
                const { signOut } = window.authSDK;
                await signOut(window.firebaseAuth);
            } catch (error) {
                console.error('Erreur de déconnexion:', error);
            }
        }

        async function forgotPassword() {
            const email = document.getElementById('loginEmail').value;
            if (!email) {
                document.getElementById('loginError').textContent = 'Veuillez entrer votre adresse email';
                return;
            }

            try {
                const { sendPasswordResetEmail } = window.authSDK;
                await sendPasswordResetEmail(window.firebaseAuth, email);
                document.getElementById('loginSuccess').textContent = 'Email de réinitialisation envoyé';
                document.getElementById('loginError').textContent = '';
            } catch (error) {
                console.error('Erreur envoi email:', error);
                document.getElementById('loginError').textContent = 'Erreur lors de l\'envoi de l\'email';
            }
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
            
            // Adapter l'affichage selon si c'est obligatoire
            const isRequired = mustChangePassword;
            const closeBtn = document.getElementById('passwordCloseBtn');
            const warning = document.getElementById('passwordWarning');
            const title = document.getElementById('passwordModalTitle');
            
            if (isRequired) {
                closeBtn.style.display = 'none'; // Masquer la croix
                warning.style.display = 'block'; // Afficher l'avertissement
                title.textContent = 'Changement de mot de passe obligatoire';
            } else {
                closeBtn.style.display = 'block'; // Afficher la croix
                warning.style.display = 'none'; // Masquer l'avertissement
                title.textContent = 'Changer le mot de passe';
            }
        }

        function closePasswordModal() {
            // Empêcher la fermeture si changement obligatoire
            if (mustChangePassword) {
                alert('⚠️ Vous devez changer votre mot de passe temporaire avant de continuer.');
                return;
            }
            
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('passwordSuccess').textContent = '';
        }

        // Fonction pour vérifier si changement de mot de passe requis
        async function checkPasswordChangeRequired(email) {
            try {
                const { doc, getDoc } = window.firestoreSDK;
                const userSettingsDoc = await getDoc(doc(window.firestore, 'user-settings', email));
                
                if (userSettingsDoc.exists()) {
                    const data = userSettingsDoc.data();
                    mustChangePassword = data.requirePasswordChange || false;
                } else {
                    mustChangePassword = false;
                }
            } catch (error) {
                console.error('Erreur vérification changement MDP:', error);
                mustChangePassword = false;
            }
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Les mots de passe ne correspondent pas';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                return;
            }

            try {
                const { updatePassword } = window.authSDK;
                await updatePassword(window.firebaseAuth.currentUser, newPassword);
                
                // Marquer le changement de mot de passe comme terminé
                if (mustChangePassword) {
                    const { doc, setDoc } = window.firestoreSDK;
                    await setDoc(doc(window.firestore, 'user-settings', currentUser.email), {
                        requirePasswordChange: false,
                        passwordChangedAt: new Date().toISOString()
                    });
                    mustChangePassword = false;
                }
                
                successDiv.textContent = 'Mot de passe modifié avec succès';
                errorDiv.textContent = '';
                setTimeout(() => {
                    closePasswordModal();
                }, 2000);
            } catch (error) {
                console.error('Erreur changement mot de passe:', error);
                
                let errorMessage = 'Erreur lors du changement de mot de passe';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Veuillez vous reconnecter pour changer votre mot de passe';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Le mot de passe doit contenir au moins 6 caractères';
                }
                
                errorDiv.textContent = errorMessage;
            }
        }

        // Fonctions de gestion des rôles et permissions
        function determineUserRole(email) {
            if (email === 'latilledistribution@gmail.com') {
                return 'admin';
            }
            return 'user';
        }

        function getUserEmployeeIndex(email) {
            return employees.findIndex(emp => emp.email === email);
        }

        function checkWeekAccess(weekKey, userEmail) {
            if (userRole === 'admin') return true;
            
            const employeeIndex = getUserEmployeeIndex(userEmail);
            if (employeeIndex === -1) return false;

            // Vérifier si l'utilisateur a au moins 1h dans cette semaine
            const weekSchedule = schedules[weekKey];
            if (!weekSchedule) return false;

            let totalMinutes = 0;
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                if (weekSchedule[dayIndex]) {
                    for (let slotIndex = 0; slotIndex < timeSlots.length; slotIndex++) {
                        if (weekSchedule[dayIndex][slotIndex] && weekSchedule[dayIndex][slotIndex][employeeIndex]) {
                            totalMinutes += timeSlots[slotIndex].duration;
                        }
                    }
                }
            }

            return totalMinutes >= 60; // Au moins 1 heure
        }

        function updateUIForRole() {
            const isAdmin = userRole === 'admin';
            const weekKey = `${currentYear}-${currentWeek}`;
            const hasAccess = checkWeekAccess(weekKey, currentUser.email);

            // Afficher/masquer les contrôles admin
            document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';

            // Gestion de l'accès au planning
            if (!hasAccess) {
                document.getElementById('accessDenied').style.display = 'block';
                document.getElementById('scheduleContent').style.display = 'none';
                document.getElementById('validationSection').style.display = 'none';
            } else {
                document.getElementById('accessDenied').style.display = 'none';
                document.getElementById('scheduleContent').style.display = 'block';
                
                // Mode lecture seule pour les utilisateurs
                if (!isAdmin) {
                    document.body.classList.add('read-only');
                } else {
                    document.body.classList.remove('read-only');
                }

                // Section validation (admin seulement)
                document.getElementById('validationSection').style.display = 
                    (isAdmin && !planningValidated) ? 'block' : 'none';
            }

            // Mettre à jour les informations utilisateur
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userRole').textContent = isAdmin ? 'Administrateur' : 'Utilisateur';
            document.getElementById('userRole').className = `user-role ${isAdmin ? 'admin' : ''}`;
        }

        // Fonctions de version et validation
        function updateVersionInfo() {
            const versionStr = `S${currentWeek}/${currentYear} - ${currentVersion.date} - v${currentVersion.number}`;
            document.getElementById('versionInfo').textContent = versionStr;
        }

        function markPlanningAsModified() {
            if (userRole === 'admin' && !isUpdatingFromFirebase) {
                planningValidated = false;
                updateUIForRole();
            }
        }

        async function validatePlanning() {
            try {
                const weekKey = `${currentYear}-${currentWeek}`;
                
                // Incrémenter la version
                currentVersion.number += 0.1;
                currentVersion.number = Math.round(currentVersion.number * 10) / 10;
                currentVersion.date = new Date().toLocaleDateString('fr-FR').slice(0, 8);

                // Marquer comme validé
                planningValidated = true;

                // Sauvegarder la version avec le planning
                const planningData = {
                    schedule: schedules[weekKey] || {},
                    closure: closures[weekKey] || {},
                    version: currentVersion,
                    validated: true,
                    validatedBy: currentUser.email,
                    validatedAt: new Date().toISOString()
                };

                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'planning-data', `validated-${weekKey}`), planningData);

                // Générer et envoyer les notifications
                await sendPlanningNotifications(weekKey);

                updateUIForRole();
                updateVersionInfo();
                alert('Planning validé et notifications envoyées !');

            } catch (error) {
                console.error('Erreur validation:', error);
                alert('Erreur lors de la validation');
            }
        }

        async function sendPlanningNotifications(weekKey) {
            try {
                // Identifier les employés concernés par ce planning
                const concernedEmployees = [];
                const weekSchedule = schedules[weekKey];
                
                if (weekSchedule) {
                    for (let empIndex = 0; empIndex < employees.length; empIndex++) {
                        let hasHours = false;
                        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                            if (weekSchedule[dayIndex]) {
                                for (let slotIndex = 0; slotIndex < timeSlots.length; slotIndex++) {
                                    if (weekSchedule[dayIndex][slotIndex] && weekSchedule[dayIndex][slotIndex][empIndex]) {
                                        hasHours = true;
                                        break;
                                    }
                                }
                            }
                            if (hasHours) break;
                        }
                        
                        if (hasHours && employees[empIndex].email) {
                            concernedEmployees.push(employees[empIndex]);
                        }
                    }
                }

                // Toujours inclure l'administrateur
                if (!concernedEmployees.find(emp => emp.email === 'latilledistribution@gmail.com')) {
                    concernedEmployees.push(employees[4]); // Admin
                }

                // Générer le PDF
                const pdfBlob = await generatePlanningPDF(weekKey);
                const pdfBase64 = await blobToBase64(pdfBlob);

                // Envoyer l'email à chaque employé concerné
                for (const employee of concernedEmployees) {
                    if (employee.email) {
                        await sendPlanningEmail(employee, weekKey, pdfBase64);
                    }
                }

            } catch (error) {
                console.error('Erreur envoi notifications:', error);
                throw error;
            }
        }

        async function sendPlanningEmail(employee, weekKey, pdfBase64) {
            try {
                const templateParams = {
                    to_name: employee.firstName,
                    to_email: employee.email,
                    from_name: 'LATILLE Distribution',
                    subject: `Planning Semaine ${currentWeek}/${currentYear} - Version ${currentVersion.number}`,
                    employee_email: employee.email,
                    temp_password: '', // Pas de MDP pour ce type d'email
                    planning_url: 'https://latille.github.io/PlanningLatille/',
                    message: `Bonjour ${employee.firstName},

Veuillez trouver en pièce jointe votre planning pour la semaine ${currentWeek}/${currentYear}.

📋 DÉTAILS :
Version: ${currentVersion.number}
Date de validation: ${currentVersion.date}

📋 ACCÈS AU PLANNING EN LIGNE :
https://latille.github.io/PlanningLatille/

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'équipe LATILLE`,
                    pdf_attachment: pdfBase64
                };

                await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                console.log(`Email envoyé à ${employee.email}`);

            } catch (error) {
                console.error(`Erreur envoi email à ${employee.email}:`, error);
            }
        }

        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Fonction pour générer un mot de passe temporaire
        function generateTempPassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Fonction pour envoyer les invitations
        async function sendEmployeeInvitation(employeeIndex) {
            const employee = employees[employeeIndex];
            if (!employee.email) {
                alert('Veuillez d\'abord saisir l\'adresse email de cet employé');
                return;
            }

            if (!confirm(`Envoyer une invitation à ${employee.firstName} (${employee.email}) ?\n\nCela créera un compte utilisateur avec un mot de passe temporaire.`)) {
                return;
            }

            try {
                // Générer un mot de passe temporaire
                const tempPassword = generateTempPassword();
                
                // Créer le compte utilisateur dans Firebase Auth
                const { createUserWithEmailAndPassword } = window.authSDK;
                
                // Sauvegarder l'utilisateur actuel
                const currentUserEmail = currentUser.email;
                
                try {
                    // Créer le nouveau compte
                    await createUserWithEmailAndPassword(window.firebaseAuth, employee.email, tempPassword);
                    
                    // Se reconnecter en tant qu'admin
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Attendre un peu
                    const { signInWithEmailAndPassword } = window.authSDK;
                    await signInWithEmailAndPassword(window.firebaseAuth, currentUserEmail, 'admin123');
                    
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        // L'utilisateur existe déjà, utiliser la réinitialisation de mot de passe
                        const { sendPasswordResetEmail } = window.authSDK;
                        await sendPasswordResetEmail(window.firebaseAuth, employee.email);
                        
                        // Envoyer l'email d'invitation sans mot de passe
                        const templateParams = {
                            to_name: employee.firstName,
                            to_email: employee.email,
                            from_name: 'LATILLE Distribution',
                            subject: 'Invitation - Accès au planning LATILLE',
                            employee_email: employee.email,
                            temp_password: '', // Pas de MDP temporaire car compte existant
                            planning_url: 'https://latille.github.io/PlanningLatille/',
                            message: `Bonjour ${employee.firstName},

Vous avez été invité(e) à accéder au système de planning LATILLE.

🔐 CONNEXION :
Email : ${employee.email}
Un email de réinitialisation de mot de passe vous a été envoyé.

⚠️ IMPORTANT :
- Utilisez le lien de réinitialisation pour créer votre mot de passe
- Connectez-vous ensuite avec vos nouveaux identifiants

📋 ACCÈS AU PLANNING :
${employee.email.includes('@') ? 'https://latille.github.io/PlanningLatille/' : ''}

Vous pourrez consulter et imprimer vos plannings hebdomadaires.

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'équipe LATILLE`
                        };

                        await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                        alert(`L'utilisateur existe déjà. Un email de réinitialisation a été envoyé à ${employee.email}`);
                        return;
                    } else {
                        throw authError;
                    }
                }

                // Marquer le compte comme nécessitant un changement de mot de passe
                const { doc, setDoc } = window.firestoreSDK;
                await setDoc(doc(window.firestore, 'user-settings', employee.email), {
                    requirePasswordChange: true,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email,
                    employeeIndex: employeeIndex
                });

                // Envoyer l'email d'invitation avec le mot de passe temporaire
                const templateParams = {
                    to_name: employee.firstName,
                    to_email: employee.email,
                    from_name: 'LATILLE Distribution',
                    subject: 'Invitation - Accès au planning LATILLE',
                    employee_email: employee.email,
                    temp_password: tempPassword,
                    planning_url: 'https://latille.github.io/PlanningLatille/',
                    message: `Bonjour ${employee.firstName},

Vous avez été invité(e) à accéder au système de planning LATILLE.

🔐 VOS IDENTIFIANTS DE CONNEXION :
Email : ${employee.email}
Mot de passe temporaire : ${tempPassword}

⚠️ IMPORTANT :
- Connectez-vous avec ces identifiants
- Changez IMMÉDIATEMENT votre mot de passe
- Utilisez le bouton "Changer MDP" après connexion

📋 ACCÈS AU PLANNING :
https://latille.github.io/PlanningLatille/

Vous pourrez consulter et imprimer vos plannings hebdomadaires.

Si vous avez des questions, contactez l'administrateur.

Cordialement,
L'équipe LATILLE`
                };

                await emailjs.send('service_jaocvbq', 'template_6y2uwsn', templateParams);
                
                alert(`✅ Invitation envoyée avec succès !\n\nCompte créé pour : ${employee.email}\nMot de passe temporaire : ${tempPassword}\n\n(Ces informations ont été envoyées par email)`);

            } catch (error) {
                console.error('Erreur création compte/envoi invitation:', error);
                
                let errorMessage = 'Erreur lors de l\'envoi de l\'invitation';
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Adresse email invalide';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Mot de passe trop faible';
                }
                
                alert(errorMessage);
            }
        }

        // Génération PDF
        async function generatePlanningPDF(weekKey) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            // Configuration
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            const dates = getWeekDates(currentYear, currentWeek);

            // Titre
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PLANNING SPAR LATILLE', pageWidth / 2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Semaine ${currentWeek} - ${currentYear}`, pageWidth / 2, 28, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Du ${dates[0].toLocaleDateString('fr-FR')} au ${dates[6].toLocaleDateString('fr-FR')}`, pageWidth / 2, 35, { align: 'center' });

            // Version en bas à droite
            doc.setFontSize(8);
            const versionStr = `S${currentWeek}/${currentYear} - ${currentVersion.date} - v${currentVersion.number}`;
            doc.text(versionStr, pageWidth - margin, pageHeight - 5, { align: 'right' });

            // Tableau des plannings
            const tableData = [];
            const headers = ['Horaires', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            // En-têtes avec dates
            const headerRow = ['Horaires'];
            const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            for (let i = 0; i < 7; i++) {
                headerRow.push(`${dayNames[i]}\n${dates[i].toLocaleDateString('fr-FR')}`);
            }
            tableData.push(headerRow);

            // Ligne des employés
            const employeeRow = ['Employés'];
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const dayEmployees = employees.map(emp => emp.firstName).join(' | ');
                employeeRow.push(dayEmployees);
            }
            tableData.push(employeeRow);

            // Lignes des créneaux
            timeSlots.forEach((slot, slotIndex) => {
                const row = [`${slot.start}-${slot.end}`];
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    let cellContent = '';
                    employees.forEach((employee, empIndex) => {
                        if (schedules[weekKey] && 
                            schedules[weekKey][dayIndex] && 
                            schedules[weekKey][dayIndex][slotIndex] && 
                            schedules[weekKey][dayIndex][slotIndex][empIndex]) {
                            cellContent += employee.firstName + ' ';
                        }
                    });
                    
                    // Vérifier les fermetures
                    if (isSlotClosed(dayIndex, slotIndex)) {
                        cellContent = 'FERMÉ';
                    }
                    
                    row.push(cellContent.trim());
                }
                tableData.push(row);
            });

            // Créer le tableau avec autoTable
            doc.autoTable({
                startY: 45,
                head: [tableData[0], tableData[1]],
                body: tableData.slice(2),
                styles: {
                    fontSize: 6,
                    cellPadding: 1,
                },
                headStyles: {
                    fillColor: [26, 37, 47],
                    textColor: 255,
                    fontSize: 7,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 20, fontStyle: 'bold' }
                },
                margin: { left: margin, right: margin }
            });

            return doc.output('blob');
        }

        // Initialisation de l'application
        window.initializeApp = function() {
            if (!window.firebaseReady || !window.emailjsReady) {
                setTimeout(window.initializeApp, 100);
                return;
            }

            // Écouter les changements d'authentification
            const { onAuthStateChanged } = window.authSDK;
            onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    currentUser = user;
                    userRole = determineUserRole(user.email);
                    
                    // Vérifier si l'utilisateur doit changer son mot de passe
                    await checkPasswordChangeRequired(user.email);
                    
                    // Masquer la modal de login
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Si changement de mot de passe requis, forcer l'ouverture de la modal
                    if (mustChangePassword) {
                        openPasswordModal();
                        alert('⚠️ Première connexion détectée !\nVous devez changer votre mot de passe temporaire.');
                    }
                    
                    // Initialiser l'application
                    populateSelectors();
                    loadEmployees();
                    loadSchedulesFromFirebase();
                    updateScheduleDisplay();
                    updateVersionInfo();
                    
                } else {
                    // Afficher la modal de login
                    document.getElementById('loginModal').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    currentUser = null;
                    userRole = null;
                    mustChangePassword = false;
                }
            });
        };

        // Fonction pour calculer le numéro de semaine ISO 8601
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getWeekDates(year, week) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const firstMondayOfYear = new Date(jan4);
            firstMondayOfYear.setDate(jan4.getDate() - jan4Day + 1);
            const mondayOfWeek = new Date(firstMondayOfYear);
            mondayOfWeek.setDate(firstMondayOfYear.getDate() + (week - 1) * 7);
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(mondayOfWeek);
                date.setDate(mondayOfWeek.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        // Firebase functions avec vérification de permissions
        async function saveSchedulesToFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK || userRole !== 'admin') {
                return false;
            }

            try {
                const { doc, setDoc } = window.firestoreSDK;
                
                // Sauvegarder les employés
                await setDoc(doc(window.firestore, 'planning-data', 'employees'), {
                    employees: employees,
                    lastUpdated: new Date().toISOString()
                });

                // Sauvegarder les plannings
                for (const [key, schedule] of Object.entries(schedules)) {
                    await setDoc(doc(window.firestore, 'planning-data', `schedule-${key}`), {
                        schedule: schedule,
                        lastUpdated: new Date().toISOString()
                    });
                }

                // Sauvegarder les fermetures
                for (const [key, closure] of Object.entries(closures)) {
                    await setDoc(doc(window.firestore, 'planning-data', `closure-${key}`), {
                        closure: closure,
                        lastUpdated: new Date().toISOString()
                    });
                }

                // Marquer comme modifié
                markPlanningAsModified();

                console.log('Données sauvegardées sur Firebase');
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                return false;
            }
        }

        async function loadSchedulesFromFirebase() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                loadEmployees();
                return;
            }

            try {
                const { doc, getDoc, collection, getDocs } = window.firestoreSDK;
                
                // Charger les employés
                const employeesDoc = await getDoc(doc(window.firestore, 'planning-data', 'employees'));
                if (employeesDoc.exists()) {
                    employees = employeesDoc.data().employees || employees;
                }

                // Charger tous les documents
                const planningCollection = collection(window.firestore, 'planning-data');
                const snapshot = await getDocs(planningCollection);
                
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id;
                    
                    if (docId.startsWith('schedule-')) {
                        const key = docId.replace('schedule-', '');
                        schedules[key] = data.schedule;
                    } else if (docId.startsWith('closure-')) {
                        const key = docId.replace('closure-', '');
                        closures[key] = data.closure;
                    } else if (docId.startsWith('validated-')) {
                        const key = docId.replace('validated-', '');
                        if (key === `${currentYear}-${currentWeek}`) {
                            planningValidated = data.validated || false;
                            currentVersion = data.version || currentVersion;
                        }
                    }
                });

                console.log('Données chargées depuis Firebase');
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Erreur chargement Firebase:', error);
                loadEmployees();
            }
        }

        function setupRealtimeListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;

            // Nettoyer les anciens listeners
            Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
            activeListeners = {};

            // Écouter les changements des employés
            activeListeners.employees = onSnapshot(
                doc(window.firestore, 'planning-data', 'employees'),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newEmployees = docSnapshot.data().employees;
                        if (JSON.stringify(newEmployees) !== JSON.stringify(employees)) {
                            isUpdatingFromFirebase = true;
                            employees = newEmployees;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log('🔄 Employés mis à jour depuis Firebase');
                        }
                    }
                },
                (error) => console.error('Erreur listener employés:', error)
            );

            // Écouter les changements de la semaine courante
            setupCurrentWeekListeners();
        }

        function setupCurrentWeekListeners() {
            if (!window.firebaseReady || !window.firestoreSDK) {
                return;
            }

            const { doc, onSnapshot } = window.firestoreSDK;
            const currentKey = `${currentYear}-${currentWeek}`;

            // Nettoyer les listeners de la semaine précédente
            if (activeListeners.currentSchedule) {
                activeListeners.currentSchedule();
                delete activeListeners.currentSchedule;
            }
            if (activeListeners.currentClosure) {
                activeListeners.currentClosure();
                delete activeListeners.currentClosure;
            }
            if (activeListeners.currentValidated) {
                activeListeners.currentValidated();
                delete activeListeners.currentValidated;
            }

            // Écouter les changements du planning de la semaine courante
            activeListeners.currentSchedule = onSnapshot(
                doc(window.firestore, 'planning-data', `schedule-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newSchedule = docSnapshot.data().schedule;
                        if (JSON.stringify(newSchedule) !== JSON.stringify(schedules[currentKey])) {
                            isUpdatingFromFirebase = true;
                            schedules[currentKey] = newSchedule;
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🔄 Planning semaine ${currentKey} mis à jour depuis Firebase`);
                        }
                    } else {
                        if (schedules[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete schedules[currentKey];
                            updateScheduleDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🗑️ Planning semaine ${currentKey} supprimé`);
                        }
                    }
                },
                (error) => console.error('Erreur listener planning:', error)
            );

            // Écouter les changements des fermetures de la semaine courante
            activeListeners.currentClosure = onSnapshot(
                doc(window.firestore, 'planning-data', `closure-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const newClosure = docSnapshot.data().closure;
                        if (JSON.stringify(newClosure) !== JSON.stringify(closures[currentKey])) {
                            isUpdatingFromFirebase = true;
                            closures[currentKey] = newClosure;
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🔄 Fermetures semaine ${currentKey} mises à jour depuis Firebase`);
                        }
                    } else {
                        if (closures[currentKey]) {
                            isUpdatingFromFirebase = true;
                            delete closures[currentKey];
                            updateClosureDisplay();
                            isUpdatingFromFirebase = false;
                            console.log(`🗑️ Fermetures semaine ${currentKey} supprimées`);
                        }
                    }
                },
                (error) => console.error('Erreur listener fermetures:', error)
            );

            // Écouter les changements de validation
            activeListeners.currentValidated = onSnapshot(
                doc(window.firestore, 'planning-data', `validated-${currentKey}`),
                (docSnapshot) => {
                    if (isUpdatingFromFirebase) return;
                    
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        planningValidated = data.validated || false;
                        currentVersion = data.version || currentVersion;
                        updateUIForRole();
                        updateVersionInfo();
                        console.log(`🔄 Validation semaine ${currentKey} mise à jour`);
                    }
                },
                (error) => console.error('Erreur listener validation:', error)
            );
        }

        function populateSelectors() {
            const weekSelect = document.getElementById('weekSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            weekSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                weekSelect.appendChild(option);
            }
            
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            weekSelect.addEventListener('change', (e) => {
                currentWeek = parseInt(e.target.value);
                updateScheduleDisplay();
            });
            
            yearSelect.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                updateScheduleDisplay();
            });
        }

        function loadEmployees() {
            if (employees.length !== 5) {
                employees = [
                    { firstName: 'Antoine', lastName: '', email: '' },
                    { firstName: 'Léa', lastName: '', email: '' },
                    { firstName: 'Noémie', lastName: '', email: '' },
                    { firstName: 'Christelle', lastName: '', email: '' },
                    { firstName: 'Admin', lastName: 'LATILLE', email: 'latilledistribution@gmail.com' }
                ];
            }
        }

        function changeWeek(direction) {
            const newWeek = currentWeek + direction;
            
            if (newWeek >= 1 && newWeek <= 53) {
                currentWeek = newWeek;
                document.getElementById('weekSelect').value = currentWeek;
                updateScheduleDisplay();
            } else if (newWeek === 0) {
                if (currentYear > 2024) {
                    currentYear--;
                    currentWeek = 53;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            } else if (newWeek === 54) {
                if (currentYear < 2030) {
                    currentYear++;
                    currentWeek = 1;
                    document.getElementById('yearSelect').value = currentYear;
                    document.getElementById('weekSelect').value = currentWeek;
                    updateScheduleDisplay();
                }
            }
        }

        function updateScheduleDisplay() {
            const dates = getWeekDates(currentYear, currentWeek);
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Update dates in headers
            days.forEach((day, index) => {
                document.getElementById(`${day}-date`).textContent = formatDate(dates[index]);
            });
            
            // Update employee names in each day
            days.forEach(day => {
                const container = document.getElementById(`${day}-employees`);
                container.innerHTML = '';
                employees.forEach(employee => {
                    const label = document.createElement('div');
                    label.className = 'employee-label';
                    label.textContent = employee.firstName || 'Employé';
                    container.appendChild(label);
                });
            });
            
            generateTimeSlots();
            updateSummary();
            updateClosureDisplay();
            updateUIForRole();
            updateVersionInfo();
            
            // Mettre à jour les listeners pour la nouvelle semaine (seulement si pas de mise à jour Firebase en cours)
            if (!isUpdatingFromFirebase) {
                setupCurrentWeekListeners();
            }
        }

        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            timeSlots.forEach((slot, slotIndex) => {
                const row = document.createElement('div');
                row.className = 'time-row';
                
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                timeCell.textContent = `${slot.start}-${slot.end}`;
                row.appendChild(timeCell);
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, dayIndex) => {
                    const scheduleCell = document.createElement('div');
                    scheduleCell.className = 'schedule-cell';
                    
                    employees.forEach((employee, empIndex) => {
                        const timeSlotDiv = document.createElement('div');
                        timeSlotDiv.className = 'time-slot';
                        timeSlotDiv.dataset.day = dayIndex;
                        timeSlotDiv.dataset.slot = slotIndex;
                        timeSlotDiv.dataset.employee = empIndex;
                        
                        const defaultClass = getDefaultClass(slot.start, dayIndex);
                        if (defaultClass) {
                            timeSlotDiv.classList.add(defaultClass);
                        }
                        
                        const scheduleKey = `${currentYear}-${currentWeek}`;
                        if (schedules[scheduleKey] && schedules[scheduleKey][dayIndex] && schedules[scheduleKey][dayIndex][slotIndex] && schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            timeSlotDiv.className = 'time-slot employee-' + (empIndex + 1);
                        }
                        
                        if (userRole === 'admin') {
                            timeSlotDiv.addEventListener('click', (e) => {
                                toggleTimeSlot(timeSlotDiv, dayIndex, slotIndex, empIndex);
                            });
                        }
                        
                        scheduleCell.appendChild(timeSlotDiv);
                    });
                    
                    row.appendChild(scheduleCell);
                });
                
                container.appendChild(row);
            });
        }

        function toggleTimeSlot(element, dayIndex, slotIndex, empIndex) {
            if (userRole !== 'admin') return;
            
            const scheduleKey = `${currentYear}-${currentWeek}`;
            if (!schedules[scheduleKey]) schedules[scheduleKey] = {};
            if (!schedules[scheduleKey][dayIndex]) schedules[scheduleKey][dayIndex] = {};
            if (!schedules[scheduleKey][dayIndex][slotIndex]) schedules[scheduleKey][dayIndex][slotIndex] = {};
            
            const isActive = schedules[scheduleKey][dayIndex][slotIndex][empIndex];
            schedules[scheduleKey][dayIndex][slotIndex][empIndex] = !isActive;
            
            if (schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                element.className = 'time-slot employee-' + (empIndex + 1);
            } else {
                element.className = 'time-slot';
                const defaultClass = getDefaultClass(timeSlots[slotIndex].start, dayIndex);
                if (defaultClass) {
                    element.classList.add(defaultClass);
                }
            }
            
            updateSummary();
            saveSchedulesToFirebase();
        }

        function getDefaultClass(timeStart, dayIndex) {
            if (defaultGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            if (dayIndex === 6 && sundayGraySlots.includes(timeStart)) {
                return 'default-gray';
            }
            if (defaultGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            if (dayIndex < 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-green';
            }
            if (dayIndex === 6 && weekdayGreenSlots.includes(timeStart)) {
                return 'default-gray';
            }
            return null;
        }

        function updateSummary() {
            const scheduleKey = `${currentYear}-${currentWeek}`;
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const employeeTotals = [0, 0, 0, 0, 0];
            const dailyTotals = [0, 0, 0, 0, 0, 0, 0];
            
            employees.forEach((employee, empIndex) => {
                let totalMinutes = 0;
                
                days.forEach((day, dayIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            totalMinutes += slot.duration;
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    dailyTotals[dayIndex] += dailyMinutes;
                });
                
                employeeTotals[empIndex] = totalMinutes;
                
                const card = document.createElement('div');
                card.className = 'employee-summary';
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hoursDisplay = `${hours}h${minutes.toString().padStart(2, '0')}`;
                
                const remaining = (35 * 60) - totalMinutes;
                const remainingHours = Math.floor(Math.abs(remaining) / 60);
                const remainingMinutes = Math.abs(remaining) % 60;
                const remainingDisplay = `${remaining < 0 ? '-' : ''}${remainingHours}h${remainingMinutes.toString().padStart(2, '0')}`;
                
                if (totalMinutes === 0) {
                    card.classList.add('hours-zero');
                } else if (totalMinutes === 35 * 60) {
                    card.classList.add('hours-complete');
                } else {
                    card.classList.add('hours-partial');
                }
                
                card.innerHTML = `
                    <div class="employee-name">${employee.firstName || 'Employé'}</div>
                    <div class="hours-total">${hoursDisplay} hebdo</div>
                    <div class="hours-remaining ${remaining < 0 ? 'hours-negative' : ''}">(reste ${remainingDisplay} à répartir)</div>
                `;
                summaryGrid.appendChild(card);
            });
            
            // Update daily totals
            days.forEach((day, dayIndex) => {
                const container = document.getElementById(`${day}-totals`);
                container.innerHTML = '';
                
                const totalsDiv = document.createElement('div');
                totalsDiv.className = 'daily-employee-totals';
                
                employees.forEach((employee, empIndex) => {
                    let dailyMinutes = 0;
                    
                    timeSlots.forEach((slot, slotIndex) => {
                        if (schedules[scheduleKey] && 
                            schedules[scheduleKey][dayIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex] && 
                            schedules[scheduleKey][dayIndex][slotIndex][empIndex]) {
                            dailyMinutes += slot.duration;
                        }
                    });
                    
                    const hours = Math.floor(dailyMinutes / 60);
                    const minutes = dailyMinutes % 60;
                    const display = `${hours}h${minutes.toString().padStart(2, '0')}`;
                    
                    const empTotal = document.createElement('div');
                    empTotal.textContent = display;
                    totalsDiv.appendChild(empTotal);
                });
                
                container.appendChild(totalsDiv);
                
                const teamHours = Math.floor(dailyTotals[dayIndex] / 60);
                const teamMinutes = dailyTotals[dayIndex] % 60;
                const teamElement = document.getElementById(`${day}-team-total`);
                teamElement.textContent = `${teamHours}h${teamMinutes.toString().padStart(2, '0')}`;
                teamElement.style.fontSize = '10px';
            });
        }

        // Modal functions
        async function openEmployeeModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('employeeModal');
            const inputs = document.getElementById('employeeInputs');
            inputs.innerHTML = '';
            
            for (let index = 0; index < employees.length; index++) {
                const employee = employees[index];
                const group = document.createElement('div');
                group.className = 'employee-form-group';
                
                const isAdmin = index === 4;
                
                // Vérifier le statut du compte
                let accountStatus = '';
                if (!isAdmin && employee.email) {
                    try {
                        const { doc, getDoc } = window.firestoreSDK;
                        const userSettingsDoc = await getDoc(doc(window.firestore, 'user-settings', employee.email));
                        
                        if (userSettingsDoc.exists()) {
                            const data = userSettingsDoc.data();
                            if (data.requirePasswordChange) {
                                accountStatus = '<span style="color: #ff9800;">⏳ Compte créé - MDP temporaire</span>';
                            } else {
                                accountStatus = '<span style="color: #4caf50;">✅ Compte actif</span>';
                            }
                        } else {
                            accountStatus = '<span style="color: #6c757d;">➕ Pas de compte</span>';
                        }
                    } catch (error) {
                        accountStatus = '<span style="color: #6c757d;">❓ Statut inconnu</span>';
                    }
                }
                
                const inviteSection = (!isAdmin && employee.email) ? 
                    `<div class="invitation-section">
                        <span>Statut: Utilisateur | ${accountStatus}</span>
                        <button type="button" class="invite-btn" onclick="sendEmployeeInvitation(${index})">
                            📧 ${accountStatus.includes('Pas de compte') ? 'Créer compte' : 'Renvoyer invitation'}
                        </button>
                    </div>` : '';
                
                group.innerHTML = `
                    <div class="form-row">
                        <div class="employee-title">${isAdmin ? 'Admin' : 'Employé'} ${index + 1}</div>
                        <input type="text" class="employee-input" value="${employee.firstName}" 
                               placeholder="Prénom" id="employee-firstName-${index}" 
                               ${isAdmin ? 'readonly' : ''} oninput="formatFirstName(this)">
                        <input type="text" class="employee-input" value="${employee.lastName}" 
                               placeholder="Nom" id="employee-lastName-${index}" 
                               ${isAdmin ? 'readonly' : ''} oninput="formatLastName(this)">
                        <input type="email" class="employee-input" value="${employee.email}" 
                               placeholder="Email" id="employee-email-${index}" 
                               ${isAdmin ? 'readonly' : ''} oninput="formatEmail(this)">
                        ${!isAdmin ? `<button type="button" class="clear-employee-btn" onclick="clearEmployee(${index})">✗</button>` : ''}
                    </div>
                    ${inviteSection}
                `;
                
                inputs.appendChild(group);
            }
            
            modal.style.display = 'block';
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        function clearEmployee(index) {
            if (confirm(`Effacer toutes les données de l'employé ${index + 1} ?`)) {
                document.getElementById(`employee-firstName-${index}`).value = '';
                document.getElementById(`employee-lastName-${index}`).value = '';
                document.getElementById(`employee-email-${index}`).value = '';
            }
        }

        // Fonctions de formatage automatique
        function formatFirstName(input) {
            let value = input.value;
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                input.value = value;
            }
        }

        function formatLastName(input) {
            input.value = input.value.toUpperCase();
        }

        function formatEmail(input) {
            input.value = input.value.toLowerCase();
        }

        function saveEmployees() {
            if (userRole !== 'admin') return;
            
            const newEmployees = [];
            for (let i = 0; i < 5; i++) {
                if (i === 4) {
                    // Administrateur - ne pas modifier
                    newEmployees.push(employees[4]);
                } else {
                    const firstName = document.getElementById(`employee-firstName-${i}`).value || '';
                    const lastName = document.getElementById(`employee-lastName-${i}`).value || '';
                    const email = document.getElementById(`employee-email-${i}`).value || '';
                    
                    newEmployees.push({
                        firstName: firstName,
                        lastName: lastName,
                        email: email
                    });
                }
            }
            
            employees = newEmployees;
            updateScheduleDisplay();
            closeEmployeeModal();
            
            saveSchedulesToFirebase().then(success => {
                if (success) {
                    alert('Informations des employés sauvegardées !');
                } else {
                    alert('Erreur lors de la sauvegarde');
                }
            });
        }

        // Fonctions pour la duplication de planning
        function openDuplicateModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('duplicateModal');
            populateDuplicateSelectors();
            updateDuplicateInfo();
            modal.style.display = 'block';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
        }

        function populateDuplicateSelectors() {
            const sourceWeek = document.getElementById('sourceWeek');
            const sourceYear = document.getElementById('sourceYear');
            const destWeek = document.getElementById('destWeek');
            const destYear = document.getElementById('destYear');
            
            // Vider les sélecteurs
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.innerHTML = '';
            });
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) sourceOption.selected = true;
                sourceWeek.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = `Semaine ${i}`;
                if (i === currentWeek) destOption.selected = true;
                destWeek.appendChild(destOption);
            }
            
            // Remplir les années
            for (let i = 2024; i <= 2030; i++) {
                const sourceOption = document.createElement('option');
                sourceOption.value = i;
                sourceOption.textContent = i;
                if (i === currentYear) sourceOption.selected = true;
                sourceYear.appendChild(sourceOption);
                
                const destOption = document.createElement('option');
                destOption.value = i;
                destOption.textContent = i;
                if (i === currentYear) destOption.selected = true;
                destYear.appendChild(destOption);
            }
            
            // Ajouter les événements de changement
            [sourceWeek, sourceYear, destWeek, destYear].forEach(select => {
                select.addEventListener('change', updateDuplicateInfo);
            });
        }

        function updateDuplicateInfo() {
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            const infoDiv = document.getElementById('duplicateInfo');
            
            let message = '';
            let isValid = true;
            
            // Vérifier si même semaine
            if (sourceWeek === destWeek && sourceYear === destYear) {
                message = '❌ La semaine source et destination ne peuvent pas être identiques.';
                isValid = false;
            } else {
                // Vérifier si la source a des données
                const sourceKey = `${sourceYear}-${sourceWeek}`;
                const hasSourceData = schedules[sourceKey] && Object.keys(schedules[sourceKey]).length > 0;
                const hasSourceClosures = closures[sourceKey] && Object.keys(closures[sourceKey]).length > 0;
                
                if (!hasSourceData && !hasSourceClosures) {
                    message = '⚠️ La semaine source ne contient aucun planning.';
                    isValid = false;
                } else {
                    // Vérifier si destination a des données
                    const destKey = `${destYear}-${destWeek}`;
                    const hasDestData = schedules[destKey] && Object.keys(schedules[destKey]).length > 0;
                    const hasDestClosures = closures[destKey] && Object.keys(closures[destKey]).length > 0;
                    
                    if (hasDestData || hasDestClosures) {
                        message = '⚠️ La semaine destination contient déjà un planning qui sera écrasé.';
                    } else {
                        message = '✅ Prêt à dupliquer le planning.';
                    }
                }
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? (message.includes('écrasé') ? '#ff9800' : '#4caf50') : '#f44336';
            
            // Activer/désactiver le bouton
            const duplicateBtn = document.querySelector('#duplicateModal .btn-save');
            duplicateBtn.disabled = !isValid;
            duplicateBtn.style.opacity = isValid ? '1' : '0.5';
            duplicateBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function duplicatePlanning() {
            if (userRole !== 'admin') return;
            
            const sourceWeek = parseInt(document.getElementById('sourceWeek').value);
            const sourceYear = parseInt(document.getElementById('sourceYear').value);
            const destWeek = parseInt(document.getElementById('destWeek').value);
            const destYear = parseInt(document.getElementById('destYear').value);
            
            const sourceKey = `${sourceYear}-${sourceWeek}`;
            const destKey = `${destYear}-${destWeek}`;
            
            try {
                // Copier les plannings localement
                if (schedules[sourceKey]) {
                    schedules[destKey] = JSON.parse(JSON.stringify(schedules[sourceKey]));
                } else {
                    delete schedules[destKey];
                }
                
                // Copier les fermetures localement
                if (closures[sourceKey]) {
                    closures[destKey] = JSON.parse(JSON.stringify(closures[sourceKey]));
                } else {
                    delete closures[destKey];
                }
                
                // Sauvegarder sur Firebase
                await saveSchedulesToFirebase();
                
                // Basculer vers la semaine dupliquée
                currentWeek = destWeek;
                currentYear = destYear;
                document.getElementById('weekSelect').value = currentWeek;
                document.getElementById('yearSelect').value = currentYear;
                
                // Fermer la modal
                closeDuplicateModal();
                
                // Forcer la mise à jour de l'affichage
                setTimeout(() => {
                    updateScheduleDisplay();
                }, 100);
                
                alert(`Planning dupliqué avec succès vers la semaine ${destWeek}/${destYear} !`);
                
            } catch (error) {
                console.error('Erreur lors de la duplication:', error);
                alert('Erreur lors de la duplication.');
            }
        }

        // Fonctions pour la réinitialisation de planning
        function openResetModal() {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('resetModal');
            populateResetSelectors();
            updateResetInfo();
            modal.style.display = 'block';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function populateResetSelectors() {
            const resetWeek = document.getElementById('resetWeek');
            const resetYear = document.getElementById('resetYear');
            
            // Vider les sélecteurs
            resetWeek.innerHTML = '';
            resetYear.innerHTML = '';
            
            // Remplir les semaines (1-53)
            for (let i = 1; i <= 53; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semaine ${i}`;
                if (i === currentWeek) option.selected = true;
                resetWeek.appendChild(option);
            }
            
            // Remplir les années
            for (let i = 2024; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                resetYear.appendChild(option);
            }
            
            // Ajouter les événements de changement
            resetWeek.addEventListener('change', updateResetInfo);
            resetYear.addEventListener('change', updateResetInfo);
        }

        function updateResetInfo() {
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            const infoDiv = document.getElementById('resetInfo');
            
            let message = '';
            let isValid = true;
            
            // Vérifier si la semaine a des données
            const resetKey = `${resetYear}-${resetWeek}`;
            const hasData = schedules[resetKey] && Object.keys(schedules[resetKey]).length > 0;
            const hasClosures = closures[resetKey] && Object.keys(closures[resetKey]).length > 0;
            
            if (!hasData && !hasClosures) {
                message = '⚠️ Cette semaine ne contient aucun planning à réinitialiser.';
                isValid = false;
            } else {
                message = `✅ Prêt à réinitialiser la semaine ${resetWeek}/${resetYear}.`;
            }
            
            infoDiv.innerHTML = message;
            infoDiv.style.color = isValid ? '#4caf50' : '#f44336';
            
            // Activer/désactiver le bouton
            const resetBtn = document.querySelector('#resetModal .btn');
            resetBtn.disabled = !isValid;
            resetBtn.style.opacity = isValid ? '1' : '0.5';
            resetBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
        }

        async function resetPlanning() {
            if (userRole !== 'admin') return;
            
            const resetWeek = parseInt(document.getElementById('resetWeek').value);
            const resetYear = parseInt(document.getElementById('resetYear').value);
            
            if (!confirm(`Êtes-vous absolument sûr de vouloir réinitialiser la semaine ${resetWeek}/${resetYear} ?\n\nCette action supprimera définitivement :\n- Tous les plannings des employés\n- Tous les états de fermeture\n\nCette action est IRRÉVERSIBLE.`)) {
                return;
            }
            
            const resetKey = `${resetYear}-${resetWeek}`;
            
            try {
                // Supprimer les données localement
                delete schedules[resetKey];
                delete closures[resetKey];
                
                // Sauvegarder sur Firebase
                await saveSchedulesToFirebase();
                
                // Fermer la modal
                closeResetModal();
                
                // Si c'est la semaine actuellement affichée, forcer la mise à jour
                if (resetWeek === currentWeek && resetYear === currentYear) {
                    setTimeout(() => {
                        updateScheduleDisplay();
                    }, 100);
                }
                
                alert(`Semaine ${resetWeek}/${resetYear} réinitialisée avec succès !`);
                
            } catch (error) {
                console.error('Erreur lors de la réinitialisation:', error);
                alert('Erreur lors de la réinitialisation.');
            }
        }

        // Autres fonctions
        function openPrintableVersion() {
            generatePlanningPDF(`${currentYear}-${currentWeek}`).then(blob => {
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            });
        }

        function sendByEmail() {
            const subject = `Planning Semaine ${currentWeek} - ${currentYear}`;
            const body = `Planning de la semaine ${currentWeek} de l'année ${currentYear}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        function toggleDayClosure(dayIndex) {
            if (userRole !== 'admin') return;
            
            const closureKey = `${currentYear}-${currentWeek}`;
            if (!closures[closureKey]) closures[closureKey] = {};
            
            // États: 'open' -> 'closed' -> 'am-closed' -> 'pm-closed' -> 'open'
            const currentState = closures[closureKey][dayIndex] || 'open';
            let nextState;
            
            switch(currentState) {
                case 'open':
                    nextState = 'closed';
                    break;
                case 'closed':
                    nextState = 'am-closed';
                    break;
                case 'am-closed':
                    nextState = 'pm-closed';
                    break;
                case 'pm-closed':
                    nextState = 'open';
                    break;
                default:
                    nextState = 'open';
            }
            
            closures[closureKey][dayIndex] = nextState;
            updateClosureDisplay();
            saveSchedulesToFirebase();
        }

        function updateClosureDisplay() {
            const closureKey = `${currentYear}-${currentWeek}`;
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((day, dayIndex) => {
                const toggle = document.querySelector(`[data-day="${dayIndex}"]`);
                if (!toggle) return;
                
                const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
                
                // Mettre à jour l'apparence du bouton
                toggle.className = `day-toggle ${state}`;
                
                switch(state) {
                    case 'open':
                        toggle.textContent = '✓';
                        toggle.title = `Ouvrir/Fermer ${getDayName(dayIndex)}`;
                        break;
                    case 'closed':
                        toggle.textContent = '✗';
                        toggle.title = `${getDayName(dayIndex)} - Fermé toute la journée`;
                        break;
                    case 'am-closed':
                        toggle.textContent = 'AM';
                        toggle.title = `${getDayName(dayIndex)} - Fermé le matin`;
                        break;
                    case 'pm-closed':
                        toggle.textContent = 'PM';
                        toggle.title = `${getDayName(dayIndex)} - Fermé l'après-midi`;
                        break;
                }
                
                // Appliquer les effets visuels sur les lignes
                updateRowsVisual(dayIndex, state);
            });
        }

        function updateRowsVisual(dayIndex, state) {
            // Supprimer les classes existantes
            document.querySelectorAll('.time-row').forEach(row => {
                const cells = row.querySelectorAll('.schedule-cell');
                if (cells[dayIndex]) {
                    cells[dayIndex].classList.remove('closed', 'establishment-closed');
                }
            });
            
            if (state === 'closed') {
                // Fermeture complète
                document.querySelectorAll('.time-row').forEach(row => {
                    const cells = row.querySelectorAll('.schedule-cell');
                    if (cells[dayIndex]) {
                        cells[dayIndex].classList.add('establishment-closed');
                    }
                });
            } else if (state === 'am-closed') {
                // Fermeture matin (07:00-13:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 7 && hour < 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            } else if (state === 'pm-closed') {
                // Fermeture après-midi (13:00-20:00)
                timeSlots.forEach((slot, slotIndex) => {
                    const hour = parseInt(slot.start.split(':')[0]);
                    if (hour >= 13) {
                        const row = document.querySelectorAll('.time-row')[slotIndex];
                        if (row) {
                            const cells = row.querySelectorAll('.schedule-cell');
                            if (cells[dayIndex]) {
                                cells[dayIndex].classList.add('establishment-closed');
                            }
                        }
                    }
                });
            }
        }

        function getDayName(dayIndex) {
            const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
            return days[dayIndex];
        }

        function isSlotClosed(dayIndex, slotIndex) {
            const closureKey = `${currentYear}-${currentWeek}`;
            const state = closures[closureKey] ? closures[closureKey][dayIndex] || 'open' : 'open';
            
            if (state === 'closed') return true;
            if (state === 'open') return false;
            
            const hour = parseInt(timeSlots[slotIndex].start.split(':')[0]);
            if (state === 'am-closed' && hour >= 7 && hour < 13) return true;
            if (state === 'pm-closed' && hour >= 13) return true;
            
            return false;
        }

        function toggleDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.toggle('show');
        }

        function closeDropdown() {
            const dropdown = document.querySelector('.dropdown');
            dropdown.classList.remove('show');
        }

        // Click outside modal to close
        window.addEventListener('click', (event) => {
            const employeeModal = document.getElementById('employeeModal');
            const passwordModal = document.getElementById('passwordModal');
            
            if (event.target === employeeModal) {
                closeEmployeeModal();
            }
            if (event.target === passwordModal && !mustChangePassword) {
                closePasswordModal();
            }
        });

        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Gestion des touches Enter pour la connexion
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (document.getElementById('loginModal').style.display !== 'none') {
                    login();
                } else if (document.getElementById('passwordModal').style.display === 'block') {
                    changePassword();
                }
            }
        });
    </script>
</body>
</html>
